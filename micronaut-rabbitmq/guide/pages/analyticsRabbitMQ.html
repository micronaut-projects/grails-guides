<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>4.3 Analytics Microservice null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        RabbitMQ and Micronaut - Event driven applications
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/rabbitmq.html"><strong>4</strong><span>RabbitMQ and Micronaut</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/nextSteps.html"><strong>5</strong><span>Next Steps</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/runningTheApp.html">&lt;&lt; <strong>3</strong><span>Running the app</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/nextSteps.html"><strong>5</strong><span>Next Steps</span> >></a></div>
                


                <div class="project">
                    <h1>4.3 Analytics Microservice</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="analyticsRabbitMQ">4.3 Analytics Microservice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-microservices-rabbitmq/edit/master/src/main/docs/guide/rabbitmq/analyticsRabbitMQ.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>rabbitmq</code> dependency.</p>
</div>
<div class="listingblock">
<div class="title">analytics/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
    ...
    ..
    .
    compile 'io.micronaut.configuration:micronaut-rabbitmq:1.1.0.M1'
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_create_rabbitmq_exchange_queue_and_binding">Create RabbitMQ exchange, queue and binding</h3>
<div class="paragraph">
<p>As we already did in Books Microservice, let&#8217;s create the class <code>ChannelPoolListener.java</code> to define the exchange, queue
and binding:</p>
</div>
<div class="listingblock">
<div class="title">analytics/src/main/java/example/micronaut/analytics/ChannelPoolListener.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.analytics;

import com.rabbitmq.client.BuiltinExchangeType;
import com.rabbitmq.client.Channel;
import io.micronaut.configuration.rabbitmq.connect.ChannelPool;
import io.micronaut.context.event.BeanCreatedEvent;
import io.micronaut.context.event.BeanCreatedEventListener;

import javax.inject.Singleton;
import java.io.IOException;

@Singleton
public class ChannelPoolListener implements BeanCreatedEventListener&lt;ChannelPool&gt; {

    @Override
    public ChannelPool onCreated(BeanCreatedEvent&lt;ChannelPool&gt; event) {
        ChannelPool pool = event.getBean();

        Channel channel = null;
        try {
            channel = pool.getChannel();
        } catch (IOException e) {
            // The channel couldn't be retrieved
        }

        if (channel != null) {
            try {
                channel.exchangeDeclare("micronaut", BuiltinExchangeType.DIRECT, true);

                channel.queueDeclare("analytics", true, false, false, null);
                channel.queueBind("analytics", "micronaut", "analytics");
            } catch (IOException e) {
                // no-op
            } finally {
                pool.returnChannel(channel);
            }
        }

        return pool;
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Instead of copy-paste the class in every project it would be better to create a new Gradle (or Maven) module and
share it among all the microservices.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_rabbitmq_consumer">Create RabbitMQ consumer</h3>
<div class="paragraph">
<p>Create a new class to act as a consumer of the messages sent to RabbitMQ by the Books Microservice. Micronaut will
implement the consume at compile time. Create <code>AnalyticsListener.java</code></p>
</div>
<div class="listingblock">
<div class="title">analytics/src/main/java/example/micronaut/analytics/AnalyticsListener.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.analytics;

import io.micronaut.configuration.rabbitmq.annotation.Queue;
import io.micronaut.configuration.rabbitmq.annotation.RabbitListener;
import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;

@Requires(notEnv = Environment.TEST) <i class="conum" data-value="1"></i><b>(1)</b>
@RabbitListener <i class="conum" data-value="2"></i><b>(2)</b>
public class AnalyticsListener {

    private final AnalyticsService analyticsService; <i class="conum" data-value="3"></i><b>(3)</b>

    public AnalyticsListener(AnalyticsService analyticsService) { <i class="conum" data-value="3"></i><b>(3)</b>
        this.analyticsService = analyticsService;
    }

    @Queue("analytics") <i class="conum" data-value="4"></i><b>(4)</b>
    public void updateAnalytics(Book book) {
        analyticsService.updateBookAnalytics(book); <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The RabbitMQ listener will not be available for tests.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the class with <code>@RabbitListener</code> to indicate that this bean will consume messages from RabbitMQ.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Constructor injection for <code>AnalyticsService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Annotate the method with <code>@Queue</code>. This listener will listen to messages in <code>analytics</code> queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Call the previously created method to update the analytics for the book.</td>
</tr>
</table>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/runningTheApp.html">&lt;&lt; <strong>3</strong><span>Running the app</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/nextSteps.html"><strong>5</strong><span>Next Steps</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
