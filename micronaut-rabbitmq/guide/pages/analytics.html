<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2.2 Analytics Microservice null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        RabbitMQ and Micronaut - Event driven applications
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/rabbitmq.html"><strong>4</strong><span>RabbitMQ and Micronaut</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/nextSteps.html"><strong>5</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/graal.html"><strong>6</strong><span>Generate a Micronaut app's Native Image with GraalVM</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/help.html"><strong>7</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the app</span> >></a></div>
                


                <div class="project">
                    <h1>2.2 Analytics Microservice</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="analytics">2.2 Analytics Microservice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-rabbitmq/edit/master/src/main/docs/guide/writingTheApp/analytics.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the <code>analytics</code> microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.analytics.analytics</code></p>
</div>
<div class="paragraph">
<p>To keep this guide simple there is no database persistence and the books analytics is kept in memory in <code>AnalyticsService.java</code></p>
</div>
<div class="listingblock">
<div class="title">analytics/src/main/java/example/micronaut/analytics/AnalyticsService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.analytics;

import javax.inject.Singleton;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

@Singleton
public class AnalyticsService {

    private final Map&lt;Book, Long&gt; bookAnalytics = new ConcurrentHashMap&lt;&gt;(); <i class="conum" data-value="1"></i><b>(1)</b>

    public void updateBookAnalytics(Book book) { <i class="conum" data-value="2"></i><b>(2)</b>
        bookAnalytics.compute(book, (b, v) -&gt; {
            if (v == null) {
                return 1L;
            } else {
                return v + 1;
            }
        });
    }

    public List&lt;BookAnalytics&gt; listAnalytics() { <i class="conum" data-value="3"></i><b>(3)</b>
        return bookAnalytics
                .entrySet()
                .stream()
                .map(e -&gt; new BookAnalytics(e.getKey().getIsbn(), e.getValue()))
                .collect(Collectors.toList());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Keep the books analytics in memory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize and update the analytics for the book passed as parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Return all the analytics.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous service responds a <code>List&lt;BookAnalytics&gt;</code>. Create the <code>BookAnalytics</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">analytics/src/main/java/example/micronaut/analytics/BookAnalytics.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.analytics;

import io.micronaut.core.annotation.Introspected;

@Introspected
public class BookAnalytics {

    private String bookIsbn;
    private Long count;

    public BookAnalytics() {
    }

    public BookAnalytics(String bookIsbn, Long count) {
        this.bookIsbn = bookIsbn;
        this.count = count;
    }

    public String getBookIsbn() {
        return bookIsbn;
    }

    public void setBookIsbn(String bookIsbn) {
        this.bookIsbn = bookIsbn;
    }

    public Long getCount() {
        return count;
    }

    public void setCount(Long count) {
        this.count = count;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">analytics/src/test/java/example/micronaut/analytics/AnalyticsServiceTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.analytics;

import static org.junit.jupiter.api.Assertions.assertEquals;

import io.micronaut.test.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import javax.inject.Inject;
import java.util.List;

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
public class AnalyticsServiceTest {

    @Inject <i class="conum" data-value="2"></i><b>(2)</b>
    AnalyticsService analyticsService;

    @Test
    void testUpdateBookAnalyticsAndGetAnalytics() {
        Book b1 = new Book("1491950358", "Building Microservices");
        Book b2 = new Book("1680502395", "Release It!");

        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b1);
        analyticsService.updateBookAnalytics(b2);

        List&lt;BookAnalytics&gt; analytics = analyticsService.listAnalytics();
        assertEquals(2, analytics.size());

        assertEquals(3, findBookAnalytics(b1, analytics).getCount().intValue());
        assertEquals(1, findBookAnalytics(b2, analytics).getCount().intValue());
    }

    private BookAnalytics findBookAnalytics(Book b, List&lt;BookAnalytics&gt; analytics) {
        return analytics
                .stream()
                .filter(bookAnalytics -&gt; bookAnalytics.getBookIsbn().equals(b.getIsbn()))
                .findFirst()
                .orElseThrow(() -&gt; new RuntimeException("Book not found"));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Starting with Micronaut 1.1.0 <code>micronaut-test-junit5</code> is added automatically to <code>build.gradle</code> (or <code>pom.xml</code>) when
creating an application with the CLI. For more information take a look <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html">at the documentation</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Just inject the collaborator and <code>@MicronautTest</code> will take care of everything.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a Controller to expose the analytics:</p>
</div>
<div class="listingblock">
<div class="title">analytics/src/main/java/example/micronaut/analytics/AnalyticsController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.analytics;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;

import java.util.List;

@Controller("/analytics")
public class AnalyticsController {

    private final AnalyticsService analyticsService;

    public AnalyticsController(AnalyticsService analyticsService) {
        this.analyticsService = analyticsService;
    }

    @Get("/") <i class="conum" data-value="1"></i><b>(1)</b>
    public List&lt;BookAnalytics&gt; listAnalytics() {
        return analyticsService.listAnalytics();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Just expose the analytics.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The application doesn&#8217;t expose the method <code>updateBookAnalytics</code> created in <code>AnalyticsService</code>. This method will be invoked
when reading messages from RabbitMQ.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">analytics $ ./gradlew test

&gt; Task :compileJava
Note: Creating bean classes for 4 type elements

&gt; Task :processResources
&gt; Task :classes

&gt; Task :compileTestJava
Note: Creating bean classes for 1 type elements

&gt; Task :processTestResources NO-SOURCE
&gt; Task :testClasses

&gt; Task :test

BUILD SUCCESSFUL in 10s
4 actionable tasks: 4 executed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally edit <code>application.yml</code> to run the application on a different port that <code>books</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">analytics/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">---
micronaut:
  server:
    port: 8081 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start the Micronaut microservice on port 8081.</td>
</tr>
</table>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/runningTheApp.html"><strong>3</strong><span>Running the app</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
