<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2.3 Recommendation Microservice null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        RabbitMQ RPC and Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/rabbitmq.html"><strong>3</strong><span>RabbitMQ and Micronaut</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/runningTheApp.html"><strong>4</strong><span>Running the app</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/graal.html"><strong>5</strong><span>Generate a Micronaut app's Native Image with GraalVM</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/nextSteps.html"><strong>6</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/help.html"><strong>7</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/rabbitmq.html"><strong>3</strong><span>RabbitMQ and Micronaut</span> >></a></div>
                


                <div class="project">
                    <h1>2.3 Recommendation Microservice</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="bookrecommendation">2.3 Recommendation Microservice</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-rabbitmq-rpc/edit/master/src/main/docs/guide/writingTheApp/bookrecommendation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the <code>bookrecommendation</code> microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.bookrecommendation.bookrecommendation</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a folder named <code>bookrecommendation</code> and a Micronaut app inside it with
default package: <code>example.micronaut.bookrecommendation</code>.</p>
</div>
<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>rabbitmq</code> dependency. In this microservice we will use Micronaut HTTP Server to receive
REST request so it is not necessary to remove any dependency.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
    ...
    ..
    .
    implementation("io.micronaut.rabbitmq:micronaut-rabbitmq")
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_create_rabbitmq_exchange_queue_and_binding">Create RabbitMQ exchange, queue and binding</h3>
<div class="paragraph">
<p>As we did in <code>Catalogue</code> Microservice, create the class <code>ChannelPoolListener.java</code> in <code>bookrecommendation/src/main/java/example/micronaut/bookcatalogue/ChannelPoolListener.java</code>
with the same content as before.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_clients">Create clients</h3>
<div class="paragraph">
<p>Let&#8217;s create two interfaces to send messages to RabbitMQ. Micronaut will implement the interfaces at compilation time.
Create <code>CatalogueClient.java</code>:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookinventory/CatalogueClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.bookrecommendation;

import io.micronaut.rabbitmq.annotation.Binding;
import io.micronaut.rabbitmq.annotation.RabbitClient;
import io.micronaut.rabbitmq.annotation.RabbitProperty;
import io.reactivex.Flowable;

import java.util.List;

@RabbitClient("micronaut") <i class="conum" data-value="1"></i><b>(1)</b>
@RabbitProperty(name = "replyTo", value = "amq.rabbitmq.reply-to") <i class="conum" data-value="2"></i><b>(2)</b>
public interface CatalogueClient {

    @Binding("books.catalogue") <i class="conum" data-value="3"></i><b>(3)</b>
    Flowable&lt;List&lt;Book&gt;&gt; findAll(byte[] data); <i class="conum" data-value="4"></i><b>(4)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send the messages to exchange <code>micronaut</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the <code>replyTo</code> property to <code>amq.rabbitmq.reply-to</code>. This is a special queue that always exists and does not need
to be created. That it is why we did not create the queue in the <code>ChannelInitializer</code>. RabbitMQ uses that queue in a
special way and setting the value of the property <code>replyTo</code> to that queue will enable this call as a RPC one. RabbitMQ
will create a temporary queue for the callback.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the routing key.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the method that will "mirror" the one in the consumer. Keep in mind that in the consumer it is not possible to
return a reactive type, but on the client side it is. Also, it is necessary to send something, even if it&#8217;s not
used in the consumer.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>InventoryClient.java</code>:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookinventory/InventoryClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.bookrecommendation;

import io.micronaut.rabbitmq.annotation.Binding;
import io.micronaut.rabbitmq.annotation.RabbitClient;
import io.micronaut.rabbitmq.annotation.RabbitProperty;
import io.reactivex.Maybe;

@RabbitClient("micronaut") <i class="conum" data-value="1"></i><b>(1)</b>
@RabbitProperty(name = "replyTo", value = "amq.rabbitmq.reply-to") <i class="conum" data-value="2"></i><b>(2)</b>
public interface InventoryClient {

    @Binding("books.inventory") <i class="conum" data-value="3"></i><b>(3)</b>
    Maybe&lt;Boolean&gt; stock(String isbn); <i class="conum" data-value="4"></i><b>(4)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Send the messages to exchange <code>micronaut</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the <code>replyTo</code> property to <code>amq.rabbitmq.reply-to</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the routing key.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define the method that will "mirror" the one in the consumer. As we did with <code>CatalogueClient</code> we use a reactive
type to wrap the result.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_create_the_controller">Create the controller</h3>
<div class="paragraph">
<p>Create a Controller which injects both clients.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.bookrecommendation;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.reactivex.Flowable;

@Controller("/books") <i class="conum" data-value="1"></i><b>(1)</b>
public class BookController {

    private final CatalogueClient catalogueClient; <i class="conum" data-value="2"></i><b>(2)</b>
    private final InventoryClient inventoryClient; <i class="conum" data-value="2"></i><b>(2)</b>

    public BookController(CatalogueClient catalogueClient, InventoryClient inventoryClient) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.catalogueClient = catalogueClient;
        this.inventoryClient = inventoryClient;
    }

    @Get("/") <i class="conum" data-value="3"></i><b>(3)</b>
    public Flowable&lt;BookRecommendation&gt; index() {
        return catalogueClient.findAll(null)
                .flatMap(Flowable::fromIterable)
                .flatMapMaybe(book -&gt; inventoryClient.stock(book.getIsbn())
                        .filter(Boolean::booleanValue)
                        .map(response -&gt; book))
                .map(book -&gt; new BookRecommendation(book.getName()));
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/books</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Clients are injected via constructor injection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>@Get</code> annotation is used to map the index method to an HTTP GET request on <code>/books</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller returns a <code>Flowable&lt;BookRecommendation&gt;</code>. Create the <code>BookRecommendation</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/java/example/micronaut/bookrecommendation/BookRecommendation.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut.bookrecommendation;

import io.micronaut.core.annotation.Introspected;

import java.util.Objects;

@Introspected
public class BookRecommendation {
    private String name;

    public BookRecommendation() {
    }

    public BookRecommendation(String name) {
        this.name = name;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        BookRecommendation that = (BookRecommendation) o;
        return Objects.equals(name, that.name);
    }

    @Override
    public int hashCode() {
        return Objects.hash(name);
    }
}</code></pre>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/rabbitmq.html"><strong>3</strong><span>RabbitMQ and Micronaut</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
