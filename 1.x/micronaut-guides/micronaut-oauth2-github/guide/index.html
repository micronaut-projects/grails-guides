<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Secure a Micronaut app with Github | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Secure a Micronaut app with Github. Learn how to create Micronaut app and secure it with an Authorization Server provided by Github. Learn how to write your own UserDetails Mapper.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-oauth2-github/guide/index.html">Secure a Micronaut app with Github</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-oauth2-github"><img src="https://travis-ci.org/micronaut-guides/micronaut-oauth2-github.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-oauth2-github&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-oauth2-github.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-oauth2-github.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-oauth2-github.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-oauth2-github/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#views"><strong>2.1</strong><span>Views</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#home"><strong>2.2</strong><span>Home</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#oauth2"><strong>2.3</strong><span>Github OAuth App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#oauthconfig"><strong>2.4</strong><span>OAuth 2.0 Configuration</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#mapper"><strong>2.5</strong><span>User Details Mapper</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#github"><strong>2.6</strong><span>Retrieve User Github repositories</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>3</strong><span>Running the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#learnmore"><strong>4</strong><span>Learn More</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#help"><strong>5</strong><span>Help with Micronaut</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Secure a Micronaut app with Github</h1>
        <p>Learn how to create Micronaut app and secure it with an Authorization Server provided by Github. Learn how to write your own UserDetails Mapper.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 1.2.7</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide we are going to create a Micronaut app written in Java.</p>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-oauth2-github/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-oauth2-github.git" class="bare">https://github.com/micronaut-guides/micronaut-oauth2-github.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an app using the <a href="http://docs.micronaut.io/snapshot/guide/index.html#cli">Micronaut Command Line Interface</a>.</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.complete</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a micronaut app with the default package <code>example.micronaut</code> in a folder named <code>complete</code>.</p>
</div>
<div class="paragraph">
<p>By default, <code>create-app</code> creates a Java Micronaut app that uses the <a href="http://gradle.org">Gradle</a> build system. However, you could use
other build tools such as <code>Maven</code> or other programming languages such as <code>Groovy</code> or <code>Kotlin</code>.</p>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="views">2.1 Views</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/views.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Although Micronaut is primarily designed around message encoding / decoding, there are occasions where it is convenient to render a view on the server side.</p>
</div>
<div class="paragraph">
<p>To use the view rendering features, add the following dependency on your classpath. For example, in <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    implementation "io.micronaut:micronaut-views-thymeleaf"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use <a href="https://www.thymeleaf.org/">Thymeleaf</a> Java template engine, add the thymeleaf dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    runtime "org.thymeleaf:thymeleaf:3.0.11.RELEASE"
}</code></pre>
</div>
</div>


<h2 id="home">2.2 Home</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/home.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a controller to handle the requests to <code>/</code>. You are going to display the email of the authenticated person if any. Annotate the controller endpoint with <code>@View</code> since we are going to use a Thymeleaf template.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/HomeController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.rules.SecurityRule;
import io.micronaut.views.View;

import java.util.HashMap;
import java.util.Map;

@Controller
public class HomeController {

    @Secured(SecurityRule.IS_ANONYMOUS)
    @View("home")
    @Get
    public Map&lt;String, Object&gt; index() {
        return new HashMap&lt;&gt;();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>SecurityRule.IS_ANONYMOUS</code> expression will allow access without authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <a href="https://docs.micronaut.io/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template would you like to render the response against.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="http://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation is used to map the <code>index</code> method to GET <code>/</code> requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a thymeleaf template:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/home.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;title&gt;Home&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Micronaut - Github example&lt;/h1&gt;

&lt;h2 th:if="${security}"&gt;username: &lt;span th:text="${security.name}"&gt; &lt;/h2&gt;
&lt;h2 th:unless="${security}"&gt;username: Anonymous&lt;/h2&gt;

&lt;nav&gt;
    &lt;ul&gt;
        &lt;li th:unless="${security}"&gt;&lt;a href="/oauth/login/github"&gt;Enter&lt;/a&gt;&lt;/li&gt;
        &lt;li th:if="${security}"&gt;&lt;a href="/repos"&gt;View Repos&lt;/a&gt;&lt;/li&gt;
        &lt;li th:if="${security}"&gt;&lt;a href="/oauth/logout"&gt;Logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/nav&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, note that we return an empty model in the controller. However, we are accessing <code>security</code> in the thymeleaf template.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/views/model/security/SecurityViewModelProcessor.html">SecurityViewModelProcessor</a>
injects into the model a <code>security</code> map with the authenticated user.  See
<a href="https://micronaut-projects.github.io/micronaut-views/latest/guide/index.html#views-security">User in a view</a> documentation.</p>
</li>
</ul>
</div>


<h2 id="oauth2">2.3 Github OAuth App</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/oauth2.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To provide authentication, create a <a href="https://developer.github.com/apps/about-apps/">Github Oauth App</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/github-1.png" alt="github 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/github-2.png" alt="github 2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/github-3.png" alt="github 3">
</div>
</div>


<h2 id="oauthconfig">2.4 OAuth 2.0 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/oauthconfig.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To use OAuth 2.0 integration, add the next dependency:</p>
</div>
<div class="listingblock">
<div class="title">gradle.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronautVersion=1.2.7</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    implementation "io.micronaut.configuration:micronaut-security-oauth2"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add also JWT <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#jwt">Micronaut’s JWT support</a> dependencies:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    annotationProcessor "io.micronaut:micronaut-security"
    implementation "io.micronaut:micronaut-security-jwt"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following Oauth2 Configuration:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronaut:
micronaut:
  security:
    enabled: true <i class="conum" data-value="1"></i><b>(1)</b>
    oauth2:
      enabled: true
      clients:
        github: <i class="conum" data-value="2"></i><b>(2)</b>
          client-id:  '${OAUTH_CLIENT_ID}' <i class="conum" data-value="3"></i><b>(3)</b>
          client-secret: '${OAUTH_CLIENT_SECRET}' <i class="conum" data-value="4"></i><b>(4)</b>
          scopes: <i class="conum" data-value="5"></i><b>(5)</b>
            - user:email
            - read:user
            - public_repo
          authorization:
            url: 'https://github.com/login/oauth/authorize' <i class="conum" data-value="6"></i><b>(6)</b>
          token:
            url: 'https://github.com/login/oauth/access_token' <i class="conum" data-value="7"></i><b>(7)</b>
            auth-method: client-secret-post
    token:
      jwt:
        enabled: true <i class="conum" data-value="8"></i><b>(8)</b>
        cookie:
          enabled: true <i class="conum" data-value="9"></i><b>(9)</b>
    endpoints:
      logout:
        enabled: true  <i class="conum" data-value="10"></i><b>(10)</b>
        get-allowed: true <i class="conum" data-value="11"></i><b>(11)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable security</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The provider identifier should match the last part of the url you entered as a redirect url <code>/oauth/callback/github</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Client Secret. See previous screenshot.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Client ID. See previous screenshot.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Specify the scopes you want to request. <a href="https://developer.github.com/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/">Github Scopes</a> let you sepcify exactly what type of access you need.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Map manually the Github&#8217;s <a href="https://tools.ietf.org/html/rfc6749#section-3.1">Authorization endpoint</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Map manually the Github&#8217;s <a href="https://tools.ietf.org/html/rfc6749#section-3.2">Token endpoint</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>ID Token is a JWT token. We need to enable <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#jwt">Micronaut’s JWT support</a> to validate it.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Once validated, we are going to save the ID Token in a Cookie. To read in subsequent requests, enable <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#cookieToken">Cookie Token Reader</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Enable <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#logout">Logout Controller</a></td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Accept GET request to the <code>/logout</code> endpoint.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous configuration uses several placeholders. You will need to setup <code>OAUTH_CLIENT_ID</code>, <code>OAUTH_CLIENT_SECRET</code> environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export OAUTH_CLIENT_ID=XXXXXXXXXX
export OAUTH_CLIENT_SECRET=YYYYYYYYYY</pre>
</div>
</div>


<h2 id="mapper">2.5 User Details Mapper</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/mapper.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Here is a high level diagram of how the authorization code grant flow works with an OAuth 2.0 provider such as Github.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/standard-oauth.svg" alt="standard oauth">
</div>
</div>
<div class="paragraph">
<p>We need an HTTP Client to retrieve the user info. Create a POJO to represent a Github user:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubUser.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import com.fasterxml.jackson.databind.PropertyNamingStrategy;
import com.fasterxml.jackson.databind.annotation.JsonNaming;
import io.micronaut.core.annotation.Introspected;

@Introspected
public class GithubUser {

    private String login;
    private String name;
    private String email;

    public GithubUser() {

    }

    public String getLogin() {
        return login;
    }

    public void setLogin(String login) {
        this.login = login;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a Micronaut Declarative HTTP Client to consume <a href="https://developer.github.com/v3/">Github REST API v3</a></p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubApiClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpHeaders;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Header;
import io.micronaut.http.annotation.QueryValue;
import io.micronaut.http.client.annotation.Client;
import io.reactivex.Flowable;

import javax.annotation.Nullable;
import javax.validation.constraints.Pattern;
import java.util.List;

@Header(name = "User-Agent", value = "https://micronautguides.com")
@Header(name = "Accept", value = "application/vnd.github.v3+json, application/json") <i class="conum" data-value="1"></i><b>(1)</b>
@Client(id = "githubv3")
public interface GithubApiClient {

    @Get("/user") <i class="conum" data-value="3"></i><b>(3)</b>
    Flowable&lt;GithubUser&gt; getUser( <i class="conum" data-value="4"></i><b>(4)</b>
            @Header(HttpHeaders.AUTHORIZATION) String authorization); <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Github encourages to explicitly request the version 3 via the Accept header. With <code>@Header</code>, you add the <code>Accept: application/vnd.github.v3+json</code> HTTP header to every request.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add the id <code>githubv3</code> to the <code>@Client</code> annotation. Later, you will provide url for this client id.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define a HTTP GET request to <code>/user</code> endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can return reactive types in a Micronaut declarative HTTP client.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can specify that a parameter binds to a HTTP Header such as the <strong>Authorization</strong> header.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Specify the url for the <code>githubv3</code> service.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronaut:
  http:
    services:
      githubv3:
        url: "https://api.github.com"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Github we need to provide a UserDetails Mapper. The easiest way is to create a bean which implements <code>OauthUserDetailsMapper</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubUserDetailsMapper.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;
import io.micronaut.security.authentication.UserDetails;
import io.micronaut.security.oauth2.endpoint.token.response.OauthUserDetailsMapper;
import io.micronaut.security.oauth2.endpoint.token.response.TokenResponse;
import org.reactivestreams.Publisher;

import javax.inject.Named;
import javax.inject.Singleton;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Named("github") <i class="conum" data-value="1"></i><b>(1)</b>
@Singleton
public class GithubUserDetailsMapper implements OauthUserDetailsMapper {

    public static final String TOKEN_PREFIX = "token ";
    public static final String ROLE_GITHUB = "ROLE_GITHUB";
    private final GithubApiClient apiClient;

    public GithubUserDetailsMapper(GithubApiClient apiClient) {
        this.apiClient = apiClient;
    }

    @Override
    public Publisher&lt;UserDetails&gt; createUserDetails(TokenResponse tokenResponse) {
        return apiClient.getUser(TOKEN_PREFIX + tokenResponse.getAccessToken()) <i class="conum" data-value="2"></i><b>(2)</b>
                .map(user -&gt; new UserDetails(user.getLogin(),
                        Collections.singletonList(ROLE_GITHUB),
                        Collections.singletonMap(OauthUserDetailsMapper.ACCESS_TOKEN_KEY, tokenResponse.getAccessToken()))); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usa a name qualifier for the bean which matches the name you used in the OAuth 2.0 configuration in <code>application.yml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Consume the <code>/user</code> endpoint with the Micronaut HTTP Client.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Save the original Github access token in a claim. We will use to to contact Github&#8217;s api later.</td>
</tr>
</table>
</div>


<h2 id="github">2.6 Retrieve User Github repositories</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/github.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>With the access token, we retrieved during the login we are going to contact the Github API to fetch the user&#8217;s repositories.</p>
</div>
<div class="paragraph">
<p>First, create a POJO to represent a Github repository:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubRepo.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.core.annotation.Introspected;

@Introspected
public class GithubRepo {

    private String name;

    public GithubRepo() {

    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a method to <code>GithubApiClient</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">....
public interface GithubApiClient {
....
    @Get("/user/repos{?sort,direction}") <i class="conum" data-value="1"></i><b>(1)</b>
    List&lt;GithubRepo&gt; repos(
            @Pattern(regexp = "created|updated|pushed|full_name") @Nullable @QueryValue String sort, <i class="conum" data-value="2"></i><b>(2)</b>
            @Pattern(regexp = "asc|desc") @Nullable @QueryValue String direction, <i class="conum" data-value="2"></i><b>(2)</b>
            @Header(HttpHeaders.AUTHORIZATION) String authorization);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify two query values <code>sort</code> and <code>direction</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate <code>sort</code> and <code>direction</code> as <code>@Nullable</code> since they are optional. You can restrict the allowed values with use of constraints.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a controller to expose <code>/repos</code> endpoint:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/ReposController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpHeaderValues;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.authentication.Authentication;
import io.micronaut.security.oauth2.endpoint.token.response.OauthUserDetailsMapper;
import io.micronaut.security.rules.SecurityRule;
import io.micronaut.views.View;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Controller("/repos") <i class="conum" data-value="1"></i><b>(1)</b>
public class ReposController {

    public static final String CREATED = "created";
    public static final String DESC = "desc";
    public static final String REPOS = "repos";
    private final GithubApiClient githubApiClient;

    public ReposController(GithubApiClient githubApiClient) {
        this.githubApiClient = githubApiClient;
    }

    @Secured(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
    @View("repos") <i class="conum" data-value="3"></i><b>(3)</b>
    @Get <i class="conum" data-value="4"></i><b>(4)</b>
    Map&lt;String, Object&gt; index(Authentication authentication) {
        List&lt;GithubRepo&gt; repos = githubApiClient.repos(CREATED, DESC, authorizationValue(authentication));  <i class="conum" data-value="5"></i><b>(5)</b>
        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();
        model.put(REPOS, repos);
        return model;
    }

    private String authorizationValue(Authentication authentication) {
        String authorization = null;
        Object claim = authentication.getAttributes().get(OauthUserDetailsMapper.ACCESS_TOKEN_KEY);  <i class="conum" data-value="6"></i><b>(6)</b>
        if (claim instanceof String) {
            authorization = HttpHeaderValues.AUTHORIZATION_PREFIX_BEARER + " " + claim.toString();
        }
        return authorization;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Qualify the <code>@Controller</code> annotation with <code>/repos</code> to designate the endpoint url.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want this endpoint to be only accessible to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We specify the view name <code>repos</code> which is used to render the model.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare a GET endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Consume the Github API.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use the previously obtained access token to get access against the Github API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a thymeleaf template:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/repos.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;title&gt;Home&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;&lt;a href="/"&gt;Home&lt;/a&gt; &amp;rarr; Repositories&lt;/h1&gt;
&lt;nav&gt;
    &lt;ul th:each="repo: ${repos}"&gt;
        &lt;li th:text="${repo.name}"/&gt;
    &lt;/ul&gt;
&lt;/nav&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>


<h1 id="runningTheApp">3 Running the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the application use the <code>./gradlew run</code> command which will start the application on port 8080.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/video.gif" alt="video">
</div>
</div>


<h1 id="learnmore">4 Learn More</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/learnmore.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth">Micronaut OAuth 2.0 documentation</a> to learn more.</p>
</div>


<h1 id="help">5 Help with Micronaut</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/help.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333;">OCI sponsored the creation of this Guide. OCI offers several <a href="https://objectcomputing.com/products/micronaut/">Micronaut services</a>:</h3>

<img src="../img/oci-micronaut-services.svg"/>

<h3>Free consultation </h3>

<!-- This is the code that is needed to run the form -->

<!--Copy and paste into the document's head or body.-->

<script type="text/javascript">

    /** This section is only needed once per page if manually copying **/
    if (typeof MauticSDKLoaded == 'undefined') {
        var MauticSDKLoaded = true;
        var head            = document.getElementsByTagName('head')[0];
        var script          = document.createElement('script');
        script.type         = 'text/javascript';
        script.src          = 'https://mautic.objectcomputing.com/media/js/mautic-form.js';
        script.onload       = function() {
            MauticSDK.onLoad();
        };
        head.appendChild(script);
        var MauticDomain = 'https://mautic.objectcomputing.com';
        var MauticLang   = {
            'submittingMessage': "Please wait..."
        }
    }
</script>

<!--Copy and paste into the document's body.-->

<style type="text/css" scoped>
    .mauticform_wrapper { max-width: 600px; margin: 10px auto; }
    .mauticform-innerform {}
    .mauticform-post-success {}
    .mauticform-name { font-weight: bold; font-size: 1.5em; margin-bottom: 3px; }
    .mauticform-description { margin-top: 2px; margin-bottom: 10px; }
    .mauticform-error { margin-bottom: 10px; color: red; }
    .mauticform-message { margin-bottom: 10px;color: green; }
    .mauticform-row { display: block; margin-bottom: 20px; }
    .mauticform-label { font-size: 1.1em; display: block; font-weight: bold; margin-bottom: 5px; }
    .mauticform-row.mauticform-required .mauticform-label:after { color: #e32; content: " *"; display: inline; }
    .mauticform-helpmessage { display: block; font-size: 0.9em; margin-bottom: 3px; }
    .mauticform-errormsg { display: block; color: red; margin-top: 2px; }
    .mauticform-selectbox, .mauticform-input, .mauticform-textarea { width: 100%; padding: 0.5em 0.5em; border: 1px solid #CCC; background: #fff; box-shadow: 0px 0px 0px #fff inset; border-radius: 4px; box-sizing: border-box; }
    .mauticform-checkboxgrp-row {}
    .mauticform-checkboxgrp-label { font-weight: normal; }
    .mauticform-checkboxgrp-checkbox {}
    .mauticform-radiogrp-row {}
    .mauticform-radiogrp-label { font-weight: normal; }
    .mauticform-radiogrp-radio {}
    .mauticform-button-wrapper .mauticform-button.btn-default, .mauticform-pagebreak-wrapper .mauticform-pagebreak.btn-default { font-size: 14px; color: #fff;background-color: #feb672 ;border-color: #dddddd; padding: 15px 30px;}
    .mauticform-button-wrapper .mauticform-button, .mauticform-pagebreak-wrapper .mauticform-pagebreak { display: inline-block;margin-bottom: 0;font-weight: 600;text-align: center;vertical-align: middle;cursor: pointer;background-image: none;border: 1px solid transparent;white-space: nowrap;padding: 6px 12px;font-size: 13px;line-height: 1.3856;border-radius: none;-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}
    .mauticform-button-wrapper .mauticform-button.btn-default[disabled], .mauticform-pagebreak-wrapper .mauticform-pagebreak.btn-default[disabled] { background-color:#feb672; border-color: #dddddd; opacity: 0.75; cursor: not-allowed; font-size: 14px; color: #fff; padding: 15px 30px;}
    .mauticform-pagebreak-wrapper .mauticform-button-wrapper {  display: inline; }
</style>
<div id="mauticform_wrapper_grailsorgconsultationform" class="mauticform_wrapper">
    <form autocomplete="false" role="form" method="post" action="https://mautic.objectcomputing.com/form/submit?formId=3" id="mauticform_grailsorgconsultationform" data-mautic-form="grailsorgconsultationform">

        <div class="mauticform-innerform">

          <div class="mauticform-page-wrapper mauticform-page-1" data-mautic-form-page="1">

            <div id="mauticform_grailsorgconsultationform_first_name"  data-validate="first_name" data-validation-type="text" class="mauticform-row mauticform-text mauticform-field-1 mauticform-required col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_first_name" name="mauticform[first_name]" value="" placeholder="First Name *" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_last_name"  data-validate="last_name" data-validation-type="text" class="mauticform-row mauticform-text mauticform-field-2 mauticform-required col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_last_name" name="mauticform[last_name]" value="" placeholder="Last Name *" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_email"  data-validate="email" data-validation-type="email" class="mauticform-row mauticform-email mauticform-field-3 mauticform-required col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_email" name="mauticform[email]" value="" placeholder="Email *" class="mauticform-input" type="email" />
                <span class="mauticform-errormsg" style="display: none;">This is required.</span>
            </div>

            <div id="mauticform_grailsorgconsultationform_phone"  class="mauticform-row mauticform-tel mauticform-field-4 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_phone" name="mauticform[phone]" value="" placeholder="Phone" class="mauticform-input" type="tel" />
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div id="mauticform_grailsorgconsultationform_company"  class="mauticform-row mauticform-text mauticform-field-5 col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <input id="mauticform_input_grailsorgconsultationform_company" name="mauticform[company]" value="" placeholder="Company" class="mauticform-input" type="text" />
                <span class="mauticform-errormsg" style="display: none;"></span>
            </div>

            <div id="mauticform_grailsorgconsultationform_submit"  class="mauticform-row mauticform-button-wrapper mauticform-field-6" style="">
                <button type="submit" name="mauticform[submit]" id="mauticform_input_grailsorgconsultationform_submit" name="mauticform[submit]" value="" class="mauticform-button btn btn-default" value="1" style="border: none; margin-left: 14px;">SUBMIT</button>
            </div>
            </div>
        </div>

        <input type="hidden" name="mauticform[formId]" id="mauticform_grailsorgconsultationform_id" value="3"/>
        <input type="hidden" name="mauticform[return]" id="mauticform_grailsorgconsultationform_return" value=""/>
        <input type="hidden" name="mauticform[formName]" id="mauticform_grailsorgconsultationform_name" value="grailsorgconsultationform"/>
</form>
</div>

<!--The code below is the message that appears when someone hits submit. Feel free to style this how you see fit for Grails.org. All CSS is handled in the above code.-->

<div class="mauticform-error" id="mauticform_grailsorgconsultationform_error"></div>
<div class="mauticform-message" id="mauticform_grailsorgconsultationform_message"></div>

<h3 style="color: #333;">The <a href="https://objectcomputing.com/products/micronaut">OCI Micronaut Team</a>
includes Micronaut co-founders, <b>Jeff Scott Brown and Graeme Rocher</b>.
Check our <a href="https://objectcomputing.com/services/training/catalog/micronaut-training">Micronaut courses</a> and learn from the engineers who developed,
matured and maintain Micronaut.</h3>

<img src="../img/ocigrailsteam.png" style="max-width: 748px; width: 100%;" alt="Micronaut OCI Team">

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
