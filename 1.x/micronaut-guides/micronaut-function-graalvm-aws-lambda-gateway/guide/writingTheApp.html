<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2 Writing the Application null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut Functions in GraalVM Native Images deployed to AWS Lambda
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/samLocal.html"><strong>3</strong><span>Running Lambda Locally via SAM</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/deployToLambda.html"><strong>4</strong><span>Deploying to AWS Lambda</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/setupApiGateway.html"><strong>5</strong><span>Connecting our Lambda to API Gateway</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>6</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>7</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Introduction</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/samLocal.html"><strong>3</strong><span>Running Lambda Locally via SAM</span> >></a></div>
                


                <div class="project">
                    <h1>2 Writing the Application</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#service"><strong>2.1</strong><span>PrimeFinderService</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#controller"><strong>2.2</strong><span>PrimeFinderController</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="writingTheApp">2 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Using <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html">Lambda Proxy Integration in API Gateway</a> allows you to code a serveless application as you would normally code a traditional app, with controllers to handle HTTP requests.</p>
</div>
<div class="paragraph">
<p>Use the micronaut feature <code>aws-api-gateway-graal</code> to create an app ready to be deployed to AWS Lambda with Custom runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mn create-app example.micronaut.complete --features aws-api-gateway-graal</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>aws-api-gateway-graal</code> feature includes the <code>micronaut-function-aws-custom-runtime</code> dependency which includes the <code>MicronautLambdaRuntime</code> class, an implementation that you can use to execute a custom runtime as described in AWS documentation <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-walkthrough.html">Publishing a custom runtime</a>.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
    implementation("io.micronaut.aws:micronaut-function-aws-custom-runtime") {
        exclude group: "com.fasterxml.jackson.module", module: "jackson-module-afterburner"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, <code>aws-api-gateway-graal</code> feature includes the <code>micronaut-function-aws-api-proxy</code> dependency which adds the Micronaut support for the <a href="https://github.com/awslabs/aws-serverless-java-container">AWS Serverless Java Container</a> project.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
    implementation("io.micronaut.aws:micronaut-function-aws-api-proxy") {
        exclude group: "com.fasterxml.jackson.module", module: "jackson-module-afterburner"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, we have moved the dependencies (<code>micronaut-http-server-netty</code> and <code>micronaut-http-client</code>) to the test classpath. <strong>It is important to remove unused dependencies</strong>.
:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
    testImplementation "io.micronaut:micronaut-http-client"
    testImplementation "io.micronaut:micronaut-http-server-netty"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll be keeping it simple and creating a controller to find all the prime numbers less than N,
using the <a href="https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes">Sieve of Eratosthenes</a>.</p>
</div>


<h2 id="service">2.1 PrimeFinderService</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp/service.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Just as any other Micronaut app, we&#8217;ll want to isolate the "business logic"  of how we compute
the prime numbers to a service.</p>
</div>
<div class="paragraph">
<p>As we mentioned previously, the most efficient algorithm to calculate the primes below a given
number N is the <a href="https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes">Sieve of Eratosthenes</a>, which
steps up from 2 to N and tosses out all the multiples of the given step, so that subsequent passes
are working with only the leftover numbers on the next pass.</p>
</div>
<div class="paragraph">
<p>See below for an adaption of
<a href="https://www.geeksforgeeks.org/sieve-eratosthenes-0n-time-complexity/">this O(n) java implementation of the algorithm</a></p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example.micronaut.PrimeFinderService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import javax.inject.Singleton;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

@Singleton
public class PrimeFinderService {
    // Credit to https://www.geeksforgeeks.org/sieve-eratosthenes-0n-time-complexity/
    // for this clever O(n) implementation of the Sieve
    public final int MAX_SIZE = 1000001;
    // isPrime[] : isPrime[i] is true if number is prime
    // prime[] : stores all prime number less than N
    // SPF[] that store smallest prime factor of number
    // [for Exp : smallest prime factor of '8' and '16'
    // is '2' so we put SPF[8] = 2 , SPF[16] = 2 ]
    private Vector&lt;Boolean&gt; isPrime = new Vector&lt;&gt;(MAX_SIZE);
    private Vector&lt;Integer&gt; SPF = new Vector&lt;&gt;(MAX_SIZE);

    public PrimeFinderService() {
        long startTime = System.currentTimeMillis();

        // Init the isPrime and SPF vectors
        for (int i = 0; i &lt; MAX_SIZE; i++) {
            isPrime.add(true);
            SPF.add(2);
        }
        // 0 and 1 are not prime
        isPrime.set(0, false);
        isPrime.set(1, false);
        long endTime = System.currentTimeMillis();
        System.out.println("Total execution time: " + (endTime-startTime) + "ms");
    }

    public List&lt;Integer&gt; findPrimesLessThan(int n) {
        // Fill in the rest of the entries
        List&lt;Integer&gt; prime = new ArrayList&lt;&gt;();
        for (int i = 2; i &lt; n; i++) {
            // If isPrime[i] == True then i is
            // prime number
            if (isPrime.get(i)) {
                // put i into prime[] vector
                prime.add(i);

                // A prime number is its own smallest
                // prime factor
                SPF.set(i, i);
            }

            // Remove all multiples of  i*prime[j] which are
            // not prime by making isPrime[i*prime[j]] = false
            // and put smallest prime factor of i*Prime[j] as prime[j]
            // [for exp :let  i = 5, j = 0, prime[j] = 2 [ i*prime[j] = 10]
            // so smallest prime factor of '10' is '2' that is prime[j] ]
            // this loop run only one time for number which are not prime
            for (int j = 0;
                 j &lt; prime.size() &amp;&amp;
                         i * prime.get(j) &lt; n &amp;&amp; prime.get(j) &lt;= SPF.get(i);
                 j++) {
                isPrime.set(i * prime.get(j), false);

                // put smallest prime factor of i*prime[j]
                SPF.set(i * prime.get(j), prime.get(j));
            }
        }
        return prime;
    }
}</code></pre>
</div>
</div>


<h2 id="controller">2.2 PrimeFinderController</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>So unlike the previous guide, this lambda operates just like a standard Micronaut app.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a small wrapper class for our responses.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example.micronaut.PrimeFinderResponse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.core.annotation.Introspected;

import java.util.List;

@Introspected
public class PrimeFinderResponse {

    private String message;
    private List&lt;Integer&gt; primes;

    public PrimeFinderResponse() {
    }

    public List&lt;Integer&gt; getPrimes() {
        return primes;
    }

    public void setPrimes(List&lt;Integer&gt; primes) {
        this.primes = primes;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we&#8217;ll replace the <code>ExampleController.java</code> with with a <code>PrimeFinderController</code> that utilizes
our service from the previous step.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example.micronaut.PrimeFinderController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Controller("/") <i class="conum" data-value="1"></i><b>(1)</b>
public class PrimeFinderController {
    private static final Logger LOG = LoggerFactory.getLogger(PrimeFinderController.class); <i class="conum" data-value="2"></i><b>(2)</b>

    private final PrimeFinderService primeFinderService;

    public PrimeFinderController(PrimeFinderService primeFinderService) { <i class="conum" data-value="3"></i><b>(3)</b>
        this.primeFinderService = primeFinderService;
    }

    @Get("/find-primes-below/{number}")
    public PrimeFinderResponse findPrimesBelow(int number) {
        PrimeFinderResponse resp = new PrimeFinderResponse();
        if (number &gt;= primeFinderService.MAX_SIZE) {
            if (LOG.isInfoEnabled()) {
                LOG.info("This number is too big, you can't possibly want to know all the primes below a number this big.");
            }
            resp.setMessage("This service only returns lists for numbers below " + primeFinderService.MAX_SIZE);
            return resp;
        }
        if (LOG.isDebugEnabled()) {
            LOG.debug("Computing all the primes smaller than {} ...", number);
        }
        resp.setMessage("Success!");
        resp.setPrimes(primeFinderService.findPrimesLessThan(number));
        return resp;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note this is just like a regular Micronaut controller, using the <code>@Controller</code> annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Be sure to add a <code>LOG</code> so that you will be able to see log output in CloudWatch</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We want to use constructor-based injection to get our <code>PrimeFinderService</code> in the controller</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll also want to modify the <code>logback.xml</code> to set the DEBUG level for our <code>example.micronaut</code> package.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/logback.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;configuration&gt;

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;withJansi&gt;true&lt;/withJansi&gt;
        &lt;!-- encoders are assigned the type
             ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%cyan(%d{HH:mm:ss.SSS}) %gray([%thread]) %highlight(%-5level) %magenta(%logger{36}) - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level="info"&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
    &lt;/root&gt;
    &lt;logger name="example.micronaut" level="DEBUG"/&gt; &lt;!-- &lt;1&gt; --&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the line we need to add, that sets the log level to DEBUG for our package</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can test your servless app as you would normally test your app:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example.micronaut.PrimeFinderControllerTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.HttpClient;
import io.micronaut.http.client.annotation.Client;
import io.micronaut.runtime.server.EmbeddedServer;
import io.micronaut.test.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import javax.inject.Inject;

import java.util.Arrays;
import java.util.Collections;

import static org.junit.jupiter.api.Assertions.assertEquals;

@MicronautTest
public class PrimeFinderControllerTest {
    @Inject
    EmbeddedServer server;

    @Inject
    @Client("/")
    HttpClient client;

    @Test
    void testPrimesBelow3() {
        PrimeFinderResponse response = client.toBlocking()
                .retrieve(HttpRequest.GET("/find-primes-below/3"), PrimeFinderResponse.class);
        assertEquals(Collections.singletonList(2), response.getPrimes());
    }
}</code></pre>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Introduction</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/samLocal.html"><strong>3</strong><span>Running Lambda Locally via SAM</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
