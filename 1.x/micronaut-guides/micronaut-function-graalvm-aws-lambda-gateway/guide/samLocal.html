<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3 Running Lambda Locally via SAM null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut Functions in GraalVM Native Images deployed to AWS Lambda
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/samLocal.html"><strong>3</strong><span>Running Lambda Locally via SAM</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/deployToLambda.html"><strong>4</strong><span>Deploying to AWS Lambda</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/setupApiGateway.html"><strong>5</strong><span>Connecting our Lambda to API Gateway</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>6</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>7</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/writingTheApp.html">&lt;&lt; <strong>2</strong><span>Writing the Application</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/deployToLambda.html"><strong>4</strong><span>Deploying to AWS Lambda</span> >></a></div>
                


                <div class="project">
                    <h1>3 Running Lambda Locally via SAM</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h1 id="samLocal">3 Running Lambda Locally via SAM</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/samLocal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This step is optional. To follow along, you&#8217;ll need the
<a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html">AWS SAM CLI tool</a>
installed locally.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <strong>S</strong> erverless <strong>A</strong> pplication <strong>M</strong> odel, or <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html">SAM</a>,
is a framework for defining an application using a serverless architecture.</p>
</div>
<div class="paragraph">
<p>It is also a CLI tool provided by Amazon to mock the AWS environment locally.</p>
</div>
<div class="paragraph">
<p>This is going to allow us to run our Micronaut app as a graal native image, within an AWS Lambda custom runtime, all on our own machine.</p>
</div>
<div class="paragraph">
<p>The Micronaut team have provided a simple shell script in the <code>aws-api-gateway-graal</code> feature called <code>sam-local.sh</code>, which
builds the app into a Graal native image via Docker and packages it with the required <code>bootstrap</code> file for AWS Lambda custom runtimes into a simple <code>zip</code>.</p>
</div>
<div class="paragraph">
<p>It then executes the SAM CLI tool with the (also included) <code>sam.yaml</code> file, which describes the Cloudformation architecture of our Serverless
application (in this case, it is simple one endpoint, run via Lambda and triggered via the API Gateway)</p>
</div>
<div class="listingblock">
<div class="title">prime-finder/sam-local.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/sh
docker build . -t prime-finder <i class="conum" data-value="1"></i><b>(1)</b>
mkdir -p build
docker run --rm --entrypoint cat prime-finder  /home/application/function.zip &gt; build/function.zip <i class="conum" data-value="2"></i><b>(2)</b>

sam local start-api -t sam.yaml -p 3000 <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We build the application zip in a docker container (see the dockerfile below)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This extracts the <code>function.zip</code> file built by the docker container to the <code>build/</code> directory, for use by <code>sam-local</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the command to run our infrastructure locally</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Try running this yourself, via</p>
</div>
<div class="paragraph">
<p><code>./sam-local.sh</code></p>
</div>
<div class="paragraph">
<p>And then (after some time, building the native image in docker and orchestrating the SAM environment can take a couple minutes),
try <code>curl</code> ing your endpoint (it should start up on port 3000 within the SAM docker container, forwarded to your machine)</p>
</div>
<div class="paragraph">
<p><code>curl localhost:3000/find-primes-below/999</code></p>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/writingTheApp.html">&lt;&lt; <strong>2</strong><span>Writing the Application</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/deployToLambda.html"><strong>4</strong><span>Deploying to AWS Lambda</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
