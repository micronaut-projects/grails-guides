<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3 Lambda null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Deploy a Micronaut function as a GraalVM Native Image to AWS Lambda
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/lambda.html"><strong>3</strong><span>Lambda</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>4</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>5</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/writingTheApp.html">&lt;&lt; <strong>2</strong><span>Writing the App</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/nextSteps.html"><strong>4</strong><span>Next Steps</span> >></a></div>
                


                <div class="project">
                    <h1>3 Lambda</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#createfunction"><strong>3.1</strong><span>Create Function</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#uploadcode"><strong>3.2</strong><span>Upload Code</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#handler"><strong>3.3</strong><span>Handler</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#test"><strong>3.4</strong><span>Test</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="lambda">3 Lambda</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-serverless-function-aws-lambda-graalvm/edit/master/src/main/docs/guide/lambda.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>





<h2 id="createfunction">3.1 Create Function</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-serverless-function-aws-lambda-graalvm/edit/master/src/main/docs/guide/lambda/createfunction.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Lambda Function. As a runtime, select Java 11 (Correto).</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/create-function.png" alt="create function"></span></p>
</div>


<h2 id="uploadcode">3.2 Upload Code</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-serverless-function-aws-lambda-graalvm/edit/master/src/main/docs/guide/lambda/uploadcode.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut&#8217;s eases the deployment of your functions as a <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html">Custom AWS Lambda runtime</a>.</p>
</div>
<div class="paragraph">
<p>The main API you will interact with is <a href="https://micronaut-projects.github.io/micronaut-aws/latest/api/io/micronaut/function/aws/runtime/AbstractMicronautLambdaRuntime.html">AbstractMicronautLambdaRuntime</a>. An abstract class which you can extend to create your custom runtime <code>mainClass</code>. That class includes the necessary code to perform the <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html#runtimes-custom-build">Processing Tasks</a> described in the Custom Runtime documentation.</p>
</div>
<div class="paragraph">
<p>The generated project contains such a class:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/BookLambdaRuntime.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;
import com.amazonaws.services.lambda.runtime.events.APIGatewayProxyRequestEvent;
import com.amazonaws.services.lambda.runtime.events.APIGatewayProxyResponseEvent;
import io.micronaut.function.aws.runtime.AbstractMicronautLambdaRuntime;
import java.net.MalformedURLException;
import com.amazonaws.services.lambda.runtime.RequestHandler;
import edu.umd.cs.findbugs.annotations.Nullable;

public class BookLambdaRuntime extends AbstractMicronautLambdaRuntime&lt;APIGatewayProxyRequestEvent, APIGatewayProxyResponseEvent, Book, BookSaved&gt; {

    public static void main(String[] args) {
        try {
            new BookLambdaRuntime().run(args);

        } catch (MalformedURLException e) {
            e.printStackTrace();
        }
    }

    @Override
    @Nullable
    protected RequestHandler&lt;Book, BookSaved&gt; createRequestHandler(String... args) {
        return new BookRequestHandler();
    }
}</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="_bootstrap">bootstrap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We deploy our custom runtime code as a ZIP file. At the root of the ZIP file you need a <code>bootstrap</code> file.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>If thereâ€™s a file named bootstrap in your deployment package, Lambda executes that file.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The generated application contains a <code>bootstrap</code> bash script:</p>
</div>
<div class="listingblock">
<div class="title">bootstrap</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/sh
set -euo pipefail
./complete -Xmx128m -Djava.library.path=$(pwd)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_native_image_properties">native-image.properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To generate a GraalVM Native image of the application, we need a <a href="https://www.graalvm.org/reference-manual/native-image/Configuration/#properties-file-format">native-image.properties</a> file.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/native-image/example.micronaut/complete-application/native-image.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Args = -H:Name=complete \
       -H:Class=example.micronaut.BookLambdaRuntime</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>H:Class</code> argument defines the main class of your app.</p>
</li>
<li>
<p>The <code>H:Name</code> argument defines  the native image name. The Dockerfile references this name.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dockerfile">Dockerfile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project includes a Dockerfile to generate a GraalVM Native image.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Uses the amazonlinux image</p>
</li>
<li>
<p>Builds the JAR of the function.</p>
</li>
<li>
<p>Install the necessary dependencies.</p>
</li>
<li>
<p>Downloads GraalVM community edition</p>
</li>
<li>
<p>Installs native-image utility.</p>
</li>
<li>
<p>With the native-image command and the JAR, generates a GraalVM native image</p>
</li>
<li>
<p>Bundles the native image of our function and the bootstrap file into a ZIP file.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-docker" data-lang="docker">FROM gradle:6.3.0-jdk11 as builder
COPY --chown=gradle:gradle . /home/application
WORKDIR /home/application
RUN ./gradlew build --no-daemon
FROM amazonlinux:2018.03.0.20191014.0 as graalvm

ENV LANG=en_US.UTF-8

RUN yum install -y gcc gcc-c++ libc6-dev  zlib1g-dev curl bash zlib zlib-devel zip

ENV GRAAL_VERSION 20.1.0
ENV JDK_VERSION java11
ENV GRAAL_FILENAME graalvm-ce-${JDK_VERSION}-linux-amd64-${GRAAL_VERSION}.tar.gz

RUN curl -4 -L https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-${GRAAL_VERSION}/${GRAAL_FILENAME} -o /tmp/${GRAAL_FILENAME}

RUN tar -zxvf /tmp/${GRAAL_FILENAME} -C /tmp \
    &amp;&amp; mv /tmp/graalvm-ce-${JDK_VERSION}-${GRAAL_VERSION} /usr/lib/graalvm

RUN rm -rf /tmp/*
CMD ["/usr/lib/graalvm/bin/native-image"]

FROM graalvm
COPY --from=builder /home/application/ /home/application/
WORKDIR /home/application
RUN /usr/lib/graalvm/bin/gu install native-image
RUN /usr/lib/graalvm/bin/native-image --no-server -cp build/libs/complete-*-all.jar
RUN chmod 777 bootstrap
RUN chmod 777 complete
RUN zip -j function.zip bootstrap complete
EXPOSE 8080
ENTRYPOINT ["/home/application/complete"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above file references the name used in the <code>native-image.properties</code> file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_sh">deploy.sh</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It includes a bash script to generate the ZIP file:</p>
</div>
<div class="listingblock">
<div class="title">deploy.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/bash
docker build . -t complete
mkdir -p build
docker run --rm --entrypoint cat complete  /home/application/function.zip &gt; build/function.zip</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upload_the_file">Upload the file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Execute <code>./deploy.sh</code> and once you have a ZIP file, upload it</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../img/upload-function-code.png" alt="upload function code"></span></p>
</div>
</div>
</div>


<h2 id="handler">3.3 Handler</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-serverless-function-aws-lambda-graalvm/edit/master/src/main/docs/guide/lambda/handler.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The handler used is the one created at <a href="https://micronaut-projects.github.io/micronaut-aws/latest/api/io/micronaut/function/aws/runtime/MicronautLambdaRuntime.html">MicronautLambdaRuntime</a>.</p>
</div>
<div class="paragraph">
<p>Thus, you don&#8217;t need specify the handler in the AWS Lambda console.</p>
</div>
<div class="paragraph">
<p>However, I like to specify it in the console as well:</p>
</div>
<div class="paragraph">
<p><code>example.micronaut.BookRequestHandler</code></p>
</div>
<div class="paragraph">
<p>That value is exposed as an environment variable.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/handler.png" alt="handler">
</div>
</div>


<h2 id="test">3.4 Test</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-serverless-function-aws-lambda-graalvm/edit/master/src/main/docs/guide/lambda/test.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>You can test it easily.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/test-event.png" alt="test event">
</div>
</div>
<div class="paragraph">
<p>You should see a 200 response:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/test-result.png" alt="test result">
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/writingTheApp.html">&lt;&lt; <strong>2</strong><span>Writing the App</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/nextSteps.html"><strong>4</strong><span>Next Steps</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
