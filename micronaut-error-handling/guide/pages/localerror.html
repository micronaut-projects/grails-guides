<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2.2 Local @Error null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Error Handling
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/graal.html"><strong>3</strong><span>Generate a Micronaut app's Native Image with GraalVM</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/nextSteps.html"><strong>4</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/help.html"><strong>5</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/graal.html"><strong>3</strong><span>Generate a Micronaut app's Native Image with GraalVM</span> >></a></div>
                


                <div class="project">
                    <h1>2.2 Local @Error</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="localerror">2.2 Local @Error</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-error-handling/edit/master/src/main/docs/guide/writingTheApp/localerror.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut&#8217;s validation is built on with the standard framework – JSR 380, also known as Bean Validation 2.0.</p>
</div>
<div class="paragraph">
<p>Hibernate Validator is a reference implementation of the validation API. Starting with Micronaut 1.2, Micronaut
<a href="https://docs.micronaut.io/latest/guide/index.html#beanValidation">has built-in support for validation beans</a> that
are annotated with <code>javax.validation</code> annotations.</p>
</div>
<div class="paragraph">
<p><code>build.gradle</code> should contain the next snippet:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">annotationProcessor("io.micronaut:micronaut-validation")
implementation("io.micronaut:micronaut-validation")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then create a view to display a form:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/createbook.png" alt="createbook">
</div>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/bookscreate.vm</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Create Book&lt;/title&gt;
    &lt;style type="text/css"&gt;
        form fieldset li {
            list-style-type: none;
        }
        #errors span { color: red; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Create Book&lt;/h1&gt;
&lt;form action="/books/save" method="post"&gt;
    &lt;fieldset&gt;
        &lt;ol&gt;
            &lt;li&gt;
                &lt;label for="title"&gt;Title&lt;/label&gt;
                &lt;input type="text" id="title" name="title" value="$title"/&gt;
            &lt;/li&gt;
            &lt;li&gt;
                &lt;label for="pages"&gt;Pages&lt;/label&gt;
                &lt;input type="text" id="pages" name="pages" value="$pages"/&gt;
            &lt;/li&gt;
            &lt;li&gt;
                &lt;input type="submit" value="Save"/&gt;
            &lt;/li&gt;
        &lt;/ol&gt;
    &lt;/fieldset&gt;
&lt;/form&gt;
#if( $errors )
    &lt;ul id="errors"&gt;
        #foreach( $error in $errors )
            &lt;li&gt;&lt;span&gt;$error&lt;/span&gt;&lt;/li&gt;
        #end
    &lt;/ul&gt;
#end
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a controller to map the form submission:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/BookController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.HttpResponse;
import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.Body;
import io.micronaut.http.annotation.Consumes;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Error;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Post;
import io.micronaut.http.annotation.Produces;
import io.micronaut.views.View;

import javax.validation.ConstraintViolationException;
import javax.validation.Valid;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

@Controller("/books") <i class="conum" data-value="1"></i><b>(1)</b>
public class BookController {

    @View("bookscreate") <i class="conum" data-value="2"></i><b>(2)</b>
    @Get("/create") <i class="conum" data-value="3"></i><b>(3)</b>
    public Map&lt;String, Object&gt; create() {
        return createModelWithBlankValues();
    }

    @Consumes(MediaType.APPLICATION_FORM_URLENCODED) <i class="conum" data-value="4"></i><b>(4)</b>
    @Post("/save") <i class="conum" data-value="5"></i><b>(5)</b>
    public HttpResponse save(@Valid @Body CommandBookSave cmd) { <i class="conum" data-value="6"></i><b>(6)</b>
        return HttpResponse.ok();
    }

    private Map&lt;String, Object&gt; createModelWithBlankValues() {
        final Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();
        model.put("title", "");
        model.put("pages", "");
        return model;
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <code>@Controller</code> annotation mapped to the path <code>/books</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>@View</code> annotation to indicate the view name which should be used to render a view for the route.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can specify the HTTP verb that a controller’s action responds to. To respond to a GET request, use the <code>io.micronaut.http.annotation.Get</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>@Consumes</code> annotation takes a <code>String[]</code> of supported media types for an incoming request.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>@Post</code> annotation is used to map the index method to all requests that use an HTTP POST</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Add <code>@Valid</code> to any method parameter which requires validation. We use a POJO to encapsulate the form submission.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the POJO encapsulating the submission:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/BookController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.core.annotation.Introspected;

import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Positive;

@Introspected <i class="conum" data-value="1"></i><b>(1)</b>
public class CommandBookSave {
    @NotBlank <i class="conum" data-value="2"></i><b>(2)</b>
    private String title;

    @NotNull <i class="conum" data-value="3"></i><b>(3)</b>
    @Positive <i class="conum" data-value="4"></i><b>(4)</b>
    private Integer pages;

    public CommandBookSave() {
    }

    public String getTitle() {
        return title;
    }

    public void setTitle(String title) {
        this.title = title;
    }

    public Integer getPages() {
        return pages;
    }

    public void setPages(Integer pages) {
        this.pages = pages;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@Introspected</code> to generate the Bean Metainformation at compile time.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>title</code> is required and must be not blank.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>pages</code> is required.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>pages</code> must be greater than 0.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the form submission fails, we want to display the errors in the UI as the next image illustrates:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/createbookserrors.png" alt="createbookserrors">
</div>
</div>
<div class="paragraph">
<p>An easy way to achieve it is to capture the <code>javax.validation.ConstraintViolationException</code> exception in a local <code>@Error</code> handler. Modify <code>BookController.java</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/BookController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">...
class BookController {
...
..
    private final MessageSource messageSource;

    public BookController(MessageSource messageSource) { <i class="conum" data-value="1"></i><b>(1)</b>
        this.messageSource = messageSource;
    }
...
.
    @View("bookscreate")
    @Error(exception = ConstraintViolationException.class) <i class="conum" data-value="2"></i><b>(2)</b>
    public Map&lt;String, Object&gt; onSavedFailed(HttpRequest request, ConstraintViolationException ex) { <i class="conum" data-value="3"></i><b>(3)</b>
        final Map&lt;String, Object&gt; model = createModelWithBlankValues();
        model.put("errors", messageSource.violationsMessages(ex.getConstraintViolations()));
        Optional&lt;CommandBookSave&gt; cmd = request.getBody(CommandBookSave.class);
        cmd.ifPresent(bookSave -&gt; populateModel(model, bookSave));
        return model;
    }

    private void populateModel(Map&lt;String, Object&gt; model, CommandBookSave bookSave) {
        model.put("title", bookSave.getTitle());
        model.put("pages", bookSave.getPages());
    }


    private Map&lt;String, Object&gt; createModelWithBlankValues() {
        final Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();
        model.put("title", "");
        model.put("pages", "");
        return model;
    }
..
...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Constructor injection</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default <code>@Error</code> annotations are local. We specify the exception which we want to handle.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can access the original <code>HttpRequest</code> which triggered the exception.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a <code>javax.inject.Singleton</code> to encapsulate the generation of a list of messages from a <code>Set</code> of <code>ConstraintViolation</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/MessageSource.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import javax.inject.Singleton;
import javax.validation.ConstraintViolation;
import javax.validation.Path;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Singleton
public class MessageSource {

    public List&lt;String&gt; violationsMessages(Set&lt;ConstraintViolation&lt;?&gt;&gt; violations) {
        return violations.stream()
                .map(MessageSource::violationMessage)
                .collect(Collectors.toList());
    }

    private static String violationMessage(ConstraintViolation violation) {
        StringBuilder sb = new StringBuilder();
        Path.Node lastNode = lastNode(violation.getPropertyPath());
        if (lastNode != null) {
            sb.append(lastNode.getName());
            sb.append(" ");
        }
        sb.append(violation.getMessage());
        return sb.toString();
    }

    private static Path.Node lastNode(Path path) {
        Path.Node lastNode = null;
        for (final Path.Node node : path) {
            lastNode = node;
        }
        return lastNode;
    }
}</code></pre>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/graal.html"><strong>3</strong><span>Generate a Micronaut app's Native Image with GraalVM</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing.
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
