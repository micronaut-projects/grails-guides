<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>@Configuration and @ConfigurationBuilder | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='@Configuration and @ConfigurationBuilder. Learn how to utilize @Configuration and @ConfigurationBuilder annotations to effectively configure declared properties.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-configuration-kotlin/guide/index.html">@Configuration and @ConfigurationBuilder</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-configuration-kotlin"><img src="https://travis-ci.org/micronaut-guides/micronaut-configuration-kotlin.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-configuration-kotlin&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-configuration-kotlin.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-configuration-kotlin.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-configuration-kotlin.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-configuration-kotlin/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#howto"><strong>1.2</strong><span>How to complete the guide</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#configurationProperties"><strong>3</strong><span>Team Configuration with @ConfigurationProperties</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#configurationPropertiesTest"><strong>3.1</strong><span>Test @ConfigurationProperties</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#configurationBuilder"><strong>4</strong><span>Team Admin Builder with @ConfigurationBuilder</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#configurationBuilderTest"><strong>4.1</strong><span>Test @ConfigurationBuilder</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#eachProperty"><strong>5</strong><span>Stadiums with @EachProperty</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#eachPropertyTest"><strong>5.1</strong><span>Test @EachProperty</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>6</strong><span>Running the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#controller"><strong>7</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#graal"><strong>8</strong><span>Generating a Micronaut Application's Native Image with GraalVM</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#next"><strong>9</strong><span>Where To Go From Here?</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>@Configuration and @ConfigurationBuilder</h1>
        <p>Learn how to utilize @Configuration and @ConfigurationBuilder annotations to effectively configure declared properties.</p>
        <p><strong>Authors:</strong> Nirav Assar</p>
        <p><strong>Micronaut Version:</strong> 1.2.7</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this guide you are going to learn how to effectively use the annotations <code>@ConfigurationProperties</code>, <code>@ConfigurationBuilder</code>, and
<code>@EachProperty</code> to use configured properties in a Micronaut application. These annotations allow declared values to be injected
into a bean for easy usage in the application.</p>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="howto">1.2 How to complete the guide</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/howto.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-configuration-kotlin.git" class="bare">https://github.com/micronaut-guides/micronaut-configuration-kotlin.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheApp">2 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Kotlin Micronaut app using the <a href="http://docs.micronaut.io/snapshot/guide/index.html#cli">Micronaut Command Line Interface</a>.</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.complete --lang=kotlin</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a micronaut app with the default package <code>example.micronaut</code> in a folder named <code>complete</code>.</p>
</div>
<div class="paragraph">
<p>Due to the <code>--lang kotlin</code> flag, it generates a Kotlin Micronaut app that uses the <a href="http://gradle.org">Gradle</a> build system. However, you could use
other build tools such as <code>Maven</code> or other programming languages such as <code>Java</code> or <code>Groovy</code>.</p>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h1 id="configurationProperties">3 Team Configuration with @ConfigurationProperties</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/configurationProperties.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Imagine a feature where you can configure a sports team in a declarative manner. The team has a few attributes like team name, color,
and players.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">team:
  name: 'Steelers'
  color: 'Black'
  player-names:
    - 'Mason Rudolph'
    - 'James Connor'</code></pre>
</div>
</div>
<div class="paragraph">
<p>With Micronaut we can use the <code>@ConfigurationProperties</code> annotation to slurp the configuration into a bean. Each property that matches
the configuration in the <code>application.yml</code> will call the setter in the bean. The bean will be subsequently available for injection in the application!</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/TeamConfiguration.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.annotation.ConfigurationBuilder
import io.micronaut.context.annotation.ConfigurationProperties

@ConfigurationProperties("team")
class TeamConfiguration  {
    var name: String? = null
    var color: String? = null
    var playerNames: List&lt;String&gt;? = null
}</code></pre>
</div>
</div>


<h2 id="configurationPropertiesTest">3.1 Test @ConfigurationProperties</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/configurationPropertiesTest.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Let&#8217;s validate that the bean is available in the application context and is created with the values declared in the <code>application.xml</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/TeamConfigurationTest.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.kotlintest.shouldBe
import io.kotlintest.specs.BehaviorSpec
import io.micronaut.context.ApplicationContext
import io.micronaut.test.annotation.MicronautTest
import java.util.function.Consumer

@MicronautTest
class TeamConfigurationTest : BehaviorSpec({
    given("an application context started with configuration") {
        val names = listOf("Nirav Assar", "Lionel Messi")
        val items = mapOf("team.name" to "evolution",
                "team.color" to "green",
                "team.player-names" to names)
        val ctx = ApplicationContext.run(ApplicationContext::class.java, items) <i class="conum" data-value="1"></i><b>(1)</b>
        `when`("TeamConfiguration is retrieved from the context") {
            val teamConfiguration = ctx.getBean(TeamConfiguration::class.java)
            then("configuration properties are populated") {
                teamConfiguration.name shouldBe "evolution"
                teamConfiguration.color shouldBe "green"
                teamConfiguration.playerNames!!.size shouldBe names.size
                names.forEach(Consumer { name: String? -&gt; teamConfiguration.playerNames!!.contains(name) shouldBe true })
            }
        }
        ctx.close()
    }
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start application context with configuration</td>
</tr>
</table>
</div>


<h1 id="configurationBuilder">4 Team Admin Builder with @ConfigurationBuilder</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/configurationBuilder.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The Builder pattern is a great way to build configuration objects incrementally. Read about the Builder pattern in this
<a href="https://dzone.com/articles/design-patterns-the-builder-pattern">DZone</a> article to learn more.  Micronaut supports the Builder
pattern with <code>@ConfigurationBuilder</code>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s suppose we want to add team administrators to a team. The team administration is composed by using a builder pattern object.
We can add a coach, manager and president to the team.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">team:
  name: 'Steelers'
  color: 'Black'
  player-names:
    - 'Mason Rudolph'
    - 'James Connor'
  team-admin:
    manager: 'Nirav Assar' <i class="conum" data-value="1"></i><b>(1)</b>
    coach: 'Mike Tomlin'
    president: 'Dan Rooney'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>manager</code> property is an example of an element that will be built</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>TeamAdmin</code> object abides by the Builder pattern.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/TeamAdmin.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

class TeamAdmin private constructor(
        val manager: String?,
        val coach: String?,
        val president: String?) { <i class="conum" data-value="1"></i><b>(1)</b>
    data class Builder( <i class="conum" data-value="2"></i><b>(2)</b>
            var manager: String? = null,
            var coach: String? = null,
            var president: String? = null) {
        fun withManager(manager: String) = apply { this.manager = manager } <i class="conum" data-value="3"></i><b>(3)</b>
        fun withCoach(coach: String) = apply { this.coach = coach }
        fun withPresident(president: String) = apply { this.president = president }
        fun build() = TeamAdmin(manager, coach, president) <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>TeamAdmin</code> is the configuration object which consumes the declared properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The builder object is used to incrementally construct the object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An example of a builder method, where a attribute is set and then the builder itself is returned.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The final <code>build()</code> method creates the <code>TeamAdmin</code> object.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a test for the builder:</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/TeamAdminTest.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut;

import io.kotlintest.shouldBe
import io.kotlintest.specs.BehaviorSpec

class TeamAdminTest : BehaviorSpec({
    given("A Team Admin class") {
        `when`("A team admin is constructed with the Builder") {
            val teamAdmin = TeamAdmin.Builder().withManager("Nirav")
                    .withCoach("Tommy")
                    .withPresident("Mark").build()
            then("the team admin manager is populated") {
                teamAdmin.manager shouldBe "Nirav"
                teamAdmin.coach shouldBe "Tommy"
                teamAdmin.president shouldBe "Mark"
            }
        }
    }
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the bottom of <code>TeamConfiguration</code>, we add a <code>TeamAdmin.Builder</code> and annotate it with <code>@ConfigurationBuilder</code>.
This tells Micronaut that configuration can be read in and an object can be constructed using the Builder pattern.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are using the builder only here, so we will have to call <code>builder.build()</code> to actually get the <code>TeamAdmin</code> object, at a later time.
In our case, we will call <code>builder.build()</code> in the JUnit test.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/TeamConfiguration.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">    @ConfigurationBuilder(prefixes = ["with"], configurationPrefix = "team-admin") <i class="conum" data-value="1"></i><b>(1)</b>
    var builder = TeamAdmin.Builder() <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>prefixes</code> tells Micronaut to find methods that are prefixed by <code>with</code>; <code>configurationPrefix</code> allows the developer to customize the <code>application.yml</code> element</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instantiate the builder object so it can be populated with configuration values.</td>
</tr>
</table>
</div>


<h2 id="configurationBuilderTest">4.1 Test @ConfigurationBuilder</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/configurationBuilderTest.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We can validate <code>@ConfigurationBuilder</code> is applied properly with the following JUnit test. The test format is similar to previous tests.</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/TeamConfigurationBuilderTest.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.kotlintest.shouldBe
import io.kotlintest.specs.BehaviorSpec
import io.micronaut.context.ApplicationContext
import io.micronaut.test.annotation.MicronautTest
import java.util.function.Consumer

@MicronautTest
class TeamConfigurationBuilderTest : BehaviorSpec({
    given("an application context started with configuration") {
        val names = listOf("Nirav Assar", "Lionel Messi")
        val items = mapOf("team.name" to "evolution",
                "team.color" to "green",
                "team.team-admin.manager" to "Jerry Jones", <i class="conum" data-value="1"></i><b>(1)</b>
                "team.team-admin.coach" to "Tommy O'Neill",
                "team.team-admin.president" to "Mark Scanell",
                "team.player-names" to names)
        val ctx = ApplicationContext.run(ApplicationContext::class.java, items) <i class="conum" data-value="1"></i><b>(1)</b>
        `when`("TeamConfiguration is retrieved from the context") {
            val teamConfiguration = ctx.getBean(TeamConfiguration::class.java)
            then("configuration properties are populated") {
                teamConfiguration.name shouldBe "evolution"
                teamConfiguration.color shouldBe "green"
                teamConfiguration.playerNames!!.size shouldBe names.size
                names.forEach(Consumer { name: String? -&gt; teamConfiguration.playerNames!!.contains(name) shouldBe true })
                teamConfiguration.builder.manager shouldBe "Jerry Jones"
                teamConfiguration.builder.coach shouldBe "Tommy O'Neill"
                teamConfiguration.builder.president shouldBe "Mark Scanell"

                val teamAdmin = teamConfiguration.builder.build() <i class="conum" data-value="2"></i><b>(2)</b>
                teamAdmin.manager shouldBe "Jerry Jones" <i class="conum" data-value="3"></i><b>(3)</b>
                teamAdmin.coach shouldBe "Tommy O'Neill"
                teamAdmin.president shouldBe "Mark Scanell"
            }
        }
        ctx.close()
    }
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Properties which will invoke the builder methods on <code>TeamAdmin.Builder</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The builder object is now configured, so we must run <code>build()</code> on it to create the <code>TeamAdmin</code> object</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Verify the object is created with the <code>applicaton.yml</code> properties</td>
</tr>
</table>
</div>


<h1 id="eachProperty">5 Stadiums with @EachProperty</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/eachProperty.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut is also able to read a "list" of configurations that are related. Imagine we would like to declare stadiums and their
attributes.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yml" data-lang="yml">stadium:
  coors: <i class="conum" data-value="1"></i><b>(1)</b>
    city: 'Denver'
    size: 50000
  pnc:
    city: 'Pittsburgh'
    size: 35000</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This element will be the name of the bean.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can use <code>@EachProperty</code> which will cycle through the configuration and read each nested clause as a bean. The higher level
property will be parameterized as the name.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/StadiumConfiguration.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.annotation.EachProperty
import io.micronaut.context.annotation.Parameter
import io.micronaut.core.annotation.Introspected

@Introspected
@EachProperty("stadium") <i class="conum" data-value="1"></i><b>(1)</b>
class StadiumConfiguration
constructor(@param:Parameter val name: String) {  <i class="conum" data-value="2"></i><b>(2)</b>
    var city: String? = null
    var size: Int? = null
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Establish the top layer of configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>name</code> is read in from the property key and send as a parameter to the bean.</td>
</tr>
</table>
</div>


<h2 id="eachPropertyTest">5.1 Test @EachProperty</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/eachPropertyTest.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Validate the configuration with a test. Notice multiple beans are created from the configuration.  In a controller we can
inject a particular <code>StadiumConfiguration</code> instance bean by using the <code>@Named</code> parameter with qualifier name.</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/StadiumConfigurationTest.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.kotlintest.shouldBe
import io.kotlintest.specs.BehaviorSpec
import io.micronaut.context.ApplicationContext
import io.micronaut.inject.qualifiers.Qualifiers
import io.micronaut.test.annotation.MicronautTest

@MicronautTest
class StadiumConfigurationTest : BehaviorSpec({

    given("an application context started with configuration") {
        val items = mapOf("stadium.fenway.city" to "Boston", <i class="conum" data-value="1"></i><b>(1)</b>
                "stadium.fenway.size" to  60000,
                "stadium.wrigley.city" to  "Chicago", <i class="conum" data-value="1"></i><b>(1)</b>
                "stadium.wrigley.size" to 45000
        )
        val ctx = ApplicationContext.run(ApplicationContext::class.java, items)

        `when`("StadiumConfiguration are retrieved with bean qualifier") {
            val fenwayConfiguration = ctx.getBean(StadiumConfiguration::class.java, Qualifiers.byName("fenway"))  <i class="conum" data-value="2"></i><b>(2)</b>
            val wrigleyConfiguration = ctx.getBean(StadiumConfiguration::class.java, Qualifiers.byName("wrigley")) <i class="conum" data-value="2"></i><b>(2)</b>

            then("configuration properties are populated") {
                fenwayConfiguration.name shouldBe "fenway"
                fenwayConfiguration.size shouldBe 60000
                wrigleyConfiguration.name shouldBe "wrigley"
                wrigleyConfiguration.size shouldBe 45000
            }
        }

        ctx.close()
    }
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Multiple configurations can be declared for the same class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Since there are multiple beans to retrieve a bean a <code>Qualifier</code> must be sent.</td>
</tr>
</table>
</div>


<h1 id="runningTheApp">6 Running the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the application use the <code>./gradlew run</code> command which will start the application on port 8080.</p>
</div>


<h1 id="controller">7 Controller</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Configuration beans can be injected into the application with just like any other beans. As a demonstration,
create a controller where the beans are constructor injected. The <code>StadiumConfiguration</code> class has two
instances, so for injection we need to use the <code>@Named</code> annotation with a qualifier name to specify the bean.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/MyController.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import javax.inject.Named

@Controller("/my")
class MyController(val teamConfiguration: TeamConfiguration,
                   @Named("pnc") val stadiumConfiguration: StadiumConfiguration) {

    @Get("/team")
    fun team(): TeamConfiguration {
        return teamConfiguration
    }

    @Get("/stadium")
    fun stadium(): StadiumConfiguration {
        return stadiumConfiguration
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Injection of configuration beans; <code>@Named</code> annotation is needed to choose which <code>StadiumConfiguration</code> instance is retrieved.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the browser go to <a href="http://localhost:8080/my/team" class="bare">http://localhost:8080/my/team</a> and <a href="http://localhost:8080/my/stadium" class="bare">http://localhost:8080/my/stadium</a>.
</td>
</tr>
</table>
</div>


<h1 id="graal">8 Generating a Micronaut Application's Native Image with GraalVM</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/graal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are going to use <a href="https://www.graalvm.org">GraalVM</a>, the polyglot embeddable virtual machine, to generate a Native image
of our Micronaut application.</p>
</div>
<div class="paragraph">
<p>Native images compiled with GraalVM ahead-of-time improve the startup time and reduce the memory footprint of JVM-based
applications.</p>
</div>
<div class="paragraph">
<p>Micronaut itself does not rely on reflection or dynamic classloading so works automatically with GraalVM native.</p>
</div>
<div class="paragraph">
<p>First, add Micronaut Graal&#8217;s annotation processor that helps to handle generating the <code>reflection-config.json</code> metadata
that is automatically picked up by the <code>native-image</code> tool:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
..
.
    kapt "io.micronaut:micronaut-graal"
}</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>GraalVM Native Image allows you to ahead-of-time compile Java code to a standalone executable, called a native image.
This executable includes the application, the libraries, the JDK and does not run on the Java VM, but includes necessary
components like memory management and thread scheduling from a different virtual machine, called “Substrate VM”. Substrate
VM is the name for the runtime components (like the deoptimizer, garbage collector, thread scheduling etc.). The resulting
program has faster startup time and lower runtime memory overhead compared to a Java VM.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>We need to add a dependency to <code>svm</code>:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
..
.
    compileOnly "org.graalvm.nativeimage:svm:19.3.0"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To simplify building the image you need to create a <code>native-image.properties</code> file.
The convention is to use the folder <code>src/main/resources/META-INF/native-image</code> and then a folder following the maven coordinates of the application. For our example <code>example.micronaut/micronautguide</code>.</p>
</div>
<div class="paragraph">
<p>Add a <code>native-image.properties</code> inside  <code>src/main/resources/META-INF/native-image/example.micronaut/micronautguide</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/native-image/example.micronaut/micronautguide/native-image.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">Args = -H:IncludeResources=logback.xml|application.yml \
       -H:Name=micronautguide \
       -H:Class=example.micronaut.Application</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>-H:IncludeResources</code> argument allows you to tweak which static resources to include. You can use regular expressions.</p>
</li>
<li>
<p>The <code>-H:Name</code> argument specifies the name of the native image that will be generated.</p>
</li>
<li>
<p>The <code>-H:Class</code> argument specifies the entry point of your application (the class that defines a static void main method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The easiest way to install GraalVM is to use <a href="https://sdkman.io">SDKMan.io</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ sdk list java
================================================================================
Available Java Versions
================================================================================
 Vendor        | Use | Version      | Dist    | Status     | Identifier
--------------------------------------------------------------------------------
....
 GraalVM       |     | 19.3.0.r11   | grl     | installed  | 19.3.0.r11-grl
               |     | 19.3.0.r8    | grl     | installed  | 19.3.0.r8-grl
               |     | 19.2.1       | grl     |            | 19.2.1-grl
               |     | 19.1.1       | grl     |            | 19.1.1-grl
               |     | 19.0.2       | grl     |            | 19.0.2-grl


# For Java 8
$ sdk install java 19.3.0.r8-grl

# For Java 11
$ sdk install java 19.3.0.r11-grl</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to install the <code>native-image</code> component which is not installed by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ gu install native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>To generate the native image you need to generate the FAT JAR first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./gradlew assemble</code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoke <code>native-image</code>. It may take a minute to complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ which java
/Users/sdelamo/.sdkman/candidates/java/19.3.0.r8-grl/bin/java</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ native-image --no-server -cp build/libs/complete-0.1-all.jar
[micronautguide:39362]    classlist:   3,884.97 ms
[micronautguide:39362]        (cap):   5,919.80 ms
[micronautguide:39362]        setup:   7,222.88 ms
[micronautguide:39362]   (typeflow):  14,037.78 ms
[micronautguide:39362]    (objects):  17,689.40 ms
[micronautguide:39362]   (features):   1,751.37 ms
[micronautguide:39362]     analysis:  35,421.99 ms
[micronautguide:39362]     (clinit):     978.01 ms
[micronautguide:39362]     universe:   2,114.65 ms
[micronautguide:39362]      (parse):   2,327.75 ms
[micronautguide:39362]     (inline):   2,153.46 ms
[micronautguide:39362]    (compile):  13,066.94 ms
[micronautguide:39362]      compile:  19,714.97 ms
[micronautguide:39362]        image:   3,509.84 ms
[micronautguide:39362]        write:   1,114.96 ms
[micronautguide:39362]      [total]:  73,294.82 ms</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--no-server</code> options tells to not use server-based image building.</p>
</div>
<div class="paragraph">
<p>You can invoke the generated native image <code>micronautguide</code>. Startup will be really fast.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"> $ ./micronautguide -Xmx68m
07:42:20.792 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 21ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can invoke the controller exposed by the native image:</p>
</div>
<div class="paragraph">
<p><code>curl "http://localhost:8080/my/stadium"</code></p>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="paragraph">
<p><code>curl "http://localhost:8080/my/team"</code></p>
</div>
<div class="paragraph">
<p>Alternatively, you can use <code>Dockerfile</code>  to construct the native image and a script <code>docker-build.sh</code> to run it:</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">FROM oracle/graalvm-ce:19.3.0-java8 as graalvm
COPY . /home/app/micronautguide
WORKDIR /home/app/micronautguide
RUN gu install native-image
RUN native-image --no-server -cp build/libs/complete-*-all.jar

FROM frolvlad/alpine-glibc
EXPOSE 8080
COPY --from=graalvm /home/app/micronautguide /app/micronautguide
ENTRYPOINT ["/app/micronautguide","-Xmx68m"]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">docker-build.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/sh
docker build . -t micronautguide
echo
echo
echo "To run the docker container execute:"
echo "    $ docker run -p 8080:8080 micronautguide"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./gradlew assemble

$ ./docker-build.sh
Sending build context to Docker daemon  64.67MB
Step 1/9 : FROM oracle/graalvm-ce:19.3.0-java8 as graalvm
 ---&gt; d625000893c9
Step 2/9 : COPY . /home/app/micronautguide
 ---&gt; 4c0daf50c6f3
Step 3/9 : WORKDIR /home/app/micronautguide
 ---&gt; Running in e07cf22b668a
Removing intermediate container e07cf22b668a
 ---&gt; d3699ea8e284
Step 4/9 : RUN gu install native-image
 ---&gt; Running in 71edf17b9a11
Downloading: Component catalog from www.graalvm.org
Processing Component: Native Image
Downloading: Component native-image: Native Image  from github.com
Installing new component: Native Image (org.graalvm.native-image, version 19.3.0)
Refreshed alternative links in /usr/bin/
Removing intermediate container 71edf17b9a11
 ---&gt; ee26c71bbd1e
Step 5/9 : RUN native-image --no-server --static -cp build/libs/complete-*-all.jar
 ---&gt; Running in d2cd451f33be
[micronautguide:28]    classlist:   8,773.36 ms
[micronautguide:28]        (cap):   1,044.04 ms
[micronautguide:28]        setup:   2,748.03 ms
[micronautguide:28]   (typeflow):  20,611.56 ms
[micronautguide:28]    (objects):  20,377.15 ms
[micronautguide:28]   (features):   2,168.30 ms
[micronautguide:28]     analysis:  45,559.16 ms
[micronautguide:28]     (clinit):   1,141.31 ms
[micronautguide:28]     universe:   2,719.10 ms
[micronautguide:28]      (parse):   2,808.15 ms
[micronautguide:28]     (inline):   3,094.66 ms
[micronautguide:28]    (compile):  25,648.31 ms
[micronautguide:28]      compile:  34,018.50 ms
[micronautguide:28]        image:   3,811.46 ms
[micronautguide:28]        write:     643.59 ms
[micronautguide:28]      [total]:  99,095.08 ms
Removing intermediate container d2cd451f33be
 ---&gt; 429a467e2fdd
Step 6/9 : FROM frolvlad/alpine-glibc
 ---&gt; 38dd85a430e8
Step 7/9 : EXPOSE 8080
 ---&gt; Using cache
 ---&gt; 643f9d29e3f8
Step 8/9 : COPY --from=graalvm /home/app/micronautguide/micronautguide /app/micronautguide
 ---&gt; 0d41749e3ceb
Step 9/9 : ENTRYPOINT ["/app/micronautguide"]
 ---&gt; Running in 31b4c6c21e68
Removing intermediate container 31b4c6c21e68
 ---&gt; 3ff1de337ef4
Successfully built 3ff1de337ef4
Successfully tagged micronautguide:latest


To run the docker container execute:
    $ docker run -p 8080:8080 micronautguide</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use docker to run the image with the app&#8217;s native-image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"> docker run -p 8080:8080 micronautguide
06:58:26.977 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 27ms. Server Running: http://f8143044b1ee:8080</code></pre>
</div>
</div>


<h1 id="next">9 Where To Go From Here?</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-configuration-kotlin/edit/master/src/main/docs/guide/next.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Visit <a href="https://docs.micronaut.io/latest/guide/index.html#config">Micronaut Application Configuration</a> to learn more.</p>
</div>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
