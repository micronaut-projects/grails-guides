<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Micronaut JWT Authentication | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Micronaut JWT Authentication. Learn how to secure a Micronaut app using JWT (JSON Web Token) Authentication.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-security-jwt-kotlin/guide/index.html">Micronaut JWT Authentication</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-security-jwt-kotlin"><img src="https://travis-ci.org/micronaut-guides/micronaut-security-jwt-kotlin.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-security-jwt-kotlin&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-security-jwt-kotlin.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-security-jwt-kotlin.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-security-jwt-kotlin.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#dependency"><strong>2.1</strong><span>Security Dependency</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#configuration"><strong>2.2</strong><span>Configuration</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#authenticationProvider"><strong>2.3</strong><span>Authentication Provider</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>2.4</strong><span>Controllers</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#tests"><strong>3</strong><span>Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#oauth"><strong>3.1</strong><span>Token Refresh</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#jwt"><strong>3.2</strong><span>Use Micronaut's HTTP Client and JWT</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#testingTheApp"><strong>4</strong><span>Testing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>5</strong><span>Running the Application</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Micronaut JWT Authentication</h1>
        <p>Learn how to secure a Micronaut app using JWT (JSON Web Token) Authentication.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 1.0.0.M4</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut ships with security capabilities based on <a href="https://jwt.io/">Json Web Token (JWT)</a>. JWT is an <a href="https://tools.ietf.org/html/rfc7519">IETF standard</a> which defines a secure way to encapsulate arbitrary data that can be sent over unsecure URL’s.</p>
</div>
<div class="paragraph">
<p>In this guide you are going to create a Micronaut app and secure it with JWT.</p>
</div>
<div class="paragraph">
<p>The following sequence illustrates the authentication flow:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/jwt-bearer-token.svg" alt="jwt bearer token">
</div>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin.git" class="bare">https://github.com/micronaut-guides/micronaut-security-jwt-kotlin.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheApp">2 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Kotlin Micronaut app using the <a href="http://docs.micronaut.io/snapshot/guide/index.html#cli">Micronaut Command Line Interface</a>.</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.complete --features=kotlin</code></p>
</div>
<div class="paragraph">
<p>The previous command createas a micronaut app with the default package <code>example.micronaut</code> in a folder named <code>complete</code>.</p>
</div>
<div class="paragraph">
<p>Due to the <code>--features kotlin</code> flag, it generates a Kotlin Micronaut app and it uses <a href="http://gradle.org">Gradle</a> build system. However, you could use
other build tool such as <code>Maven</code> or other programming languages such as <code>Java</code> or <code>Groovy</code>.</p>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>
<div class="sect1">
<h2 id="_kotlin_kapt_and_intellij">Kotlin, Kapt and IntelliJ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As of this writing IntelliJ&#8217;s built-in compiler does not directly support Kapt and annotation processing. You must instead configure Intellij to run Gradle (or Maven) compilation as a build step before running your tests or application class.</p>
</div>
<div class="paragraph">
<p>First edit the run configuration for tests or for the application and select "Run Gradle task" as a build step:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/kotlin-run-1.png" alt="Intellij Settings" width="1024" height="768">
</div>
</div>
<div class="paragraph">
<p>Then add the <code>classes</code> task as task to execute for the application or for tests the <code>testClasses</code> task:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/kotlin-run-2.png" alt="Intellij Settings" width="1024" height="768">
</div>
</div>
<div class="paragraph">
<p>Now whenever you run tests or the application Micronaut classes will be generated at compilation time.</p>
</div>
<div class="paragraph">
<p>Read <a href="https://docs.micronaut.io/latest/guide/index.html#kotlin">Micronaut Kotlin</a> section to learn more.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can delegate IntelliJ build/run actions to gradle completely:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/delegatetogradle.png" alt="delegatetogradle">
</div>
</div>
</div>
</div>


<h2 id="dependency">2.1 Security Dependency</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/writingTheApp/dependency.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add Micronaut&#8217;s <code>security-jwt</code> dependency to your build file.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
..
.
    compile "io.micronaut:security-jwt"
}</code></pre>
</div>
</div>


<h2 id="configuration">2.2 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/writingTheApp/configuration.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the a new <code>application.yml</code> configuration file:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">micronaut:
  security:
    enabled: true <i class="conum" data-value="1"></i><b>(1)</b>
    endpoints:
      login:
        enabled: true <i class="conum" data-value="2"></i><b>(2)</b>
      oauth:
        enabled: true <i class="conum" data-value="3"></i><b>(3)</b>
    token:
      jwt:
        enabled: true <i class="conum" data-value="4"></i><b>(4)</b>
        signatures:
          secret:
            generator: <i class="conum" data-value="5"></i><b>(5)</b>
              secret: pleaseChangeThisSecretForANewOne <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable Micronaut&#8217;s security capabilities</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Expose <code>/login</code> endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Expose <code>/oauth/access_token</code> endpoint as defined by <a href="https://tools.ietf.org/html/rfc6749#section-6">section 6 of the OAuth 2.0 spec</a> - Refreshing an Access Token.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Enable JWT based authentication</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can create a <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/security/token/jwt/signature/secret/SecretSignatureConfiguration.html">SecretSignatureConfiguration</a> named <code>generator</code> via configuration as illustrated above. The <code>generator</code> signature is used to sign the issued JWT claims.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Change this by your own secret and keep it safe (do not store this in your VCS)</td>
</tr>
</table>
</div>


<h2 id="authenticationProvider">2.3 Authentication Provider</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/writingTheApp/authenticationProvider.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To keep this guide simple, create a naive <code>AuthenticationProvider</code> to simulate user&#8217;s authentication.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/services/AuthenticationProviderUserPassword.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut.services

import io.micronaut.security.authentication.AuthenticationProvider
import io.micronaut.security.authentication.AuthenticationRequest
import io.micronaut.security.authentication.AuthenticationResponse
import org.reactivestreams.Publisher
import io.micronaut.security.authentication.AuthenticationFailed
import io.reactivex.Flowable
import java.util.ArrayList
import io.micronaut.security.authentication.UserDetails
import javax.inject.Singleton

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class AuthenticationProviderUserPassword : AuthenticationProvider { <i class="conum" data-value="2"></i><b>(2)</b>
    override fun authenticate(authenticationRequest: AuthenticationRequest&lt;*, *&gt;?): Publisher&lt;AuthenticationResponse&gt; {
        if (authenticationRequest!=null &amp;&amp; authenticationRequest.identity != null &amp;&amp; authenticationRequest.secret != null) {
            if ( authenticationRequest.identity == "sherlock" &amp;&amp; authenticationRequest.secret == "password" ) {
                return Flowable.just&lt;AuthenticationResponse&gt;(UserDetails(authenticationRequest.identity as String, ArrayList()))
            }
        }
        return Flowable.just&lt;AuthenticationResponse&gt;(AuthenticationFailed())
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To register a Singleton in Micronaut&#8217;s application context, annotate your class with <code>javax.inject.Singleton</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A Micronaut&#8217;s Authentication Provider implements the interface <code>io.micronaut.security.authentication.AuthenticationProvider</code></td>
</tr>
</table>
</div>


<h2 id="controller">2.4 Controllers</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a file named <code>HomeController</code> which resolves the base URL <code>/</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/controllers/HomeController.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut.controllers

import io.micronaut.http.MediaType
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Produces
import io.micronaut.security.Secured
import java.security.Principal

@Secured("isAuthenticated()") <i class="conum" data-value="1"></i><b>(1)</b>
@Controller("/") <i class="conum" data-value="2"></i><b>(2)</b>
class HomeController {

    @Produces(MediaType.TEXT_PLAIN) <i class="conum" data-value="3"></i><b>(3)</b>
    @Get("/")  <i class="conum" data-value="4"></i><b>(4)</b>
    fun index(principal: Principal) : String {  <i class="conum" data-value="5"></i><b>(5)</b>
        return principal.name
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.http.annotation.Controller</code> to designate a class as a Micronaut&#8217;s controller.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By default a Micronaut’s response uses <code>application/json</code> as Content-Type. We are returning a String not a JSON object. Because of that, we set it to <code>text/plain</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can specify the HTTP verb that a controller&#8217;s action responds to. To respond to a GET request, use the <code>io.micronaut.http.annotation.Get</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If a user is authenticated, Micronaut will bind the user object to an argument of type <code>java.security.Principal</code> (if present).</td>
</tr>
</table>
</div>


<h1 id="tests">3 Tests</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/tests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In this tutorial, we use <a href="http://spekframework.org">Spek 2</a> to test the microservices:</p>
</div>
<div class="listingblock">
<div class="title">gradle.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">micronautVersion=1.0.0.M4
kotlinVersion=1.2.61
spekVersion=2.0.0-alpha.1
junitVersion=5.1.0</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">repositories {
...
..
    maven { url "https://dl.bintray.com/spekframework/spek-dev" }
}
dependencies {
    ...
    ..
    .
    testImplementation "org.jetbrains.kotlin:kotlin-test:$kotlinVersion"
    testImplementation "org.spekframework.spek2:spek-dsl-jvm:$spekVersion"
    testRuntimeOnly "org.spekframework.spek2:spek-runner-junit5:$spekVersion"
}

test {
    useJUnitPlatform {
        includeEngines 'spek2'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a test to verify a user is able to login and access a secured endpoint.</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/JwtAuthenticationSpec.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import com.nimbusds.jwt.JWTParser
import com.nimbusds.jwt.SignedJWT
import io.micronaut.context.ApplicationContext
import io.micronaut.http.HttpHeaders
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.RxHttpClient
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.runtime.server.EmbeddedServer
import io.micronaut.security.authentication.UsernamePasswordCredentials
import io.micronaut.security.token.jwt.render.BearerAccessRefreshToken
import org.spekframework.spek2.Spek
import org.spekframework.spek2.style.specification.describe
import kotlin.test.assertEquals
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

class BasicAuthSpec: Spek({
    describe("Verify JWT authentication works") {

        var embeddedServer : EmbeddedServer = ApplicationContext.run(EmbeddedServer::class.java) <i class="conum" data-value="1"></i><b>(1)</b>
        var client : RxHttpClient = RxHttpClient.create(embeddedServer.url) <i class="conum" data-value="2"></i><b>(2)</b>
        it("Accessing a secured URL without authenticating") {
            var exceptionThrown = false
            try {
                val request = HttpRequest.GET&lt;Any&gt;("/")
                client.toBlocking().exchange(request, String::class.java)
            } catch(e: HttpClientResponseException) {  <i class="conum" data-value="3"></i><b>(3)</b>
                exceptionThrown = true
            }
            assertTrue(exceptionThrown)
        }
        it("the endpoint can be access with JWT obtained when Login endpoint is called with valid credentials") {
            val creds = UsernamePasswordCredentials("sherlock", "password")
            val request = HttpRequest.POST("/login", creds) <i class="conum" data-value="4"></i><b>(4)</b>

            val rsp : HttpResponse&lt;BearerAccessRefreshToken&gt; = client.toBlocking().exchange(request,
                    BearerAccessRefreshToken::class.java) <i class="conum" data-value="5"></i><b>(5)</b>

            assertEquals(rsp.status()!!, HttpStatus.OK)
            assertNotNull(rsp.body()!!.accessToken)
            assertTrue(JWTParser.parse(rsp.body()!!.accessToken) is SignedJWT)
            assertNotNull(rsp.body()!!.refreshToken)
            assertNotNull(JWTParser.parse(rsp.body()!!.refreshToken) is SignedJWT)

            val accessToken : String = rsp.body()!!.accessToken
            val requestWithAuthorization = HttpRequest.GET&lt;Any&gt;("/" ).header(HttpHeaders.AUTHORIZATION, "Bearer $accessToken") <i class="conum" data-value="6"></i><b>(6)</b>
            val response : HttpResponse&lt;String&gt;  = client.toBlocking().exchange(requestWithAuthorization, String::class.java)

            assertEquals(response.status()!!, HttpStatus.OK)
            assertTrue(response.body()!! == "sherlock") <i class="conum" data-value="7"></i><b>(7)</b>
        }
        afterGroup {
            client.close()
            embeddedServer.close()
        }

    }
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To run the application from a unit test you can use the <a href="http://docs.micronaut.io/api/io/micronaut/runtime/server/EmbeddedServer.html">EmbeddedServer</a> interface</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register a <code>RxClient</code> bean in the application context and point it to the embedded server URL. The <code>EmbeddedServer</code> interface provides the URL of the server under test which runs on a random port.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Once you turn on security, every endpoint is secured by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To login, do a POST request to <code>/login</code> with your credentials as a JSON payload in the body of the request.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut makes it easy to parse JSON into Java objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Micronaut supports <a href="https://tools.ietf.org/html/rfc6750">RFC 6750 Bearer Token</a> specification out-of-the-box. We supply the JWT token in the <code>Authorization</code> HTTP Header.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Use .body() to retrieve the parsed payload.</td>
</tr>
</table>
</div>


<h2 id="oauth">3.1 Token Refresh</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/tests/oauth.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a new test to verify that token refreshing works as expected.</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/OauthAccessTokenSpec.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.RxHttpClient
import io.micronaut.runtime.server.EmbeddedServer
import io.micronaut.security.authentication.UsernamePasswordCredentials
import io.micronaut.security.token.jwt.endpoints.TokenRefreshRequest
import io.micronaut.security.token.jwt.render.AccessRefreshToken
import io.micronaut.security.token.jwt.render.BearerAccessRefreshToken
import org.spekframework.spek2.Spek
import org.spekframework.spek2.style.specification.describe
import java.lang.Thread.sleep
import kotlin.test.assertEquals
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

class OauthAccessTokenSpec: Spek({
    describe("Verify JWT access token refresh works") {

        var embeddedServer: EmbeddedServer = ApplicationContext.run(EmbeddedServer::class.java)
        var client: RxHttpClient = RxHttpClient.create(embeddedServer.url)

        it("you can refresh JWT access token with /oauth/access_token endpoint") {
            val creds = UsernamePasswordCredentials("sherlock", "password")
            val request = HttpRequest.POST("/login", creds)

            val rsp: HttpResponse&lt;BearerAccessRefreshToken&gt; = client.toBlocking().exchange(request,
                    BearerAccessRefreshToken::class.java)

            assertEquals(rsp.status()!!, HttpStatus.OK)

            val refreshToken: String = rsp.body()!!.refreshToken
            val accessToken: String = rsp.body()!!.accessToken
             sleep(1_000) // sleep for one second to give time for the issued at `iat` Claim to change
            val refreshTokenRequest: HttpRequest&lt;TokenRefreshRequest&gt; = HttpRequest.POST("/oauth/access_token",
                    TokenRefreshRequest("refresh_token", refreshToken)) <i class="conum" data-value="1"></i><b>(1)</b>
            val response: HttpResponse&lt;AccessRefreshToken&gt; = client.toBlocking().exchange(refreshTokenRequest, AccessRefreshToken::class.java)

            assertEquals(response.status()!!, HttpStatus.OK)
            assertNotNull(response.body()!!.accessToken)
            assertTrue(response.body()!!.accessToken != accessToken) <i class="conum" data-value="2"></i><b>(2)</b>
        }

        afterGroup {
            client.close()
            embeddedServer.close()
        }
    }
})
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make a POST request to <code>/oauth/access_token</code> with the refresh token in the JSON payload to get a new access token</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A different access token is retrieved.</td>
</tr>
</table>
</div>


<h2 id="jwt">3.2 Use Micronaut's HTTP Client and JWT</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/tests/jwt.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>If you want to access a secured endpoint, you can also use Micronaut&#8217;s HTTP Client and supply the JWT token in the Authorization header.</p>
</div>
<div class="paragraph">
<p>First create a <code>@Client</code> with a method <code>home</code> which accepts an <code>Authorization</code> HTTP Header.</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/AppClient.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Header
import io.micronaut.http.client.Client

@Client("/")
interface AppClient {

    @Get("/")
    fun home(@Header authorization: String): String
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a test which uses the previous <code>@Client</code></p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/DeclarativeHttpClientWithJwtSpec.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.RxHttpClient
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.runtime.server.EmbeddedServer
import io.micronaut.security.authentication.UsernamePasswordCredentials
import io.micronaut.security.token.jwt.render.BearerAccessRefreshToken
import org.spekframework.spek2.Spek
import org.spekframework.spek2.style.specification.describe

import kotlin.test.assertEquals
import kotlin.test.assertFalse
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

class DeclarativeHttpClientWithJwtSpec: Spek({
    describe("Verify JWT authentication works with declarative @Client") {

        var embeddedServer: EmbeddedServer = ApplicationContext.run(EmbeddedServer::class.java) <i class="conum" data-value="1"></i><b>(1)</b>
        var client: RxHttpClient = RxHttpClient.create(embeddedServer.url) <i class="conum" data-value="2"></i><b>(2)</b>

        var appClient : AppClient? = null
        it("AppClient Bean can be retrieved from Application context") {
            var exceptionThrown = false
            try {
                appClient = embeddedServer.applicationContext.getBean(AppClient::class.java) <i class="conum" data-value="3"></i><b>(3)</b>

            } catch(e: HttpClientResponseException) {
                exceptionThrown = true
            }
            assertFalse(exceptionThrown)
        }
        it("Accessing a secured URL without authenticating returns unauthorized") {
            var exceptionThrown = false
            try {
                val request = HttpRequest.GET&lt;Any&gt;("/")
                client.toBlocking().exchange(request, String::class.java)
            } catch(e: HttpClientResponseException) {
                exceptionThrown = true
            }
            assertTrue(exceptionThrown)
        }
        var accessToken: String? = null
        it("User can login") {
            val creds = UsernamePasswordCredentials("sherlock", "password")
            val request = HttpRequest.POST("/login", creds) <i class="conum" data-value="4"></i><b>(4)</b>

            val rsp: HttpResponse&lt;BearerAccessRefreshToken&gt; = client.toBlocking().exchange(request,
                    BearerAccessRefreshToken::class.java) <i class="conum" data-value="5"></i><b>(5)</b>

            assertEquals(rsp.status()!!, HttpStatus.OK)
            assertNotNull(rsp.body()!!.accessToken)

            accessToken = rsp.body()!!.accessToken <i class="conum" data-value="6"></i><b>(6)</b>
        }
        it("Access / endpoint with appClient") {
            var msg: String = appClient!!.home("Bearer ${accessToken!!}") <i class="conum" data-value="7"></i><b>(7)</b>
            assertTrue(msg == "sherlock")
        }

        afterGroup {
            client.close()
            embeddedServer.close()
        }
    }
})</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To run the application from a unit test you can use the <a href="http://docs.micronaut.io/api/io/micronaut/runtime/server/EmbeddedServer.html">EmbeddedServer</a> interface</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register a <code>RxClient</code> bean in the application context and point it to the embedded server URL. The <code>EmbeddedServer</code> interface provides the URL of the server under test which runs on a random port.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Retrieve <code>AppClient</code> bean from application context.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To login, do a POST request to <code>/login</code> with your credentials as a JSON payload in the body of the request.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut makes it easy to parse JSON into Java objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use .body() to retrieve the parsed payload.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Supply the JWT to the HTTP <code>Authorization</code> header value to the <code>@Client</code> method.</td>
</tr>
</table>
</div>


<h1 id="testingTheApp">4 Testing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/testingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./gradlew test
$ open build/reports/tests/test/index.html</code></pre>
</div>
</div>


<h1 id="runningTheApp">5 Running the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-security-jwt-kotlin/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the application use the <code>./gradlew run</code> command which will start the application on a random port.</p>
</div>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
