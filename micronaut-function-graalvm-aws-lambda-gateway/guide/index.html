<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Micronaut Functions in GraalVM Native Images deployed to AWS Lambda | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Micronaut Functions in GraalVM Native Images deployed to AWS Lambda. Learn how to deploy a GraalVM Image of a Micronaut Function to AWS Lambda' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-function-graalvm-aws-lambda-gateway/guide/index.html">Micronaut Functions in GraalVM Native Images deployed to AWS Lambda</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway"><img src="https://travis-ci.org/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Introduction</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you'll need to get started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#service"><strong>2.1</strong><span>PrimeFinderService</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>2.2</strong><span>PrimeFinderController</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#samLocal"><strong>3</strong><span>Running Lambda Locally via SAM</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#deployToLambda"><strong>4</strong><span>Deploying to AWS Lambda</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#setupApiGateway"><strong>5</strong><span>Connecting our Lambda to API Gateway</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#nextSteps"><strong>6</strong><span>Next Steps</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#help"><strong>7</strong><span>Help with Micronaut</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Micronaut Functions in GraalVM Native Images deployed to AWS Lambda</h1>
        <p>Learn how to deploy a GraalVM Image of a Micronaut Function to AWS Lambda</p>
        <p><strong>Authors:</strong> Will Buck</p>
        <p><strong>Micronaut Version:</strong> 1.2.6</p>
    </header>
    

<h1 id="gettingStarted">1 Introduction</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://aws.amazon.com/lambda/">AWS Lambda</a> is a dynamically scaled and billed-per-execution compute service. Instances of Lambdas are added and removed dynamically.</p>
</div>
<div class="paragraph">
<p>When a new instance handles its first request, the response time increases, which is called a cold start. After that request is processed, the instance stays alive (â‰ˆ10 m) to be reused for subsequent requests.</p>
</div>
<div class="paragraph">
<p>In the guide <a href="https://guides.micronaut.io/micronaut-function-aws-lambda/guide/index.html">Micronaut Functions deployed in AWS Lambda</a>, we used the <strong>Java runtime</strong>. Cold startups may cause some request to take more than 5 seconds.</p>
</div>
<div class="paragraph">
<p>To get rid of cold startups, in this guide, we combine several technologies:</p>
</div>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html"><strong>Lambda Proxy Integration in API Gateway</strong></a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In Lambda proxy integration, when a client submits an API request, API Gateway passes to the integrated Lambda function the raw request as-is.</p>
</div>
<div class="paragraph">
<p>This request data includes the request headers, query string parameters, URL path variables, payload, and API configuration data. The configuration data can include current deployment stage name, stage variables, user identity, or authorization context (if any).</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html"><strong>Custom AWS Lambda Runtimes</strong></a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A runtime is a program that runs a Lambda function&#8217;s handler method when the function is invoked. You can include a runtime in your function&#8217;s deployment package in the form of an executable file named bootstrap.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><a href="https://www.graalvm.org/docs/reference-manual/native-image/"><strong>GraalVM Native Images</strong></a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>GraalVM Native Image allows you to ahead-of-time compile Java code to a standalone executable, called a native image. This executable includes the application, the libraries, the JDK and does not run on the Java VM, but includes necessary components like memory management and thread scheduling from a different virtual machine. The resulting program has faster startup time and lower runtime memory overhead compared to a Java VM.</p>
</div>
</blockquote>
</div>


<h2 id="requirements">1.1 What you'll need to get started</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_you_will_also_want_the_following">You will also want the following:</h3>
<div class="ulist">
<ul>
<li>
<p>An AWS Account <a href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/">(here&#8217;s how to start one)</a></p>
</li>
<li>
<p>A local install of <a href="https://docs.docker.com/v17.09/engine/installation/">docker</a>, which is used to build the lambda</p>
</li>
<li>
<p>The Micronaut CLI tool, installed via</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>sdk install micronaut</code></p>
</div>
<div class="paragraph">
<p>(<a href="https://sdkman.io/install">Here&#8217;s a link to install sdkman if you don&#8217;t already have it</a>)</p>
</div>
</div>
<div class="sect2">
<h3 id="_you_may_also_optionally_want">You may also, optionally, want</h3>
<div class="ulist">
<ul>
<li>
<p>The AWS <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html">SAM CLI tool</a>, to test deploying the Lambda architecture locally (so there&#8217;s no surprises in AWS proper!)</p>
</li>
<li>
<p>The <a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html">AWS CLI tool</a>, which can be used to deploy your entire architecture from the command line</p>
</li>
</ul>
</div>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway.git" class="bare">https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheApp">2 Writing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Using <a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html">Lambda Proxy Integration in API Gateway</a> allows you to code a serveless application as you would normally code a traditional app, with controllers to handle HTTP requests.</p>
</div>
<div class="paragraph">
<p>Use the micronaut feature <code>aws-api-gateway-graal</code> to create an app ready to be deployed to AWS Lambda with Custom runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mn create-app example.micronaut.complete --features aws-api-gateway-graal</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>aws-api-gateway-graal</code> feature includes the <code>micronaut-function-aws-custom-runtime</code> dependency which includes the <code>MicronautLambdaRuntime</code> class, an implementation that you can use to execute a custom runtime as described in AWS documentation <a href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-walkthrough.html">Publishing a custom runtime</a>.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
    implementation("io.micronaut.aws:micronaut-function-aws-custom-runtime") {
        exclude group: "com.fasterxml.jackson.module", module: "jackson-module-afterburner"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, <code>aws-api-gateway-graal</code> feature includes the <code>micronaut-function-aws-api-proxy</code> dependency which adds the Micronaut support for the <a href="https://github.com/awslabs/aws-serverless-java-container">AWS Serverless Java Container</a> project.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
    implementation("io.micronaut.aws:micronaut-function-aws-api-proxy") {
        exclude group: "com.fasterxml.jackson.module", module: "jackson-module-afterburner"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, we have moved the dependencies (<code>micronaut-http-server-netty</code> and <code>micronaut-http-client</code>) to the test classpath. <strong>It is important to remove unused dependencies</strong>.
:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">dependencies {
...
    testImplementation "io.micronaut:micronaut-http-client"
    testImplementation "io.micronaut:micronaut-http-server-netty"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll be keeping it simple and creating a controller to find all the prime numbers less than N,
using the <a href="https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes">Sieve of Eratosthenes</a>.</p>
</div>


<h2 id="service">2.1 PrimeFinderService</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp/service.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Just as any other Micronaut app, we&#8217;ll want to isolate the "business logic"  of how we compute
the prime numbers to a service.</p>
</div>
<div class="paragraph">
<p>As we mentioned previously, the most efficient algorithm to calculate the primes below a given
number N is the <a href="https://en.wikipedia.org/wiki/Sieve_of_Eratosthenes">Sieve of Eratosthenes</a>, which
steps up from 2 to N and tosses out all the multiples of the given step, so that subsequent passes
are working with only the leftover numbers on the next pass.</p>
</div>
<div class="paragraph">
<p>See below for an adaption of
<a href="https://www.geeksforgeeks.org/sieve-eratosthenes-0n-time-complexity/">this O(n) java implementation of the algorithm</a></p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example.micronaut.PrimeFinderService.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import javax.inject.Singleton;
import java.util.ArrayList;
import java.util.List;
import java.util.Vector;

@Singleton
public class PrimeFinderService {
    // Credit to https://www.geeksforgeeks.org/sieve-eratosthenes-0n-time-complexity/
    // for this clever O(n) implementation of the Sieve
    public final int MAX_SIZE = 1000001;
    // isPrime[] : isPrime[i] is true if number is prime
    // prime[] : stores all prime number less than N
    // SPF[] that store smallest prime factor of number
    // [for Exp : smallest prime factor of '8' and '16'
    // is '2' so we put SPF[8] = 2 , SPF[16] = 2 ]
    private Vector&lt;Boolean&gt; isPrime = new Vector&lt;&gt;(MAX_SIZE);
    private Vector&lt;Integer&gt; SPF = new Vector&lt;&gt;(MAX_SIZE);

    public PrimeFinderService() {
        long startTime = System.currentTimeMillis();

        // Init the isPrime and SPF vectors
        for (int i = 0; i &lt; MAX_SIZE; i++) {
            isPrime.add(true);
            SPF.add(2);
        }
        // 0 and 1 are not prime
        isPrime.set(0, false);
        isPrime.set(1, false);
        long endTime = System.currentTimeMillis();
        System.out.println("Total execution time: " + (endTime-startTime) + "ms");
    }

    public List&lt;Integer&gt; findPrimesLessThan(int n) {
        // Fill in the rest of the entries
        List&lt;Integer&gt; prime = new ArrayList&lt;&gt;();
        for (int i = 2; i &lt; n; i++) {
            // If isPrime[i] == True then i is
            // prime number
            if (isPrime.get(i)) {
                // put i into prime[] vector
                prime.add(i);

                // A prime number is its own smallest
                // prime factor
                SPF.set(i, i);
            }

            // Remove all multiples of  i*prime[j] which are
            // not prime by making isPrime[i*prime[j]] = false
            // and put smallest prime factor of i*Prime[j] as prime[j]
            // [for exp :let  i = 5, j = 0, prime[j] = 2 [ i*prime[j] = 10]
            // so smallest prime factor of '10' is '2' that is prime[j] ]
            // this loop run only one time for number which are not prime
            for (int j = 0;
                 j &lt; prime.size() &amp;&amp;
                         i * prime.get(j) &lt; n &amp;&amp; prime.get(j) &lt;= SPF.get(i);
                 j++) {
                isPrime.set(i * prime.get(j), false);

                // put smallest prime factor of i*prime[j]
                SPF.set(i * prime.get(j), prime.get(j));
            }
        }
        return prime;
    }
}</code></pre>
</div>
</div>


<h2 id="controller">2.2 PrimeFinderController</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>So unlike the previous guide, this lambda operates just like a standard Micronaut app.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s add a small wrapper class for our responses.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example.micronaut.PrimeFinderResponse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.core.annotation.Introspected;

import java.util.List;

@Introspected
public class PrimeFinderResponse {

    private String message;
    private List&lt;Integer&gt; primes;

    public PrimeFinderResponse() {
    }

    public List&lt;Integer&gt; getPrimes() {
        return primes;
    }

    public void setPrimes(List&lt;Integer&gt; primes) {
        this.primes = primes;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, we&#8217;ll replace the <code>ExampleController.java</code> with with a <code>PrimeFinderController</code> that utilizes
our service from the previous step.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example.micronaut.PrimeFinderController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Controller("/") <i class="conum" data-value="1"></i><b>(1)</b>
public class PrimeFinderController {
    private static final Logger LOG = LoggerFactory.getLogger(PrimeFinderController.class); <i class="conum" data-value="2"></i><b>(2)</b>

    private final PrimeFinderService primeFinderService;

    public PrimeFinderController(PrimeFinderService primeFinderService) { <i class="conum" data-value="3"></i><b>(3)</b>
        this.primeFinderService = primeFinderService;
    }

    @Get("/find-primes-below/{number}")
    public PrimeFinderResponse findPrimesBelow(int number) {
        PrimeFinderResponse resp = new PrimeFinderResponse();
        if (number &gt;= primeFinderService.MAX_SIZE) {
            if (LOG.isInfoEnabled()) {
                LOG.info("This number is too big, you can't possibly want to know all the primes below a number this big.");
            }
            resp.setMessage("This service only returns lists for numbers below " + primeFinderService.MAX_SIZE);
            return resp;
        }
        if (LOG.isDebugEnabled()) {
            LOG.debug("Computing all the primes smaller than {} ...", number);
        }
        resp.setMessage("Success!");
        resp.setPrimes(primeFinderService.findPrimesLessThan(number));
        return resp;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Note this is just like a regular Micronaut controller, using the <code>@Controller</code> annotation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Be sure to add a <code>LOG</code> so that you will be able to see log output in CloudWatch</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We want to use constructor-based injection to get our <code>PrimeFinderService</code> in the controller</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ll also want to modify the <code>logback.xml</code> to set the DEBUG level for our <code>example.micronaut</code> package.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/logback.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;configuration&gt;

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;withJansi&gt;true&lt;/withJansi&gt;
        &lt;!-- encoders are assigned the type
             ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%cyan(%d{HH:mm:ss.SSS}) %gray([%thread]) %highlight(%-5level) %magenta(%logger{36}) - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level="info"&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
    &lt;/root&gt;
    &lt;logger name="example.micronaut" level="DEBUG"/&gt; &lt;!-- &lt;1&gt; --&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the line we need to add, that sets the log level to DEBUG for our package</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can test your servless app as you would normally test your app:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example.micronaut.PrimeFinderControllerTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.client.HttpClient;
import io.micronaut.http.client.annotation.Client;
import io.micronaut.runtime.server.EmbeddedServer;
import io.micronaut.test.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import javax.inject.Inject;

import java.util.Arrays;
import java.util.Collections;

import static org.junit.jupiter.api.Assertions.assertEquals;

@MicronautTest
public class PrimeFinderControllerTest {
    @Inject
    EmbeddedServer server;

    @Inject
    @Client("/")
    HttpClient client;

    @Test
    void testPrimesBelow3() {
        PrimeFinderResponse response = client.toBlocking()
                .retrieve(HttpRequest.GET("/find-primes-below/3"), PrimeFinderResponse.class);
        assertEquals(Collections.singletonList(2), response.getPrimes());
    }
}</code></pre>
</div>
</div>


<h1 id="samLocal">3 Running Lambda Locally via SAM</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/samLocal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This step is optional. To follow along, you&#8217;ll need the
<a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html">AWS SAM CLI tool</a>
installed locally.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <strong>S</strong> erverless <strong>A</strong> pplication <strong>M</strong> odel, or <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html">SAM</a>,
is a framework for defining an application using a serverless architecture.</p>
</div>
<div class="paragraph">
<p>It is also a CLI tool provided by Amazon to mock the AWS environment locally.</p>
</div>
<div class="paragraph">
<p>This is going to allow us to run our Micronaut app as a graal native image, within an AWS Lambda custom runtime, all on our own machine.</p>
</div>
<div class="paragraph">
<p>The Micronaut team have provided a simple shell script in the <code>aws-api-gateway-graal</code> feature called <code>sam-local.sh</code>, which
builds the app into a Graal native image via Docker and packages it with the required <code>bootstrap</code> file for AWS Lambda custom runtimes into a simple <code>zip</code>.</p>
</div>
<div class="paragraph">
<p>It then executes the SAM CLI tool with the (also included) <code>sam.yaml</code> file, which describes the Cloudformation architecture of our Serverless
application (in this case, it is simple one endpoint, run via Lambda and triggered via the API Gateway)</p>
</div>
<div class="listingblock">
<div class="title">prime-finder/sam-local.sh</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/sh
docker build . -t prime-finder <i class="conum" data-value="1"></i><b>(1)</b>
mkdir -p build
docker run --rm --entrypoint cat prime-finder  /home/application/function.zip &gt; build/function.zip <i class="conum" data-value="2"></i><b>(2)</b>

sam local start-api -t sam.yaml -p 3000 <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We build the application zip in a docker container (see the dockerfile below)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This extracts the <code>function.zip</code> file built by the docker container to the <code>build/</code> directory, for use by <code>sam-local</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is the command to run our infrastructure locally</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Try running this yourself, via</p>
</div>
<div class="paragraph">
<p><code>./sam-local.sh</code></p>
</div>
<div class="paragraph">
<p>And then (after some time, building the native image in docker and orchestrating the SAM environment can take a couple minutes),
try <code>curl</code> ing your endpoint (it should start up on port 3000 within the SAM docker container, forwarded to your machine)</p>
</div>
<div class="paragraph">
<p><code>curl localhost:3000/find-primes-below/999</code></p>
</div>


<h1 id="deployToLambda">4 Deploying to AWS Lambda</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/deployToLambda.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Now it&#8217;s time to try things out in AWS!</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;ve included a <code>deploy.sh</code> file that takes care of all of the lambda deployment, if you&#8217;d prefer that to the web-based AWS Console.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First we need to build the <code>zip</code> file that comprises our AWS Lambda custom runtime
(if you followed along with the previous section, you can skip this as <code>sam-local.sh</code> already did it for you).</p>
</div>
<div class="listingblock">
<div class="title">Building the Function.zip deployable</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">docker build . -t prime-finder
mkdir -p build
docker run --rm --entrypoint cat prime-finder  /home/application/function.zip &gt; build/function.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we&#8217;ll want to navigate to <a href="https://console.aws.amazon.com/lambda/home" class="bare">https://console.aws.amazon.com/lambda/home</a> and click <code>Create function</code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/lambda-1-create-fn.png" alt="lambda 1 create fn">
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll be prompted for some inputs, so fill out the "Function name" as "prime-finder" and choose the "Runtime" to be
"Custom runtime &#8594; Provide your own bootstrap" under</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/lambda-2-create-inputs.png" alt="lambda 2 create inputs">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/lambda-3-create-custom-runtime-detail.png" alt="lambda 3 create custom runtime detail">
</div>
</div>
<div class="paragraph">
<p>Now under "Permissions" at the bottom, we&#8217;ll need to create a new lambda execution role. AWS can take care of this for you,
just select the first radio button!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/lambda-4-create-role.png" alt="lambda 4 create role">
</div>
</div>
<div class="paragraph">
<p>You should be brought to a new page to finish configuring the detail of your new "prime-finder" lambda.</p>
</div>
<div class="paragraph">
<p>Next we need to upload the <code>function.zip</code> file that docker placed in our <code>build/</code> directory using the "Code entry type" dropdown.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/lambda-5-add-code-zip.png" alt="lambda 5 add code zip">
</div>
</div>
<div class="paragraph">
<p>Finally, we have to click "Save" up in the top right, and wait for the zip to finish uploading,
which may take 20-30 seconds.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/lambda-6-wait-for-save.png" alt="lambda 6 wait for save">
</div>
</div>
<div class="paragraph">
<p>And we have our lambda! Clicking "Test" on this page isn&#8217;t going to do much of anything, as we still need the second piece of the puzzle.</p>
</div>


<h1 id="setupApiGateway">5 Connecting our Lambda to API Gateway</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/setupApiGateway.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Let&#8217;s get our Lambda an API Gateway trigger!</p>
</div>
<div class="paragraph">
<p>Navigate to <a href="https://console.aws.amazon.com/apigateway/home" class="bare">https://console.aws.amazon.com/apigateway/home</a> and click on the "Get Started" button in the middle of the screen.
If you&#8217;ve created an API Gateway in the past, you&#8217;ll instead need to click "Create API" in the top right.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll be presented with an Example API, but we want to create our own. Select the "New API" radio and give the API a name, then click "Create API"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-1-create-inputs.png" alt="gateway 1 create inputs">
</div>
</div>
<div class="paragraph">
<p>Now that we have our API, we need to create a catch-all "proxy" resource for our Lambda (we want our Micronaut app to handle routing).</p>
</div>
<div class="paragraph">
<p>Use the "Actions" dropdown and select "Create Resource"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-2-create-resource.png" alt="gateway 2 create resource">
</div>
</div>
<div class="paragraph">
<p>Checking the "Configure as proxy resource" checkbox will automatically fill in the name and path, then we just need to click "Create Resource"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-3-proxy.png" alt="gateway 3 proxy">
</div>
</div>
<div class="paragraph">
<p>Next we need to connect this API to our lambda.</p>
</div>
<div class="paragraph">
<p>"Lambda Function Proxy" should already be selected, so just start typing our lambda&#8217;s name in the in the
"Lambda Function" autocomplete box and select it once it pops up. Then click "Save"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-4-connect-lambda.png" alt="gateway 4 connect lambda">
</div>
</div>
<div class="paragraph">
<p>At this point, we can use the AWS console to test out triggering our API, using the "Test" button on the left hand side of
resource visualization.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-5-test-the-api.png" alt="gateway 5 test the api">
</div>
</div>
<div class="paragraph">
<p>As our app is expecting <code>GET</code> requests at <code>/find-primes-below/{number}</code>, that&#8217;s how we&#8217;ll fill in the test details.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-6-test-details.png" alt="gateway 6 test details">
</div>
</div>
<div class="paragraph">
<p>You should receive a 200 response with the list of primes.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-7-test-success.png" alt="gateway 7 test success">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you get an error, check the "Path" input box to ensure it matches the path of your controller method, and check
the Lambda config to ensure the function zip uploaded successfully.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;re almost to the finish line now! We&#8217;ve confirmed that everything works properly, but our API is not yet publicly accessible.</p>
</div>
<div class="paragraph">
<p>To make that happen, we need to "Deploy" our API. From the "Actions" dropdown, select "Deploy API"</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-8-deploy-api.png" alt="gateway 8 deploy api">
</div>
</div>
<div class="paragraph">
<p>APIs can be deployed in "Stages". Commonly you might have a "test" and "prod" stage where changes would naturally propagate,
but for the purposes of this guide we&#8217;ll just create one new stage called "demo".</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-9-deploy-details.png" alt="gateway 9 deploy details">
</div>
</div>
<div class="paragraph">
<p>Click "Deploy", and we should get the URL for our newly deployed API!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-10-deploy-success-url-display.png" alt="gateway 10 deploy success url display">
</div>
</div>
<div class="paragraph">
<p>Now we can use any API client we like to test our new url.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/gateway-11-curl.png" alt="gateway 11 curl">
</div>
</div>
<div class="paragraph">
<p>Congratulations! You&#8217;ve got yourself your first Micronaut GraalVM API with AWS!</p>
</div>


<h1 id="nextSteps">6 Next Steps</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-graalvm-aws-lambda-gateway/edit/master/src/main/docs/guide/nextSteps.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read more about <a href="https://docs.micronaut.io/latest/guide/index.html#serverlessFunctions">Serverless Functions</a> inside Micronaut.</p>
</div>
<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-aws/latest/guide/index.html#lambda">Micronaut Lambda support</a> within Micronaut.</p>
</div>
<div class="paragraph">
<p>Learn more <a href="https://docs.micronaut.io/latest/guide/index.html#graal">Micronaut for GraalVM</a> integration.</p>
</div>


<h1 id="help">7 Help with Micronaut</h1>

    <h3 style="color: #333; margin-bottom:25px;"><a href="https://objectcomputing.com/" target="_blank">Object Computing, Inc.</a> (OCI) sponsored the creation of this Guide. A variety of consulting and support services are available.</h3>

    <!--[if lte IE 8]>
    <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
    <![endif]-->
    <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
    <script>
        hbspt.forms.create({
            portalId: "4547412",
            formId: "24edfcbb-b6f2-4fcf-af48-35ab6271031e"
        });
    </script>

    <h3 style="color: #333;">OCI is Home to Micronaut.</h3>

    <p><a href="https://objectcomputing.com/products/2gm-team" target="_blank">Meet the Team</a></p>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
