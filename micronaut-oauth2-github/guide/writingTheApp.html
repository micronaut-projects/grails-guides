<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2 Writing the App null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Secure a Micronaut app with Github
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/learnmore.html"><strong>4</strong><span>Learn More</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>5</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span> >></a></div>
                


                <div class="project">
                    <h1>2 Writing the App</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#views"><strong>2.1</strong><span>Views</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#home"><strong>2.2</strong><span>Home</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#oauth2"><strong>2.3</strong><span>Github OAuth App</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#oauthconfig"><strong>2.4</strong><span>OAuth 2.0 Configuration</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#mapper"><strong>2.5</strong><span>User Details Mapper</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#github"><strong>2.6</strong><span>Retrieve User Github repositories</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an app using the <a href="http://docs.micronaut.io/snapshot/guide/index.html#cli">Micronaut Command Line Interface</a>.</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.complete</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a micronaut app with the default package <code>example.micronaut</code> in a folder named <code>complete</code>.</p>
</div>
<div class="paragraph">
<p>By default, <code>create-app</code> creates a Java Micronaut app that uses the <a href="http://gradle.org">Gradle</a> build system. However, you could use
other build tools such as <code>Maven</code> or other programming languages such as <code>Groovy</code> or <code>Kotlin</code>.</p>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="views">2.1 Views</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/views.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Although Micronaut is primarily designed around message encoding / decoding, there are occasions where it is convenient to render a view on the server side.</p>
</div>
<div class="paragraph">
<p>To use <a href="https://www.thymeleaf.org/">Thymeleaf</a> Java template engine within a Micronaut Application  add the following dependency on your classpath. For example, in <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    implementation("io.micronaut.views:micronaut-views-thymeleaf")
}</code></pre>
</div>
</div>


<h2 id="home">2.2 Home</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/home.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a controller to handle the requests to <code>/</code>. You are going to display the email of the authenticated person if any. Annotate the controller endpoint with <code>@View</code> since we are going to use a Thymeleaf template.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/HomeController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.rules.SecurityRule;
import io.micronaut.views.View;

import java.util.HashMap;
import java.util.Map;

@Controller
public class HomeController {

    @Secured(SecurityRule.IS_ANONYMOUS)
    @View("home")
    @Get
    public Map&lt;String, Object&gt; index() {
        return new HashMap&lt;&gt;();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>SecurityRule.IS_ANONYMOUS</code> expression will allow access without authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <a href="https://docs.micronaut.io/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template would you like to render the response against.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="http://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation is used to map the <code>index</code> method to GET <code>/</code> requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a thymeleaf template:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/home.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;title&gt;Home&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Micronaut - Github example&lt;/h1&gt;

&lt;h2 th:if="${security}"&gt;username: &lt;span th:text="${security.name}"&gt; &lt;/h2&gt;
&lt;h2 th:unless="${security}"&gt;username: Anonymous&lt;/h2&gt;

&lt;nav&gt;
    &lt;ul&gt;
        &lt;li th:unless="${security}"&gt;&lt;a href="/oauth/login/github"&gt;Enter&lt;/a&gt;&lt;/li&gt;
        &lt;li th:if="${security}"&gt;&lt;a href="/repos"&gt;View Repos&lt;/a&gt;&lt;/li&gt;
        &lt;li th:if="${security}"&gt;&lt;a href="/logout"&gt;Logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/nav&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, note that we return an empty model in the controller. However, we are accessing <code>security</code> in the thymeleaf template.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/views/model/security/SecurityViewModelProcessor.html">SecurityViewModelProcessor</a>
injects into the model a <code>security</code> map with the authenticated user.  See
<a href="https://micronaut-projects.github.io/micronaut-views/latest/guide/index.html#views-security">User in a view</a> documentation.</p>
</li>
</ul>
</div>


<h2 id="oauth2">2.3 Github OAuth App</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/oauth2.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To provide authentication, create a <a href="https://developer.github.com/apps/about-apps/">Github Oauth App</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/github-1.png" alt="github 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/github-2.png" alt="github 2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/github-3.png" alt="github 3">
</div>
</div>


<h2 id="oauthconfig">2.4 OAuth 2.0 Configuration</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/oauthconfig.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To use OAuth 2.0 integration, add the next dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    implementation("io.micronaut.security:micronaut-security-oauth2")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following Oauth2 Configuration:
Add also JWT <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#jwt">Micronautâ€™s JWT support</a> dependencies:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    annotationProcessor("io.micronaut.security:micronaut-security-annotations")
    implementation("io.micronaut.security:micronaut-security-jwt")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following Oauth2 Configuration:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronaut:
micronaut:
  security:
    authentication: cookie <i class="conum" data-value="1"></i><b>(1)</b>
    token:
      jwt:
        signatures:
          secret:
            generator: <i class="conum" data-value="2"></i><b>(2)</b>
              secret: '"${JWT_GENERATOR_SIGNATURE_SECRET:pleaseChangeThisSecretForANewOne}"' <i class="conum" data-value="3"></i><b>(3)</b>
    oauth2:
      clients:
        github: <i class="conum" data-value="4"></i><b>(4)</b>
          client-id:  '${OAUTH_CLIENT_ID}' <i class="conum" data-value="5"></i><b>(5)</b>
          client-secret: '${OAUTH_CLIENT_SECRET}' <i class="conum" data-value="6"></i><b>(6)</b>
          scopes: <i class="conum" data-value="7"></i><b>(7)</b>
            - user:email
            - read:user
            - public_repo
          authorization:
            url: 'https://github.com/login/oauth/authorize' <i class="conum" data-value="8"></i><b>(8)</b>
          token:
            url: 'https://github.com/login/oauth/access_token' <i class="conum" data-value="9"></i><b>(9)</b>
            auth-method: client-secret-post
    endpoints:
      logout:
        get-allowed: true <i class="conum" data-value="10"></i><b>(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Once validated, we are going to save the ID Token in a Cookie. To read in subsequent requests, set <code>micronaut.security.authentication</code> to <code>cookie</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can create a <a href="http://docs.micronaut.io/latest/api/io/micronaut/security/token/jwt/signature/secret/SecretSignatureConfiguration.html">SecretSignatureConfiguration</a> named <code>generator</code> via configuration as illustrated above. The <code>generator</code> signature is used to sign the issued JWT claims.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Change this by your own secret and keep it safe (do not store this in your VCS).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The provider identifier should match the last part of the url you entered as a redirect url <code>/oauth/callback/github</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Client Secret. See previous screenshot.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Client ID. See previous screenshot.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Specify the scopes you want to request. <a href="https://developer.github.com/apps/building-oauth-apps/understanding-scopes-for-oauth-apps/">Github Scopes</a> let you sepcify exactly what type of access you need.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Map manually the Github&#8217;s <a href="https://tools.ietf.org/html/rfc6749#section-3.1">Authorization endpoint</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Map manually the Github&#8217;s <a href="https://tools.ietf.org/html/rfc6749#section-3.2">Token endpoint</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Accept GET request to the <code>/logout</code> endpoint.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous configuration uses several placeholders. You will need to setup <code>OAUTH_CLIENT_ID</code>, <code>OAUTH_CLIENT_SECRET</code> environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export OAUTH_CLIENT_ID=XXXXXXXXXX
export OAUTH_CLIENT_SECRET=YYYYYYYYYY</pre>
</div>
</div>


<h2 id="mapper">2.5 User Details Mapper</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/mapper.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Here is a high level diagram of how the authorization code grant flow works with an OAuth 2.0 provider such as Github.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/standard-oauth.svg" alt="standard oauth">
</div>
</div>
<div class="paragraph">
<p>We need an HTTP Client to retrieve the user info. Create a POJO to represent a Github user:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubUser.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import com.fasterxml.jackson.databind.PropertyNamingStrategy;
import com.fasterxml.jackson.databind.annotation.JsonNaming;
import io.micronaut.core.annotation.Introspected;

@Introspected
public class GithubUser {

    private String login;
    private String name;
    private String email;

    public GithubUser() {

    }

    public String getLogin() {
        return login;
    }

    public void setLogin(String login) {
        this.login = login;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create a Micronaut Declarative HTTP Client to consume <a href="https://developer.github.com/v3/">Github REST API v3</a></p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubApiClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpHeaders;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Header;
import io.micronaut.http.annotation.QueryValue;
import io.micronaut.http.client.annotation.Client;
import io.reactivex.Flowable;

import javax.annotation.Nullable;
import javax.validation.constraints.Pattern;
import java.util.List;

@Header(name = "User-Agent", value = "https://micronautguides.com")
@Header(name = "Accept", value = "application/vnd.github.v3+json, application/json") <i class="conum" data-value="1"></i><b>(1)</b>
@Client(id = "githubv3")
public interface GithubApiClient {

    @Get("/user") <i class="conum" data-value="3"></i><b>(3)</b>
    Flowable&lt;GithubUser&gt; getUser( <i class="conum" data-value="4"></i><b>(4)</b>
            @Header(HttpHeaders.AUTHORIZATION) String authorization); <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Github encourages to explicitly request the version 3 via the Accept header. With <code>@Header</code>, you add the <code>Accept: application/vnd.github.v3+json</code> HTTP header to every request.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add the id <code>githubv3</code> to the <code>@Client</code> annotation. Later, you will provide url for this client id.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define a HTTP GET request to <code>/user</code> endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can return reactive types in a Micronaut declarative HTTP client.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can specify that a parameter binds to a HTTP Header such as the <strong>Authorization</strong> header.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Specify the url for the <code>githubv3</code> service.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronaut:
  http:
    services:
      githubv3:
        url: "https://api.github.com"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Github we need to provide a UserDetails Mapper. The easiest way is to create a bean which implements <code>OauthUserDetailsMapper</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubUserDetailsMapper.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;
import io.micronaut.security.authentication.UserDetails;
import io.micronaut.security.oauth2.endpoint.token.response.OauthUserDetailsMapper;
import io.micronaut.security.oauth2.endpoint.token.response.TokenResponse;
import org.reactivestreams.Publisher;

import javax.inject.Named;
import javax.inject.Singleton;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Named("github") <i class="conum" data-value="1"></i><b>(1)</b>
@Singleton
public class GithubUserDetailsMapper implements OauthUserDetailsMapper {

    public static final String TOKEN_PREFIX = "token ";
    public static final String ROLE_GITHUB = "ROLE_GITHUB";
    private final GithubApiClient apiClient;

    public GithubUserDetailsMapper(GithubApiClient apiClient) {
        this.apiClient = apiClient;
    }

    @Override
    public Publisher&lt;UserDetails&gt; createUserDetails(TokenResponse tokenResponse) {
        return apiClient.getUser(TOKEN_PREFIX + tokenResponse.getAccessToken()) <i class="conum" data-value="2"></i><b>(2)</b>
                .map(user -&gt; new UserDetails(user.getLogin(),
                        Collections.singletonList(ROLE_GITHUB),
                        Collections.singletonMap(OauthUserDetailsMapper.ACCESS_TOKEN_KEY, tokenResponse.getAccessToken()))); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usa a name qualifier for the bean which matches the name you used in the OAuth 2.0 configuration in <code>application.yml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Consume the <code>/user</code> endpoint with the Micronaut HTTP Client.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Save the original Github access token in a claim. We will use to to contact Github&#8217;s api later.</td>
</tr>
</table>
</div>


<h2 id="github">2.6 Retrieve User Github repositories</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-github/edit/master/src/main/docs/guide/writingTheApp/github.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>With the access token, we retrieved during the login we are going to contact the Github API to fetch the user&#8217;s repositories.</p>
</div>
<div class="paragraph">
<p>First, create a POJO to represent a Github repository:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/GithubRepo.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.core.annotation.Introspected;

@Introspected
public class GithubRepo {

    private String name;

    public GithubRepo() {

    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a method to <code>GithubApiClient</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">....
public interface GithubApiClient {
....
    @Get("/user/repos{?sort,direction}") <i class="conum" data-value="1"></i><b>(1)</b>
    List&lt;GithubRepo&gt; repos(
            @Pattern(regexp = "created|updated|pushed|full_name") @Nullable @QueryValue String sort, <i class="conum" data-value="2"></i><b>(2)</b>
            @Pattern(regexp = "asc|desc") @Nullable @QueryValue String direction, <i class="conum" data-value="2"></i><b>(2)</b>
            @Header(HttpHeaders.AUTHORIZATION) String authorization);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Specify two query values <code>sort</code> and <code>direction</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate <code>sort</code> and <code>direction</code> as <code>@Nullable</code> since they are optional. You can restrict the allowed values with use of constraints.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a controller to expose <code>/repos</code> endpoint:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/ReposController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpHeaderValues;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.authentication.Authentication;
import io.micronaut.security.oauth2.endpoint.token.response.OauthUserDetailsMapper;
import io.micronaut.security.rules.SecurityRule;
import io.micronaut.views.View;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Controller("/repos") <i class="conum" data-value="1"></i><b>(1)</b>
public class ReposController {

    public static final String CREATED = "created";
    public static final String DESC = "desc";
    public static final String REPOS = "repos";
    private final GithubApiClient githubApiClient;

    public ReposController(GithubApiClient githubApiClient) {
        this.githubApiClient = githubApiClient;
    }

    @Secured(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
    @View("repos") <i class="conum" data-value="3"></i><b>(3)</b>
    @Get <i class="conum" data-value="4"></i><b>(4)</b>
    Map&lt;String, Object&gt; index(Authentication authentication) {
        List&lt;GithubRepo&gt; repos = githubApiClient.repos(CREATED, DESC, authorizationValue(authentication));  <i class="conum" data-value="5"></i><b>(5)</b>
        Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();
        model.put(REPOS, repos);
        return model;
    }

    private String authorizationValue(Authentication authentication) {
        String authorization = null;
        Object claim = authentication.getAttributes().get(OauthUserDetailsMapper.ACCESS_TOKEN_KEY);  <i class="conum" data-value="6"></i><b>(6)</b>
        if (claim instanceof String) {
            authorization = HttpHeaderValues.AUTHORIZATION_PREFIX_BEARER + " " + claim.toString();
        }
        return authorization;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Qualify the <code>@Controller</code> annotation with <code>/repos</code> to designate the endpoint url.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We want this endpoint to be only accessible to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We specify the view name <code>repos</code> which is used to render the model.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare a GET endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Consume the Github API.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use the previously obtained access token to get access against the Github API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a thymeleaf template:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/repos.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;title&gt;Home&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;&lt;a href="/"&gt;Home&lt;/a&gt; &amp;rarr; Repositories&lt;/h1&gt;
&lt;nav&gt;
    &lt;ul th:each="repo: ${repos}"&gt;
        &lt;li th:text="${repo.name}"/&gt;
    &lt;/ul&gt;
&lt;/nav&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
