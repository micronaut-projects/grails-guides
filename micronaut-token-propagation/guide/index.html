<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Micronaut Token Propagation | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Micronaut Token Propagation. Learn how to leverage token propagation in Micronaut to simplify your code while keeping your microservices secure.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-token-propagation/guide/index.html">Micronaut Token Propagation</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-token-propagation"><img src="https://travis-ci.org/micronaut-guides/micronaut-token-propagation.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-token-propagation&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-token-propagation.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-token-propagation.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-token-propagation.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-token-propagation/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>2</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#intermediateGateway"><strong>2.1</strong><span>Gateway</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#intermediateUserecho"><strong>2.2</strong><span>User Echo</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tokenPropagation"><strong>2.3</strong><span>Token Propagation</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>3</strong><span>Running the App</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#graal"><strong>4</strong><span>Generate a Micronaut app's Native Image with GraalVM</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#graalchanges"><strong>4.1</strong><span>Micronaut + GraalVM changes</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#graalnativeimage"><strong>4.2</strong><span>Native Image generation</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#graalexecute"><strong>4.3</strong><span>Execute Native Images</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#graaldocker"><strong>4.4</strong><span>Native Image generation with Docker</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#nextSteps"><strong>5</strong><span>Next Steps</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#help"><strong>6</strong><span>Help with Micronaut</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Micronaut Token Propagation</h1>
        <p>Learn how to leverage token propagation in Micronaut to simplify your code while keeping your microservices secure.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 2.0.0.RC1</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This guide uses Micronaut 2.x. You can <a href="https://guides.micronaut.io/1.x/micronaut-guides/micronaut-token-propagation/index.html">read this tutorial for Micronaut 1.x.</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lets describe the microservices you are going to build through the tutorial.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>gateway</code> - A secured via JWT microservice which exposes an endpoint <code>/user</code>. The output of that endpoint is the result of consuming the <code>userecho</code> endpoint.</p>
</li>
<li>
<p><code>userecho</code> - A secured via JWT microservice which exposes an endpoint <code>/user</code> which responds the username of the authenticated user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next diagram illustrates the flow:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/tokenpropagation.svg" alt="tokenpropagation">
</div>
</div>
<div class="paragraph">
<p>We generate valid JWT in the gateway microservice. Then every microservice in our app is able to validate those JWT. We want every internal request to contain a valid JWT token. If we want to talk to another microservice we need to propagate the valid JWT get received.</p>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-token-propagation/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-token-propagation.git" class="bare">https://github.com/micronaut-guides/micronaut-token-propagation.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are going to write the app first without token propagation. Then we are going to configure token propagation and you will see how much code we can get rid of.</p>
</div>


<h2 id="intermediateGateway">2.1 Gateway</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/writingTheApp/intermediateGateway.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.gateway</code></p>
</div>
<div class="paragraph">
<p>Add the security-jwt module to the configuration:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">annotationProcessor "io.micronaut.security:micronaut-security-annotations"
implementation "io.micronaut.security:micronaut-security-jwt"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To keep this guide simple, create a naive AuthenticationProvider to simulate user’s authentication.</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/AuthenticationProviderUserPassword.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import edu.umd.cs.findbugs.annotations.Nullable;
import io.micronaut.http.HttpRequest;
import io.micronaut.security.authentication.AuthenticationException;
import io.micronaut.security.authentication.AuthenticationFailed;
import io.micronaut.security.authentication.AuthenticationProvider;
import io.micronaut.security.authentication.AuthenticationRequest;
import io.micronaut.security.authentication.AuthenticationResponse;
import io.micronaut.security.authentication.UserDetails;
import io.reactivex.BackpressureStrategy;
import io.reactivex.Flowable;
import org.reactivestreams.Publisher;

import javax.inject.Singleton;
import java.util.Collections;

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
public class AuthenticationProviderUserPassword implements AuthenticationProvider { <i class="conum" data-value="2"></i><b>(2)</b>

    @Override
    public Publisher&lt;AuthenticationResponse&gt; authenticate(@Nullable HttpRequest&lt;?&gt; httpRequest, AuthenticationRequest&lt;?, ?&gt; authenticationRequest) {
        return Flowable.create(emitter -&gt; {
            if ((authenticationRequest.getIdentity().equals("sherlock") || authenticationRequest.getIdentity().equals("watson")) &amp;&amp;
                    authenticationRequest.getSecret().equals("password")) {
                emitter.onNext(new UserDetails((String) authenticationRequest.getIdentity(), Collections.emptyList()));
                emitter.onComplete();
            } else {
                emitter.onError(new AuthenticationException(new AuthenticationFailed()));
            }

        }, BackpressureStrategy.ERROR);

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To register a Singleton in Micronaut’s application context, annotate your class with <code>javax.inject.Singleton</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A Micronaut’s Authentication Provider implements the interface <code>io.micronaut.security.authentication.AuthenticationProvider</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a class <code>UserController</code> which exposes <code>/user</code> endpoint.</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/UserController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Header;
import io.micronaut.http.annotation.Produces;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.rules.SecurityRule;
import io.reactivex.Single;

@Controller("/user") <i class="conum" data-value="1"></i><b>(1)</b>
public class UserController {

    private final UsernameFetcher usernameFetcher;

    public UserController(UsernameFetcher usernameFetcher) {  <i class="conum" data-value="2"></i><b>(2)</b>
        this.usernameFetcher = usernameFetcher;
    }

    @Secured(SecurityRule.IS_AUTHENTICATED)  <i class="conum" data-value="3"></i><b>(3)</b>
    @Produces(MediaType.TEXT_PLAIN) <i class="conum" data-value="4"></i><b>(4)</b>
    @Get <i class="conum" data-value="5"></i><b>(5)</b>
    Single&lt;String&gt; index(@Header("Authorization") String authorization) {  <i class="conum" data-value="6"></i><b>(6)</b>
        return usernameFetcher.findUsername(authorization);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>io.micronaut.http.annotation.Controller</code> to designate a class as a Micronaut’s controller.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor dependency injection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Since we return a string which is not valid JSON, set the media type to <code>text/plain</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can specify the HTTP verb that a controller&#8217;s action responds to. To respond to a GET request, use the <code>io.micronaut.http.annotation.Get</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can bind an Http Header to a controller method argument.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an interface to encapsulate the collaboration with the <code>userecho</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/UsernameFetcher.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.annotation.Header;
import io.reactivex.Single;

public interface UsernameFetcher {
    Single&lt;String&gt; findUsername(@Header("Authorization") String authorization);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a Micronaut HTTP Declarative client:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/UserEchoClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;
import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.Consumes;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Header;
import io.micronaut.http.client.annotation.Client;
import io.reactivex.Single;

@Client(id = "userecho") <i class="conum" data-value="1"></i><b>(1)</b>
@Requires(notEnv = Environment.TEST) <i class="conum" data-value="2"></i><b>(2)</b>
public interface UserEchoClient extends UsernameFetcher {

    @Override
    @Consumes(MediaType.TEXT_PLAIN)
    @Get("/user") <i class="conum" data-value="3"></i><b>(3)</b>
    Single&lt;String&gt; findUsername(@Header("Authorization") String authorization); <i class="conum" data-value="4"></i><b>(4)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@Client</code> annotation is used with a service id. We will reference the exact service id in the configuration shortly.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Don&#8217;t load this bean in the Test environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <code>@Get</code> annotation to define the client mapping</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Supply the JWT to the HTTP Authorization header value to the <code>@Client</code> method.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add this snippet to <code>application.yml</code> to configure the service url of the <code>echo</code> service</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">---
micronaut:
  http:
    services:
      userecho: <i class="conum" data-value="1"></i><b>(1)</b>
        urls:
          - "http://localhost:8081" <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the same service ID we used in the <code>@Client</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure a URL where the <code>userecho</code> microservice resides.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add this snippet to <code>application.yml</code> to configure security:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">---
micronaut:
  security:
    authentication: bearer <i class="conum" data-value="1"></i><b>(1)</b>
    token:
      jwt:
        signatures:
          secret:
            generator: <i class="conum" data-value="2"></i><b>(2)</b>
              secret: '"${JWT_GENERATOR_SIGNATURE_SECRET:pleaseChangeThisSecretForANewOne}"' <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>authentication</code> to <code>bearer</code> to receive a JSON response from the login endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can create a SecretSignatureConfiguration named generator via configuration as illustrated above. The generator signature is used to sign the issued JWT claims.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Change this by your own secret and keep it safe (do not store this in your VCS)</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_tests">Tests</h3>
<div class="paragraph">
<p>Provide a <code>UsernameFetcher</code> bean replacement for the Test environment.</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/test/java/example/micronaut/UserEchoClientReplacement.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;
import io.micronaut.http.annotation.Header;
import io.reactivex.Single;

import javax.inject.Singleton;

@Requires(env = Environment.TEST)
@Singleton
public class UserEchoClientReplacement implements UsernameFetcher {

    @Override
    public Single&lt;String&gt; findUsername(@Header("Authorization") String authorization) {
        return Single.just("sherlock");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a tests which verifies the app is secured and we can access it after login in:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/test/java/example/micronaut/UserControllerTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.HttpRequest;
import io.micronaut.http.HttpStatus;
import io.micronaut.http.client.RxHttpClient;
import io.micronaut.http.client.annotation.Client;
import io.micronaut.http.client.exceptions.HttpClientResponseException;
import io.micronaut.security.authentication.UsernamePasswordCredentials;
import io.micronaut.security.token.jwt.render.BearerAccessRefreshToken;
import io.micronaut.test.annotation.MicronautTest;
import org.junit.jupiter.api.Test;

import javax.inject.Inject;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
public class UserControllerTest {

    @Inject
    @Client("/")
    RxHttpClient client; <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    public void testUserEndpointIsSecured() { <i class="conum" data-value="3"></i><b>(3)</b>
        HttpClientResponseException thrown = assertThrows(HttpClientResponseException.class, () -&gt; {
            client.toBlocking().exchange(HttpRequest.GET("/user"));
        });

        assertEquals(HttpStatus.UNAUTHORIZED, thrown.getResponse().getStatus());
    }

    @Test
    public void testAuthenticatedCanFetchUsername() {
        UsernamePasswordCredentials credentials = new UsernamePasswordCredentials("sherlock", "password");
        HttpRequest request = HttpRequest.POST("/login", credentials);

        BearerAccessRefreshToken bearerAccessRefreshToken = client.toBlocking().retrieve(request, BearerAccessRefreshToken.class);

        String username = client.toBlocking().retrieve(HttpRequest.GET("/user")
                .header("Authorization", "Bearer " + bearerAccessRefreshToken.getAccessToken()), String.class);

        assertEquals("sherlock", username);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> to let Micronaut starts the embedded server and inject the beans. More info: <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html">https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>RxHttpClient</code> bean in the application context.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Test endpoint is secured</td>
</tr>
</table>
</div>
</div>


<h2 id="intermediateUserecho">2.2 User Echo</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/writingTheApp/intermediateUserecho.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the microservice:</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.userecho</code></p>
</div>
<div class="paragraph">
<p>Add the security-jwt module to the configuration:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">annotationProcessor("io.micronaut.security:micronaut-security-annotations")
implementation("io.micronaut.security:micronaut-security-jwt")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a class <code>UserController</code> which exposes <code>/user</code> endpoint.</p>
</div>
<div class="listingblock">
<div class="title">userecho/src/main/java/example/micronaut/UserController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Produces;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.rules.SecurityRule;

import java.security.Principal;

@Controller("/user") <i class="conum" data-value="1"></i><b>(1)</b>
public class UserController {

    @Secured(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
    @Produces(MediaType.TEXT_PLAIN) <i class="conum" data-value="3"></i><b>(3)</b>
    @Get <i class="conum" data-value="4"></i><b>(4)</b>
    String index(Principal principal) { <i class="conum" data-value="5"></i><b>(5)</b>
        return principal.getName();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>io.micronaut.http.annotation.Controller</code> to designate a class as a Micronaut’s controller.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Since we return a string which is not valid JSON, set the media type to <code>text/plain</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can specify the HTTP verb that a controller&#8217;s action responds to. To respond to a GET request, use the <code>io.micronaut.http.annotation.Get</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If a user is authenticated, Micronaut will bind the user object to an argument of type <code>java.security.Principal</code> (if present).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add this snippet to <code>application.yml</code> to fix the port where <code>userecho</code> starts:</p>
</div>
<div class="listingblock">
<div class="title">userecho/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">---
micronaut:
  server:
    port: 8081 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure a fix port where the app listens.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add this snippet to <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">userecho/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">---
micronaut:
  security:
    token:
      jwt:
        signatures:
          secret:
            validation: <i class="conum" data-value="2"></i><b>(2)</b>
              secret: '"${JWT_GENERATOR_SIGNATURE_SECRET:pleaseChangeThisSecretForANewOne}"' <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can create a <code>SecretSignatureConfiguration</code> named <code>validation</code> which is able to validate JWT generated by the <code>gateway</code> microservice.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Change this by your own secret and keep it safe (do not store this in your VCS)</td>
</tr>
</table>
</div>


<h2 id="tokenPropagation">2.3 Token Propagation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/writingTheApp/tokenPropagation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>As you can see propagating the JWT token to other microservices in our app complicates the code.
We need to capture the <code>Authorization</code> header in the controller method arguments and then pass it to the <code>@Client</code> bean.
In an app with several controllers and declarative clients, it can lead to a lot of repetition. Fortunately, Micronaut
includes a feature called token propagation. We can tell our app to propagate the incoming token to a set of outgoing requests.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s configure token propagation. We need to modify <code>application.yml</code> in the <code>gateway</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">---
micronaut:
  security:
    token:
      propagation:
        enabled: true <i class="conum" data-value="1"></i><b>(1)</b>
        service-id-regex: "userecho" <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable token propagation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We only want to propagate the token to certain services. We can create a regular expression to match those services ids.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can simplify the code:</p>
</div>
<div class="paragraph">
<p>Edit <code>UserController.java</code> and remove the <code>@Header</code> parameter:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/UserController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.annotation.Produces;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.rules.SecurityRule;
import io.reactivex.Single;

@Controller("/user")
public class UserController {

    private final UsernameFetcher usernameFetcher;

    public UserController(UsernameFetcher usernameFetcher) {
        this.usernameFetcher = usernameFetcher;
    }

    @Secured(SecurityRule.IS_AUTHENTICATED)
    @Produces(MediaType.TEXT_PLAIN)
    @Get
    Single&lt;String&gt; index() {
        return usernameFetcher.findUsername();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>UsernameFetcher.java</code> and remove the <code>@Header</code> parameter:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/UsernameFetcher.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.reactivex.Single;

public interface UsernameFetcher {
    Single&lt;String&gt; findUsername();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>UserEchoClient.java</code> and remove the <code>@Header</code> parameter:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/main/java/example/micronaut/UserEchoClient.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;
import io.micronaut.http.MediaType;
import io.micronaut.http.annotation.Consumes;
import io.micronaut.http.annotation.Get;
import io.micronaut.http.client.annotation.Client;
import io.reactivex.Single;

@Client(id = "userecho")
@Requires(notEnv = Environment.TEST)
public interface UserEchoClient extends UsernameFetcher {

    @Consumes(MediaType.TEXT_PLAIN)
    @Get("/user")
    Single&lt;String&gt; findUsername();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>UserEchoClientReplacement.java</code> and remove the <code>@Header</code> parameter:</p>
</div>
<div class="listingblock">
<div class="title">gateway/src/test/java/example/micronaut/UserEchoClientReplacement.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.context.annotation.Requires;
import io.micronaut.context.env.Environment;
import io.reactivex.Single;

import javax.inject.Singleton;

@Requires(env = Environment.TEST)
@Singleton
public class UserEchoClientReplacement implements UsernameFetcher {

    @Override
    public Single&lt;String&gt; findUsername() {
        return Single.just("sherlock");
    }
}</code></pre>
</div>
</div>


<h1 id="runningTheApp">3 Running the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Run both microservices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">userecho $ ./gradlew run
&gt; Task :complete/userecho:run
18:29:26.500 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 671ms. Server Running: http://localhost:8081
&lt;=========----&gt; 75% EXECUTING [10s]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">gateway $ ./gradlew run

&gt; Task :complete/gateway:run
18:28:35.723 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 707ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do cURL command to authenticate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">curl -X "POST" "http://localhost:8080/login" \
     -H 'Content-Type: application/json; charset=utf-8' \
     -d $'{
  "username": "sherlock",
  "password": "password"
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">{"username":"sherlock","access_token":"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJzaGVybG9jayIsIm5iZiI6MTUzNzk3OTQxNSwicm9sZXMiOltdLCJpc3MiOiJnYXRld2F5IiwiZXhwIjoxNTM3OTgzMDE1LCJpYXQiOjE1Mzc5Nzk0MTV9.HkMhguhW-cbT7u_3vL-eWxn9MbPgR1vTRjDYqvfl8Vc","refresh_token":"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJzaGVybG9jayIsIm5iZiI6MTUzNzk3OTQxNSwicm9sZXMiOltdLCJpc3MiOiJnYXRld2F5IiwiaWF0IjoxNTM3OTc5NDE1fQ.LNpA-v45_6xPCB0MOMXd9QArWhCJS8C0AYpRj6Kj4-E","expires_in":3600,"token_type":"Bearer"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can call the <code>/user</code> endpoint supplying the access token in the Authorization header.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">`curl "http://localhost:8080/user" -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJzaGVybG9jayIsIm5iZiI6MTUzNzk3OTQxNSwicm9sZXMiOltdLCJpc3MiOiJnYXRld2F5IiwiZXhwIjoxNTM3OTgzMDE1LCJpYXQiOjE1Mzc5Nzk0MTV9.HkMhguhW-cbT7u_3vL-eWxn9MbPgR1vTRjDYqvfl8Vc'`
sherlock</code></pre>
</div>
</div>


<h1 id="graal">4 Generate a Micronaut app's Native Image with GraalVM</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/graal.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We are going to use <a href="https://www.graalvm.org">GraalVM</a>, the polyglot embeddable virtual machine, to generate a Native image
of our Micronaut application.</p>
</div>
<div class="paragraph">
<p>Native images compiled with GraalVM ahead-of-time improve the startup time and reduce the memory footprint of JVM-based
applications.</p>
</div>


<h2 id="graalchanges">4.1 Micronaut + GraalVM changes</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/graal/graalchanges.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut itself does not rely on reflection or dynamic classloading so works automatically with GraalVM native.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>GraalVM Native Image allows you to ahead-of-time compile Java code to a standalone executable, called a native image. This executable includes the application, the libraries, the JDK and does not run on the Java VM, but includes necessary components like memory management and thread scheduling from a different virtual machine, called “Substrate VM”. Substrate VM is the name for the runtime components (like the deoptimizer, garbage collector, thread scheduling etc.). The resulting program has faster startup time and lower runtime memory overhead compared to a Java VM.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>We are going to add Micronaut Graal’s annotation processor and <code>svm</code> to both application builds. It helps to handle generating the <code>reflection-config.json</code> metadata that is automatically picked up by the native-image tool.</p>
</div>
<div class="paragraph">
<p>Also, to simplify building the image you need to create a <code>native-image.properties</code> file. The convention is to use the folder <code>src/main/resources/META-INF/native-image</code> and then a folder following the maven coordinates of the application.</p>
</div>
<div class="sect1">
<h2 id="_changes_to_gateway_to_generate_a_graalvm_native_image">Changes to gateway to generate a GraalVM native image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Modify <code>gateway/build.gradle</code>, add the annotation processor and <code>svm</code> dependency:</p>
</div>
<div class="listingblock">
<div class="title">gateway/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">    annotationProcessor("io.micronaut:micronaut-graal")
    compileOnly("org.graalvm.nativeimage:svm")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a <code>native-image.properties</code> inside <code>src/main/resources/META-INF/native-image/example.micronaut/gateway</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/native-image/example.micronaut/gateway/native-image.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Args = -H:Name=gateway \
       -H:Class=example.micronaut.Application</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>-H:IncludeResources</code> argument allows you to tweak which static resources to include. You can use regular expressions.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>-H:Name</code> argument specifies the name of the native image that will be generated.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>-H:Class</code> argument specifies the entry point of your application (the class that defines a static void main method).</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changes_to_userecho_to_generate_a_graalvm_native_image">Changes to userecho to generate a GraalVM native image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Modify <code>userecho/build.gradle</code>, add the annotation processor and <code>svm</code> dependency:</p>
</div>
<div class="listingblock">
<div class="title">userecho/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy"></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a <code>native-image.properties</code> inside <code>src/main/resources/META-INF/native-image/example.micronaut/userecho</code> folder.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/META-INF/native-image/example.micronaut/userecho/native-image.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Args = -H:Name=userecho \
       -H:Class=example.micronaut.Application</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>-H:IncludeResources</code> argument allows you to tweak which static resources to include. You can use regular expressions.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>-H:Name</code> argument specifies the name of the native image that will be generated.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>-H:Class</code> argument specifies the entry point of your application (the class that defines a static void main method).</td>
</tr>
</table>
</div>
</div>
</div>


<h2 id="graalnativeimage">4.2 Native Image generation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/graal/graalnativeimage.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The easiest way to install GraalVM is to use <a href="https://sdkman.io">SDKMan.io</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ sdk list java
================================================================================
Available Java Versions
================================================================================
 Vendor        | Use | Version      | Dist    | Status     | Identifier
--------------------------------------------------------------------------------
....
 GraalVM       |     | 20.1.0.r11   | grl     | installed  | 20.1.0.r11-grl
               |     | 20.1.0.r8    | grl     |            | 20.1.0.r8-grl
               |     | 20.0.0.r11   | grl     |            | 20.0.0.r11-grl
               |     | 20.0.0.r8    | grl     | installed  | 20.0.0.r8-grl
               |     | 19.3.1.r11   | grl     | installed  | 19.3.1.r11-grl
               |     | 19.3.1.r8    | grl     |            | 19.3.1.r8-grl
....

# For Java 8
$ sdk install java 20.1.0.r8-grl

# For Java 11
$ sdk install java 20.1.0.r11-grl</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to install the <code>native-image</code> component which is not installed by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ gu install native-image</code></pre>
</div>
</div>
<div class="sect1">
<h2 id="_generate_graalvm_native_image_for_userecho">Generate GraalVM native image for userecho</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To generate the native image you need to generate the FAT JAR first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">userecho $ ./gradlew assemble</code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoke native-image. It may take a minute to complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">userecho $  native-image --no-server -cp build/libs/userecho-0.1-all.jar
[userecho:14552]    classlist:   8,403.72 ms
[userecho:14552]        (cap):   2,196.75 ms
[userecho:14552]        setup:   3,163.33 ms
[userecho:14552]   (typeflow):  14,912.31 ms
[userecho:14552]    (objects):  17,479.74 ms
[userecho:14552]   (features):   2,182.07 ms
[userecho:14552]     analysis:  36,708.00 ms
[userecho:14552]     (clinit):   1,147.36 ms
[userecho:14552]     universe:   2,441.84 ms
[userecho:14552]      (parse):   1,114.89 ms
[userecho:14552]     (inline):   2,769.22 ms
[userecho:14552]    (compile):  13,846.04 ms
[userecho:14552]      compile:  19,961.65 ms
[userecho:14552]        image:   3,631.87 ms
[userecho:14552]        write:   1,139.84 ms
[userecho:14552]      [total]:  75,733.82 ms</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--no-server</code> options tells to not use server-based image building.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generate_graalvm_native_image_for_gateway">Generate GraalVM native image for gateway</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">gateway $ ./gradlew assemble</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">gateway $ native-image --no-server -cp build/libs/gateway-0.1-all.jar
[gateway:14380]    classlist:   4,769.83 ms
[gateway:14380]        (cap):   2,178.91 ms
[gateway:14380]        setup:   3,102.47 ms
[gateway:14380]   (typeflow):  13,167.91 ms
[gateway:14380]    (objects):  17,513.79 ms
[gateway:14380]   (features):   2,323.89 ms
[gateway:14380]     analysis:  35,342.33 ms
[gateway:14380]     (clinit):   1,119.21 ms
[gateway:14380]     universe:   2,471.35 ms
[gateway:14380]      (parse):   2,535.37 ms
[gateway:14380]     (inline):   2,379.36 ms
[gateway:14380]    (compile):  14,645.46 ms
[gateway:14380]      compile:  21,854.85 ms
[gateway:14380]        image:   5,309.31 ms
[gateway:14380]        write:   1,257.64 ms
[gateway:14380]      [total]:  74,390.31 ms</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>--no-server</code> options tells to not use server-based image building.</p>
</div>
</div>
</div>


<h2 id="graalexecute">4.3 Execute Native Images</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/graal/graalexecute.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Execute gateway native image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"> ./gateway
15:05:06.684 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 26ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute userecho native image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"> ./userecho
15:06:25.364 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 24ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
<div class="paragraph">
<p>Login to get the access token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ curl -X "POST" "http://localhost:8080/login" -H 'Content-Type: application/json; charset=utf-8' -d $'{"username": "sherlock","password": "password"}'

{"username":"sherlock","access_token":"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJzaGVybG9jayIsIm5iZiI6MTU3NTY0MTE4Nywicm9sZXMiOltdLCJpc3MiOiJnYXRld2F5IiwiZXhwIjoxNTc1NjQ0Nzg3LCJpYXQiOjE1NzU2NDExODd9.KeqG7XKB9RSEX4TncMCRVhikeMaFz3zzU9V190ioG3s","refresh_token":"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJzaGVybG9jayIsIm5iZiI6MTU3NTY0MTE4Nywicm9sZXMiOltdLCJpc3MiOiJnYXRld2F5IiwiaWF0IjoxNTc1NjQxMTg3fQ._lceQy-ujMQpPEkmrxvXeSnY_oNQsBnUvaglmLI569E","token_type":"Bearer","expires_in":3600}%</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the access token to invoke <code>gateway</code> service <code>/user</code> endpoint. Token propagation will happen and we receive the username.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ curl "http://localhost:8080/user" -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJzaGVybG9jayIsIm5iZiI6MTU3NTY0MTE4Nywicm9sZXMiOltdLCJpc3MiOiJnYXRld2F5IiwiZXhwIjoxNTc1NjQ0Nzg3LCJpYXQiOjE1NzU2NDExODd9.KeqG7XKB9RSEX4TncMCRVhikeMaFz3zzU9V190ioG3s'

sherlock</code></pre>
</div>
</div>


<h2 id="graaldocker">4.4 Native Image generation with Docker</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/graal/graaldocker.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Alternatively, you can use Docker to construct the GraalVM Native Image.</p>
</div>
<div class="sect1">
<h2 id="_changes_to_gateway_to_generate_a_graalvm_native_image_with_docker">Changes to gateway to generate a GraalVM native image with Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replace <code>gateway/Dockerfile</code> with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">FROM oracle/graalvm-ce:20.1.0-java8 as graalvm
RUN gu install native-image

COPY . /home/app/gateway
WORKDIR /home/app/gateway

RUN native-image --no-server -cp build/libs/gateway-*-all.jar

FROM frolvlad/alpine-glibc
RUN apk update &amp;&amp; apk add libstdc++
EXPOSE 8080
COPY --from=graalvm /home/app/gateway/gateway /app/gateway
ENTRYPOINT ["/app/gateway"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a script `docker-build.sh to run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/sh
docker build . -t gateway
echo
echo
echo "To run the docker container execute:"
echo "    $ docker run -p 8080:8080 gateway"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_changes_to_userecho_to_generate_a_graalvm_native_image_with_docker">Changes to userecho to generate a GraalVM native image with Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replace <code>userecho/Dockerfile</code> with this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">FROM oracle/graalvm-ce:20.1.0-java8 as graalvm
RUN gu install native-image

COPY . /home/app/userecho
WORKDIR /home/app/userecho

RUN native-image --no-server -cp build/libs/userecho-*-all.jar

FROM frolvlad/alpine-glibc
RUN apk update &amp;&amp; apk add libstdc++
EXPOSE 8080
COPY --from=graalvm /home/app/userecho/userecho /app/userecho
ENTRYPOINT ["/app/userecho"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a script `docker-build.sh to run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">#!/bin/sh
docker build . -t userecho
echo
echo
echo "To run the docker container execute:"
echo "    $ docker run -p 8080:8080 userecho"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use docker to run the images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ docker run -p 8080:8080 gateway
$ docker run -p 8081:8081 userecho</code></pre>
</div>
</div>
</div>
</div>


<h1 id="nextSteps">5 Next Steps</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-token-propagation/edit/master/src/main/docs/guide/nextSteps.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#tokenPropagation">Token Propagation</a>
and <a href="https://docs.micronaut.io/latest/guide/index.html#security">Security</a> inside Micronaut.</p>
</div>


<h1 id="help">6 Help with Micronaut</h1>

    <h3 style="color: #333; margin-bottom:25px;"><a href="https://objectcomputing.com/" target="_blank">Object Computing, Inc.</a> (OCI) sponsored the creation of this Guide. A variety of consulting and support services are available.</h3>

    <!--[if lte IE 8]>
    <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
    <![endif]-->
    <script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
    <script>
        hbspt.forms.create({
            portalId: "4547412",
            formId: "24edfcbb-b6f2-4fcf-af48-35ab6271031e"
        });
    </script>

    <h3 style="color: #333;">OCI is Home to Micronaut.</h3>

    <p><a href="https://objectcomputing.com/products/2gm-team" target="_blank">Meet the Team</a></p>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
