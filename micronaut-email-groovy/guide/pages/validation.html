<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3.5 Validation null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Send Emails from Micronaut
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/application.html"><strong>2</strong><span>Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>3</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/testingTheApp.html"><strong>4</strong><span>Testing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/help.html"><strong>5</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/application.html">&lt;&lt; <strong>2</strong><span>Application</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../../guide/testingTheApp.html"><strong>4</strong><span>Testing the Application</span> >></a></div>
                


                <div class="project">
                    <h1>3.5 Validation</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h2 id="validation">3.5 Validation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/validation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We want to ensure any email request contains a subject, recipient and a text body or html body.</p>
</div>
<div class="paragraph">
<p>Micronaut&#8217;s validation is built on with the standard framework â€“ JSR 380, also known as Bean Validation 2.0.</p>
</div>
<div class="paragraph">
<p>Hibernate Validator is a reference implementation of the validation API. Starting with Micronaut 1.2, Micronaut
<a href="https://docs.micronaut.io/latest/guide/index.html#beanValidation">has built-in support for validation beans</a> that
are annotated with <code>javax.validation</code> annotations.</p>
</div>
<div class="paragraph">
<p><code>build.gradle</code> should contain the next snippet:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">implementation("io.micronaut:micronaut-validation")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the next test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/MailControllerValidationSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.context.annotation.Property
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.RxHttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.test.annotation.MicronautTest
import spock.lang.Specification
import javax.inject.Inject

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
@Property(name = "spec.name", value = "mailcontroller") <i class="conum" data-value="2"></i><b>(2)</b>
class MailControllerValidationSpec extends Specification {

    @Inject
    ApplicationContext applicationContext;

    @Inject
    @Client("/")
    RxHttpClient client;

    void "mail send cannot be invoked without subject"() {
        given:
        EmailCmd cmd = new EmailCmd(recipient: "delamos@micronaut.example", textBody: "Hola hola")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        client.toBlocking().exchange(request)

        then:
        HttpClientResponseException e = thrown()
        HttpStatus.BAD_REQUEST == e.status
    }

    void "mail send cannot be invoked without recipient"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Hola", textBody: "Hola hola")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        client.toBlocking().exchange(request)

        then:
        HttpClientResponseException e = thrown()
        HttpStatus.BAD_REQUEST == e.status
    }

    void "mail send cannot be invoked without either text body or html body"() {
        EmailCmd cmd = new EmailCmd(subject: "Hola", recipient: "delamos@micronaut.example")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        client.toBlocking().exchange(request)

        then:
        HttpClientResponseException e = thrown()
        HttpStatus.BAD_REQUEST == e.status
    }

    void "mail send can be invoked without text body and not html body"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Hola", recipient: "delamos@micronaut.example", textBody: "Hello")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        HttpResponse&lt;?&gt; rsp = client.toBlocking().exchange(request)

        then:
        HttpStatus.OK == rsp.getStatus()
    }

    void "mail send can be invoked with html body and not text body"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Hola", recipient: "delamos@micronaut.example", htmlBody: "&lt;h1&gt;Hello&lt;/h1&gt;")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        HttpResponse&lt;?&gt; rsp = client.toBlocking().exchange(request)

        then:
        HttpStatus.OK == rsp.getStatus()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronatTest</code> to let Micronaut starts the embedded server and inject the beans. More info: <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html">https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a property available for the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creating HTTP Requests is easy thanks to Micronaut&#8217;s fluid API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to satisfy the test, create an email constraints annotation</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/EmailConstraints.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Constraint(validatedBy = {})
@Target(value = {ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface EmailConstraints {

    String message() default "{email.invalid}";

    Class&lt;?&gt;[] groups() default {};

    Class&lt;? extends Payload&gt;[] payload() default {};

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and a contraint validator in a <code>@Factory</code> class:</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/EmailConstraintsFactory.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import edu.umd.cs.findbugs.annotations.NonNull
import edu.umd.cs.findbugs.annotations.Nullable
import groovy.transform.CompileStatic
import io.micronaut.context.annotation.Factory
import io.micronaut.core.annotation.AnnotationValue
import io.micronaut.core.util.StringUtils
import io.micronaut.validation.validator.constraints.ConstraintValidator
import io.micronaut.validation.validator.constraints.ConstraintValidatorContext

import javax.inject.Singleton

@Factory
@CompileStatic
class EmailConstraintsFactory {

    @Singleton
    ConstraintValidator&lt;EmailConstraints, EmailCmd&gt; emailBodyValidator() {
        return new ConstraintValidator&lt;EmailConstraints, EmailCmd&gt;() {
            @Override
            boolean isValid(@Nullable EmailCmd value,
                            @NonNull AnnotationValue&lt;EmailConstraints&gt; annotationMetadata,
                            @NonNull ConstraintValidatorContext context) {
                StringUtils.isNotEmpty(value?.textBody) || StringUtils.isNotEmpty(value?.htmlBody)
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Annotate <code>EmailCmd</code> with <code>EmailConstraints</code> and <code>@Introspected</code> (to generate the
<a href="https://docs.micronaut.io/latest/guide/index.html#introspection">Bean Introspection information</a>).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/EmailCmd.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">@EmailConstraints

    @NotNull
    @NotBlank
    String recipient

    @NotNull
    @NotBlank
    String subject

    List&lt;String&gt; cc = []
    List&lt;String&gt; bcc = []

    String htmlBody
    String textBody
    String replyTo
}</code></pre>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/application.html">&lt;&lt; <strong>2</strong><span>Application</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/testingTheApp.html"><strong>4</strong><span>Testing the Application</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
