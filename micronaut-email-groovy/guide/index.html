<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Send Emails from Micronaut | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Send Emails from Micronaut. Learn how to send emails with AWS SES and SendGrid from a Micronaut app and leverage @Requires annotation to load beans conditionally.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-email-groovy/guide/index.html">Send Emails from Micronaut</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-email-groovy"><img src="https://travis-ci.org/micronaut-guides/micronaut-email-groovy.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-email-groovy&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-email-groovy.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-email-groovy.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-email-groovy.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-email-groovy/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#application"><strong>2</strong><span>Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>3</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>3.1</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#services"><strong>3.2</strong><span>Email Service</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#awsSesService"><strong>3.2.1</strong><span>AWS SES</span></a></div>
            
            <div class="toc-item" style="margin-left:20px"><a href="#sendGridService"><strong>3.2.2</strong><span>SendGrid</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#resources"><strong>3.3</strong><span>Run the app</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#test"><strong>3.4</strong><span>Test</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#validation"><strong>3.5</strong><span>Validation</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#testingTheApp"><strong>4</strong><span>Testing the Application</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#help"><strong>5</strong><span>Help with Micronaut</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Send Emails from Micronaut</h1>
        <p>Learn how to send emails with AWS SES and SendGrid from a Micronaut app and leverage @Requires annotation to load beans conditionally.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 2.0.0.RC1</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This guide uses Micronaut 2.x. You can <a href="https://guides.micronaut.io/1.x/micronaut-guides/micronaut-email-groovy/index.html">read this tutorial for Micronaut 1.x.</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this guide we are going to create a Micronaut app written in Groovy.</p>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-email-groovy/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-email-groovy.git" class="bare">https://github.com/micronaut-guides/micronaut-email-groovy.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="application">2 Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/application.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Remove the <code>Application.java</code> created by the <code>mn create-app --features groovy</code> command.</p>
</div>
<div class="paragraph">
<p>Create a Groovy file instead which is used when running the application via Gradle or via deployment. You can also run the main class directly within your IDE if it is configured correctly.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/Application.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic;
import io.micronaut.runtime.Micronaut;

@CompileStatic
class Application {

    static void main(String[] args) {
        Micronaut.run(Application.class);
    }
}</code></pre>
</div>
</div>


<h1 id="writingTheApp">3 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a Groovy Micronaut app using the <a href="http://docs.micronaut.io/snapshot/guide/index.html#cli">Micronaut Command Line Interface</a>.</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.complete --lang=groovy</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a micronaut app with the default package <code>example.micronaut</code> in a folder named <code>complete</code>.</p>
</div>
<div class="paragraph">
<p>Due to the <code>--lang=groovy</code> flag, it generates a Groovy Micronaut app that uses the <a href="http://gradle.org">Gradle</a> build system. However, you could use
other build tools such as <code>Maven</code> or other programming languages such as <code>Java</code> or <code>Kotlin</code>.</p>
</div>


<h2 id="controller">3.1 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create <code>MailController</code> which use a collaborator, <code>emailService</code> to send and email.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/MailController.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic
import io.micronaut.http.HttpResponse
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Post

import javax.validation.Valid

@CompileStatic
@Controller("/mail") <i class="conum" data-value="1"></i><b>(1)</b>
class MailController {

    private final EmailService emailService

    MailController(EmailService emailService) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.emailService = emailService
    }

    @Post("/send") <i class="conum" data-value="3"></i><b>(3)</b>
    HttpResponse&lt;?&gt; send(@Body @Valid EmailCmd cmd) { <i class="conum" data-value="4"></i><b>(4)</b>
        emailService.send(cmd)
        HttpResponse.ok()  <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/mail/send</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor injection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation is used to map the index method to all requests that use an HTTP POST</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add <code>@Valid</code> to any method parameter which requires validation. Use a POGO supplied as a JSON payload in the request to populate the email.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Return 200 OK as the result</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller uses a POGO supplied in the request body as a JSON Payload</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/EmailCmd.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">@ToString
@CompileStatic
class EmailCmd implements Email {

    @NotNull
    @NotBlank
    String recipient

    @NotNull
    @NotBlank
    String subject

    List&lt;String&gt; cc = []
    List&lt;String&gt; bcc = []

    String htmlBody
    String textBody
    String replyTo

}</code></pre>
</div>
</div>


<h2 id="services">3.2 Email Service</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/services.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an interface - <code>EmailService</code>. Any email provider present in the application should implement it.</p>
</div>
<div class="listingblock">
<div class="title">src/groovy/main/example/micronaut/EmailService.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import edu.umd.cs.findbugs.annotations.NonNull

import javax.validation.Valid
import javax.validation.constraints.NotNull

interface EmailService {
    void send(@NonNull @NotNull @Valid Email email)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/groovy/main/example/micronaut/Email.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut;

interface Email {
    String getRecipient()
    List&lt;String&gt; getCc()
    List&lt;String&gt; getBcc()
    String getSubject()
    String getHtmlBody()
    String getTextBody()
    String getReplyTo()
}</code></pre>
</div>
</div>


<h2 id="awsSesService">3.2.1 AWS SES</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/services/awsSesService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Amazon Simple Email Service (Amazon SES) is a cloud-based email sending service designed to help digital marketers and application developers send marketing, notification, and transactional emails. It is a reliable, cost-effective service for businesses of all sizes that use email to keep in contact with their customers.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Add a dependency to AWS SES SDK:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">implementation('software.amazon.awssdk:ses:2.13.39')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create service which uses AWS Simple Email Service client to send the email</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/AwsSesMailService.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import edu.umd.cs.findbugs.annotations.NonNull
import edu.umd.cs.findbugs.annotations.Nullable
import groovy.transform.CompileStatic
import io.micronaut.context.annotation.Requires
import io.micronaut.context.annotation.Secondary
import io.micronaut.context.annotation.Value
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import software.amazon.awssdk.regions.Region
import software.amazon.awssdk.services.ses.SesClient
import software.amazon.awssdk.services.ses.model.Body
import software.amazon.awssdk.services.ses.model.Content
import software.amazon.awssdk.services.ses.model.Destination
import software.amazon.awssdk.services.ses.model.Message
import software.amazon.awssdk.services.ses.model.SendEmailRequest
import software.amazon.awssdk.services.ses.model.SendEmailResponse

import javax.inject.Singleton
import javax.validation.Valid
import javax.validation.constraints.NotNull

@CompileStatic
@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
@Requires(condition = AwsResourceAccessCondition.class)  <i class="conum" data-value="2"></i><b>(2)</b>
@Secondary <i class="conum" data-value="3"></i><b>(3)</b>
public class AwsSesMailService implements EmailService {
    private static final Logger LOG = LoggerFactory.getLogger(AwsSesMailService.class)
    protected final String sourceEmail
    protected final SesClient ses

    public AwsSesMailService(@Nullable @Value('${AWS_REGION}') String awsRegionEnv, <i class="conum" data-value="4"></i><b>(4)</b>
                             @Nullable @Value('${AWS_SOURCE_EMAIL}') String sourceEmailEnv,
                             @Nullable @Value('${aws.region}') String awsRegionProp,
                             @Nullable @Value('${aws.sourceemail}') String sourceEmailProp) {

        this.sourceEmail = sourceEmailEnv != null ? sourceEmailEnv : sourceEmailProp
        String awsRegion = awsRegionEnv != null ? awsRegionEnv : awsRegionProp
        this.ses = SesClient.builder().region(Region.of(awsRegion)).build()
    }

    @Override
    void send(@NonNull @NotNull @Valid Email email) {
        SendEmailRequest sendEmailRequest = SendEmailRequest.builder()
                .destination(Destination.builder().toAddresses(email.recipient).build())
                .source(sourceEmail)
                .message(Message.builder().subject(Content.builder().data(email.subject).build())
                        .body(Body.builder().text(Content.builder().data(email.textBody).build()).build()).build()).build() as SendEmailRequest
        SendEmailResponse response =ses.sendEmail(sendEmailRequest)
        if (LOG.isInfoEnabled()) {
            LOG.info("Sent email with id: {}", response.messageId())
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bean will not loaded unless condition is met.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In case of multiple possible interface implementations of <code>EmailService</code>, <code>@Secondary</code> reduces the priority.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Values for region and source email are resolved from environment variables or system properties.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We annotated the previous class with <code>@Requires(condition = AwsResourceAccessCondition.class)</code>.</p>
</div>
<div class="paragraph">
<p>The <code>AwsResourceAccessCondition</code> ensures the bean is not loaded unless certain conditions are fulfilled.</p>
</div>
<div class="paragraph">
<p><a href="https://docs.aws.amazon.com/sdk-for-java/v2/developer-guide/java-dg-roles.html"><em>Configure IAM Roles for Amazon EC2</em></a></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>If your application creates an AWS client using the create method, the client searches for credentials using the default credentials provider chain, in the following order:</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p>In the Java system properties: <code>aws.accessKeyId</code> and <code>aws.secretAccessKey</code>.</p>
</li>
<li>
<p>In system environment variables: <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code>.</p>
</li>
<li>
<p>In the default credentials file (the location of this file varies by platform).</p>
</li>
<li>
<p>n the Amazon ECS environment variable: <code>AWS_CONTAINER_CREDENTIALS_RELATIVE_URI</code>.</p>
</li>
<li>
<p>In the instance profile credentials, which exist within the instance metadata associated with the IAM role for the EC2 instance.</p>
</li>
</ul>
</div>
</blockquote>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/AwsResourceAccessCondition.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic
import io.micronaut.context.condition.Condition
import io.micronaut.context.condition.ConditionContext
import io.micronaut.context.env.Environment
import io.micronaut.core.util.StringUtils

/**
 * @see &lt;a href="https://docs.aws.amazon.com/sdk-for-java/v2/developer-guide/java-dg-roles.html"&gt;Configure IAM Roles for Amazon EC2&lt;/a&gt;
 */
@CompileStatic
class AwsResourceAccessCondition implements Condition {

    @Override
    boolean matches(ConditionContext context) {

        if (StringUtils.isNotEmpty(System.getProperty("aws.accessKeyId")) &amp;&amp;  StringUtils.isNotEmpty(System.getProperty("aws.secretAccessKey"))) { <i class="conum" data-value="1"></i><b>(1)</b>
            return true
        }

        if (StringUtils.isNotEmpty(System.getenv("AWS_ACCESS_KEY_ID")) &amp;&amp;  StringUtils.isNotEmpty(System.getenv("AWS_SECRET_ACCESS_KEY"))) { <i class="conum" data-value="2"></i><b>(2)</b>
            return true
        }

        if (StringUtils.isNotEmpty(System.getenv("AWS_CONTAINER_CREDENTIALS_RELATIVE_URI"))) { <i class="conum" data-value="3"></i><b>(3)</b>
            return true
        }

        context != null &amp;&amp; context.getBean(Environment.class).getActiveNames().contains(Environment.AMAZON_EC2) <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a test to verify the service is loaded:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/micronaut/AwsSesMailServiceSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut;

import io.micronaut.context.ApplicationContext
import spock.lang.Specification
import spock.util.environment.RestoreSystemProperties

class AwsSesMailServiceSpec extends Specification {

    void "aws ses mail service is not loaded if system property is not present"() {
        given:
        ApplicationContext ctx = ApplicationContext.run()

        expect:
        !ctx.containsBean(AwsSesMailService.class)

        cleanup:
        ctx.close();
    }

    @RestoreSystemProperties
    void "aws ses mail service is loaded if system properties are present"() {
        given:
        System.setProperty("aws.accessKeyId", "XXXX")
        System.setProperty("aws.secretAccessKey", "YKYY")
        System.setProperty("aws.region", "XXXX")
        System.setProperty("aws.sourceemail", "me@micronaut.example")
        ApplicationContext ctx = ApplicationContext.run()

        when:
        AwsSesMailService bean = ctx.getBean(AwsSesMailService.class)

        then:
        "me@micronaut.example" == bean.sourceEmail

        cleanup:
        ctx.close()
    }
}</code></pre>
</div>
</div>


<h2 id="sendGridService">3.2.2 SendGrid</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/services/sendGridService.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="http://sendgrid.com">SendGrid</a> is a transactional email service.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>SendGrid is responsible for sending billions of emails for some of the best and brightest companies in the world.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Add a dependency to SendGrid SDK:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">implementation('com.sendgrid:sendgrid-java:4.6.0')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a service which encapsulates the integration with SendGrid. The bean will not be loaded if the
system properties (<code>sendgrid.apikey</code>, <code>sendgrid.fromemail</code>) or environment variables (<code>SENDGRID_APIKEY</code>, <code>SENDGRID_FROM_EMAIL</code>) are not present.</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/SendGridEmailCondition.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic;
import io.micronaut.context.condition.Condition;
import io.micronaut.context.condition.ConditionContext;
import io.micronaut.core.util.StringUtils;

@CompileStatic
class SendGridEmailCondition implements Condition {
    @Override
    boolean matches(ConditionContext context) {
        return envOrSystemProperty("SENDGRID_APIKEY", "sendgrid.apikey") &amp;&amp;
                envOrSystemProperty("SENDGRID_FROM_EMAIL", "sendgrid.fromemail");
    }

    private static boolean envOrSystemProperty(String env, String prop) {
        return StringUtils.isNotEmpty(System.getProperty(prop)) || StringUtils.isNotEmpty(System.getenv(env));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/micronaut/SendGridEmailConditionSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import spock.lang.Specification
import spock.util.environment.RestoreSystemProperties

class SendGridEmailConditionSpec extends Specification {

    @RestoreSystemProperties
    void "condition is true if system properites are present"() {
        given:
        System.setProperty("sendgrid.apikey", "XXXX")
        System.setProperty("sendgrid.fromemail", "me@micronaut.example")
        SendGridEmailCondition condition = new SendGridEmailCondition()

        expect:
        condition.matches(null)
    }

    void "condition is false if system properties are not present"() {
        given:
        SendGridEmailCondition condition = new SendGridEmailCondition()

        expect:
        !condition.matches(null)
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/SendGridEmailService.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import com.sendgrid.SendGrid
import com.sendgrid.Request
import com.sendgrid.Response
import com.sendgrid.Method
import com.sendgrid.helpers.mail.Mail
import com.sendgrid.helpers.mail.objects.Content
import com.sendgrid.helpers.mail.objects.Personalization
import edu.umd.cs.findbugs.annotations.NonNull
import groovy.transform.CompileStatic
import io.micronaut.context.annotation.Requires
import io.micronaut.context.annotation.Value
import org.slf4j.Logger
import org.slf4j.LoggerFactory

import javax.inject.Singleton
import javax.validation.Valid
import javax.validation.constraints.NotNull

@CompileStatic
@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
@Requires(condition = SendGridEmailCondition.class) <i class="conum" data-value="2"></i><b>(2)</b>
class SendGridEmailService implements EmailService {

    private static final Logger LOG = LoggerFactory.getLogger(SendGridEmailService.class)

    protected final String apiKey

    protected final String fromEmail

    SendGridEmailService(@Value('${SENDGRID_APIKEY:none}') String apiKeyEnv, <i class="conum" data-value="3"></i><b>(3)</b>
                         @Value('${SENDGRID_FROM_EMAIL:none}') String fromEmailEnv,
                         @Value('${sendgrid.apikey:none}') String apiKeyProp,
                         @Value('${sendgrid.fromemail:none}') String fromEmailProp) {
        this.apiKey = apiKeyEnv != null &amp;&amp; !apiKeyEnv.equals("none") ? apiKeyEnv : apiKeyProp
        this.fromEmail = fromEmailEnv != null &amp;&amp; !fromEmailEnv.equals("none")  ? fromEmailEnv: fromEmailProp
    }

    protected static Content contentOfEmail(Email email) {
        if ( email.textBody !=null ) {
            return new Content("text/plain", email.textBody)
        }
        if ( email.htmlBody !=null ) {
            return new Content("text/html", email.htmlBody)
        }
        return null
    }

    @Override
    public void send(@NonNull @NotNull @Valid Email email) {

        Personalization personalization = new Personalization()
        personalization.setSubject(email.subject)

        com.sendgrid.helpers.mail.objects.Email to = new com.sendgrid.helpers.mail.objects.Email(email.recipient)
        personalization.addTo(to)

        if ( email.cc != null ) {
            for ( String cc : email.cc ) {
                com.sendgrid.helpers.mail.objects.Email ccEmail = new com.sendgrid.helpers.mail.objects.Email()
                ccEmail.setEmail(cc)
                personalization.addCc(ccEmail)
            }
        }

        if ( email.bcc  != null ) {
            for ( String bcc : email.bcc ) {
                com.sendgrid.helpers.mail.objects.Email bccEmail = new com.sendgrid.helpers.mail.objects.Email()
                bccEmail.setEmail(bcc)
                personalization.addBcc(bccEmail)
            }
        }

        Mail mail = new Mail()
        com.sendgrid.helpers.mail.objects.Email from = new com.sendgrid.helpers.mail.objects.Email()
        from.setEmail(fromEmail)
        mail.from = from
        mail.addPersonalization(personalization)
        Content content = contentOfEmail(email)
        mail.addContent(content)

        SendGrid sg = new SendGrid(apiKey)
        Request request = new Request()
        try {
            request.setMethod(Method.POST)
            request.setEndpoint("mail/send")
            request.setBody(mail.build())

            Response response = sg.api(request)
            if (LOG.isInfoEnabled()) {
                LOG.info("Status Code: {}", String.valueOf(response.getStatusCode()))
                LOG.info("Body: {}", response.getBody())
                for ( String k : response.getHeaders().keySet()) {
                    String v = response.getHeaders().get(k)
                    LOG.info("Response Header {} =&gt; {}", k, v)
                }
            }


        } catch (IOException ex) {
            if (LOG.isErrorEnabled()) {
                LOG.error(ex.getMessage())
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bean will not loaded unless condition is met.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Values will be resolved from system properties.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add a test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/micronaut/SendGridEmailServiceSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.ApplicationContext
import spock.lang.Specification
import spock.util.environment.RestoreSystemProperties

class SendGridEmailServiceSpec extends Specification {

    void "send grid email service is not loaded if system property is not present"() {
        given:
        ApplicationContext ctx = ApplicationContext.run()

        expect:
        !ctx.containsBean(SendGridEmailService.class)

        cleanup:
        ctx.close()
    }

    @RestoreSystemProperties
    void "send grid email service is loaded if system properties are present"() {
        given:
        System.setProperty("sendgrid.apikey", "XXXX")
        System.setProperty("sendgrid.fromemail", "me@micronaut.example")
        ApplicationContext ctx = ApplicationContext.run()
        SendGridEmailService bean = ctx.getBean(SendGridEmailService.class)

        expect:
        "XXXX" == bean.apiKey
        "me@micronaut.example" == bean.fromEmail

        cleanup:
        ctx.close()

    }
}</code></pre>
</div>
</div>


<h2 id="resources">3.3 Run the app</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/resources.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Add a logger to get more visibility:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/logback.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">...
..
.
&lt;configuration&gt;

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;withJansi&gt;true&lt;/withJansi&gt;
        &lt;!-- encoders are assigned the type
             ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%cyan(%d{HH:mm:ss.SSS}) %gray([%thread]) %highlight(%-5level) %magenta(%logger{36}) - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level="info"&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
    &lt;/root&gt;
&lt;!--tag::logger[]--&gt;
    &lt;logger name="example.micronaut" level="TRACE"/&gt;
&lt;!--end::logger[]--&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use SendGrid, setup the required environment variables and run the app</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ export SENDGRID_FROM_EMAIL=email@email.com
$ export SENDGRID_APIKEY=XXXXXX
$ ./gradlew run</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use AWS SES, setup the required environment variables and run the app</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ export AWS_REGION=eu-west-1
$ export AWS_SOURCE_EMAIL=email@email.com
$ export AWS_ACCESS_KEY_ID=XXXXXXXX
$ export AWS_SECRET_KEY=XXXXXXXX
$ ./gradlew run</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you supply both AWS SES and SendGrid environment variables, the AWS SES <code>EmailService</code> implementation will be used due to the <code>@Primary</code> annotation.</p>
</div>


<h2 id="test">3.4 Test</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/test.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>In our acceptance test, beans <code>SendGridEmailService</code> or <code>AwsSesMailService</code> will not be loaded since system properties are not present.</p>
</div>
<div class="paragraph">
<p>Instead, we setup a Mock which we can verify interactions against.</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/micronaut/MockEmailService.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import edu.umd.cs.findbugs.annotations.NonNull
import io.micronaut.context.annotation.Primary
import io.micronaut.context.annotation.Requires

import javax.inject.Singleton
import javax.validation.Valid
import javax.validation.constraints.NotNull

@Primary
@Requires(property = "spec.name", value = "mailcontroller")
@Singleton
class MockEmailService implements EmailService {

    public List&lt;Email&gt; emails = new ArrayList&lt;&gt;()

    @Override
    void send(@NonNull @NotNull @Valid Email email) {
        emails &lt;&lt; email
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the next test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/groovy/example/micronaut/MailControllerSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.context.annotation.Property
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.RxHttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.test.annotation.MicronautTest
import spock.lang.Specification

import javax.inject.Inject

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
@Property(name = "spec.name", value = "mailcontroller") <i class="conum" data-value="2"></i><b>(2)</b>
class MailControllerSpec extends Specification {

    @Inject
    ApplicationContext applicationContext <i class="conum" data-value="3"></i><b>(3)</b>

    @Inject
    @Client("/")
    RxHttpClient client <i class="conum" data-value="4"></i><b>(4)</b>

    void "mail send interacts once email service"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Test", recipient: "delamos@grails.example", textBody: "Hola hola")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="5"></i><b>(5)</b>

        when:
        Collection&lt;EmailService&gt; emailServices = applicationContext.getBeansOfType(EmailService.class)

        then:
        1 == emailServices.size()

        when:
        EmailService emailService = applicationContext.getBean(EmailService.class)

        then:
        emailService instanceof MockEmailService

        when:
        HttpResponse&lt;?&gt; rsp = client.toBlocking().exchange(request)
        then:
        HttpStatus.OK == rsp.getStatus()
        old(((MockEmailService) emailService).emails.size()) + 1 == ((MockEmailService) emailService).emails.size() <i class="conum" data-value="6"></i><b>(6)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronatTest</code> to let Micronaut starts the embedded server and inject the beans. More info: <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html">https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a property used to run the test</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inject the <code>ApplicationContext</code> bean</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Inject the <code>RxHttpClient</code> bean</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Creating HTTP Requests is easy thanks to Micronaut&#8217;s fluid API.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>emailService.send</code> method is invoked once.</td>
</tr>
</table>
</div>


<h2 id="validation">3.5 Validation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/writingTheApp/validation.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We want to ensure any email request contains a subject, recipient and a text body or html body.</p>
</div>
<div class="paragraph">
<p>Micronaut&#8217;s validation is built on with the standard framework – JSR 380, also known as Bean Validation 2.0.</p>
</div>
<div class="paragraph">
<p>Hibernate Validator is a reference implementation of the validation API. Starting with Micronaut 1.2, Micronaut
<a href="https://docs.micronaut.io/latest/guide/index.html#beanValidation">has built-in support for validation beans</a> that
are annotated with <code>javax.validation</code> annotations.</p>
</div>
<div class="paragraph">
<p><code>build.gradle</code> should contain the next snippet:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">implementation("io.micronaut:micronaut-validation")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the next test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/MailControllerValidationSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.context.annotation.Property
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.RxHttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.test.annotation.MicronautTest
import spock.lang.Specification
import javax.inject.Inject

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
@Property(name = "spec.name", value = "mailcontroller") <i class="conum" data-value="2"></i><b>(2)</b>
class MailControllerValidationSpec extends Specification {

    @Inject
    ApplicationContext applicationContext;

    @Inject
    @Client("/")
    RxHttpClient client;

    void "mail send cannot be invoked without subject"() {
        given:
        EmailCmd cmd = new EmailCmd(recipient: "delamos@micronaut.example", textBody: "Hola hola")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        client.toBlocking().exchange(request)

        then:
        HttpClientResponseException e = thrown()
        HttpStatus.BAD_REQUEST == e.status
    }

    void "mail send cannot be invoked without recipient"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Hola", textBody: "Hola hola")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        client.toBlocking().exchange(request)

        then:
        HttpClientResponseException e = thrown()
        HttpStatus.BAD_REQUEST == e.status
    }

    void "mail send cannot be invoked without either text body or html body"() {
        EmailCmd cmd = new EmailCmd(subject: "Hola", recipient: "delamos@micronaut.example")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        client.toBlocking().exchange(request)

        then:
        HttpClientResponseException e = thrown()
        HttpStatus.BAD_REQUEST == e.status
    }

    void "mail send can be invoked without text body and not html body"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Hola", recipient: "delamos@micronaut.example", textBody: "Hello")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        HttpResponse&lt;?&gt; rsp = client.toBlocking().exchange(request)

        then:
        HttpStatus.OK == rsp.getStatus()
    }

    void "mail send can be invoked with html body and not text body"() {
        given:
        EmailCmd cmd = new EmailCmd(subject: "Hola", recipient: "delamos@micronaut.example", htmlBody: "&lt;h1&gt;Hello&lt;/h1&gt;")
        HttpRequest&lt;EmailCmd&gt; request = HttpRequest.POST("/mail/send", cmd) <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        HttpResponse&lt;?&gt; rsp = client.toBlocking().exchange(request)

        then:
        HttpStatus.OK == rsp.getStatus()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronatTest</code> to let Micronaut starts the embedded server and inject the beans. More info: <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html">https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a property available for the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creating HTTP Requests is easy thanks to Micronaut&#8217;s fluid API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In order to satisfy the test, create an email constraints annotation</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/EmailConstraints.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

@Constraint(validatedBy = {})
@Target(value = {ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface EmailConstraints {

    String message() default "{email.invalid}";

    Class&lt;?&gt;[] groups() default {};

    Class&lt;? extends Payload&gt;[] payload() default {};

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and a contraint validator in a <code>@Factory</code> class:</p>
</div>
<div class="listingblock">
<div class="title">src/main/groovy/example/micronaut/EmailConstraintsFactory.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import edu.umd.cs.findbugs.annotations.NonNull
import edu.umd.cs.findbugs.annotations.Nullable
import groovy.transform.CompileStatic
import io.micronaut.context.annotation.Factory
import io.micronaut.core.annotation.AnnotationValue
import io.micronaut.core.util.StringUtils
import io.micronaut.validation.validator.constraints.ConstraintValidator
import io.micronaut.validation.validator.constraints.ConstraintValidatorContext

import javax.inject.Singleton

@Factory
@CompileStatic
class EmailConstraintsFactory {

    @Singleton
    ConstraintValidator&lt;EmailConstraints, EmailCmd&gt; emailBodyValidator() {
        return new ConstraintValidator&lt;EmailConstraints, EmailCmd&gt;() {
            @Override
            boolean isValid(@Nullable EmailCmd value,
                            @NonNull AnnotationValue&lt;EmailConstraints&gt; annotationMetadata,
                            @NonNull ConstraintValidatorContext context) {
                StringUtils.isNotEmpty(value?.textBody) || StringUtils.isNotEmpty(value?.htmlBody)
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Annotate <code>EmailCmd</code> with <code>EmailConstraints</code> and <code>@Introspected</code> (to generate the
<a href="https://docs.micronaut.io/latest/guide/index.html#introspection">Bean Introspection information</a>).</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/EmailCmd.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">@EmailConstraints

    @NotNull
    @NotBlank
    String recipient

    @NotNull
    @NotBlank
    String subject

    List&lt;String&gt; cc = []
    List&lt;String&gt; bcc = []

    String htmlBody
    String textBody
    String replyTo
}</code></pre>
</div>
</div>


<h1 id="testingTheApp">4 Testing the Application</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/testingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ ./gradlew test
$ open build/reports/tests/test/index.html</code></pre>
</div>
</div>


<h1 id="help">5 Help with Micronaut</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-email-groovy/edit/master/src/main/docs/guide/help.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<h3 style="color: #333; margin-bottom:25px;"><a href="https://objectcomputing.com/" target="_blank">Object Computing, Inc.</a> (OCI) sponsored the creation of this Guide. A variety of consulting and support services are available.</h3>

<!--[if lte IE 8]>
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
<![endif]-->
<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
<script>
  hbspt.forms.create({
	portalId: "4547412",
	formId: "24edfcbb-b6f2-4fcf-af48-35ab6271031e"
});
</script>

<h3 style="color: #333;">OCI is Home to Micronaut.</h3>

<p><a href="https://objectcomputing.com/products/2gm-team" target="_blank">Meet the Team</a></p>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
