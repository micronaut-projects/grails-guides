<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>9 Http Client Filter null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Micronaut HTTP Client
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/bintray.html"><strong>3</strong><span>Bintray API</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/lowlevelclient.html"><strong>4</strong><span>Low Level Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/declarativeclient.html"><strong>5</strong><span>Declarative Client</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/controller.html"><strong>6</strong><span>Controller</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/tests.html"><strong>7</strong><span>Test</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/testingTheApp.html"><strong>8</strong><span>Testing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/httpClientFilter.html"><strong>9</strong><span>Http Client Filter</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/next.html"><strong>10</strong><span>Where To Go From Here?</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>11</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/testingTheApp.html">&lt;&lt; <strong>8</strong><span>Testing the Application</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/next.html"><strong>10</strong><span>Where To Go From Here?</span> >></a></div>
                


                <div class="project">
                    <h1>9 Http Client Filter</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                

                

<h1 id="httpClientFilter">9 Http Client Filter</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-http-client-kotlin/edit/master/src/main/docs/guide/httpClientFilter.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Often, you need to include the same HTTP headers or URL parameters in a set of requests against a third-party API or when calling another Microservice.</p>
</div>
<div class="paragraph">
<p>To simplify this, Micronaut includes the ability to define <code>HttpClientFilter</code> classes that are applied to all matching HTTP clients.</p>
</div>
<div class="paragraph">
<p>For real world example, let us provide Bintray Authentication via a <code>HttpClientFilter</code>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Bintray REST API requires an applicative API key. An API key can be obtained from the user profile page. Authentication is achieved using HTTP Basic Authentication with the userâ€™s name as username and the API key as the password. Authenticated REST calls should only be used via HTTPs.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Create a Filter:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/BintrayFilter.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.annotation.Requires
import io.micronaut.http.HttpResponse
import io.micronaut.http.MutableHttpRequest
import io.micronaut.http.annotation.Filter
import io.micronaut.http.filter.ClientFilterChain
import io.micronaut.http.filter.HttpClientFilter
import org.reactivestreams.Publisher

@Filter("/api/\${bintray.apiversion}/repos/**") <i class="conum" data-value="1"></i><b>(1)</b>
@Requires(condition = BintrayFilterCondition::class) <i class="conum" data-value="2"></i><b>(2)</b>
class BintrayFilter(var bintrayConfiguration: BintrayConfiguration) : HttpClientFilter { <i class="conum" data-value="3"></i><b>(3)</b>

    override fun doFilter(request: MutableHttpRequest&lt;*&gt;, chain: ClientFilterChain): Publisher&lt;out HttpResponse&lt;*&gt;&gt; {
        if ( bintrayConfiguration.username != null &amp;&amp; bintrayConfiguration.token != null) {
            return chain.proceed(request.basicAuth(bintrayConfiguration.username, bintrayConfiguration.token)) <i class="conum" data-value="4"></i><b>(4)</b>
        }
        return chain.proceed(request)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Supply the pattern you want to match to the <code>@Filter</code> annotation. Note the required escaping (backslash) on "/api/\${bintray.apiversion}/repos/**" which is required due to Kotlin string interpolation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bean will not loaded unless condition is met</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Constructor injection of the configuration parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Enhance every request sent to Bintray API providing Basic Authentication.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We want to load the <code>BintrayFilter</code> bean if both configuration parameters <code>bintray.username</code> and <code>bintray.token</code> are present.
In the Java or Groovy versions of this guide, multiple <code>Requires</code> annotations are used. Multiple <code>@Requires</code> annotations are not possible with Kotlin.
Instead, we use a condition class.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/BintrayFilterCondition.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.condition.Condition
import io.micronaut.context.condition.ConditionContext
import io.micronaut.context.exceptions.NoSuchBeanException

class BintrayFilterCondition : Condition {

    override fun matches(context: ConditionContext&lt;*&gt;?): Boolean {
        if (context != null &amp;&amp; context.beanContext != null) {
            try {
                val bintrayConfiguration: BintrayConfiguration = context.beanContext.getBean(BintrayConfiguration::class.java)
                if (bintrayConfiguration.token != null &amp;&amp; bintrayConfiguration.username != null) {
                    return true
                }
            } catch (e: NoSuchBeanException) {
            }
        }
        return false
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We verify the previous condition class with a test:</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/BintrayFilterConditionTest.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut

import io.micronaut.context.ApplicationContext
import org.junit.jupiter.api.Assertions.assertFalse
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test

class BintrayFilterConditionTest {

    @Test
    fun verifyBintrayFilterIsLoadedIfBintrayUsernameTokenAreSet() {
        val applicationContext = ApplicationContext.run(mapOf&lt;String, Any&gt;(Pair("bintray.username", "john"), Pair("bintray.token", "XXX")))
        assertTrue(applicationContext.containsBean(BintrayFilter::class.java))
        applicationContext.close()
    }

    @Test
    fun verifyBintrayFilterIsNotLoadedIfBintrayUsernameTokenAreSet() {
        val applicationContext = ApplicationContext.run()
        assertFalse(applicationContext.containsBean(BintrayFilter::class.java))
        applicationContext.close()
    }

}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_parameters">Configuration Parameters</h4>
<div class="paragraph">
<p>Add your Bintray <code>username</code> and <code>token</code> to <code>src/main/resource/application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">bintray:
  organization: micronaut
  repository: profiles
  apiversion: v1
  username: yourbintrayusername
  token: XXXXXXXXXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add to <code>src/main/resources/logback.xml</code>, a logger to see Micronaut&#8217;s HTTP client output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;logger name="io.micronaut.http.client" level="TRACE"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run again the tests, you will see the that the Filter is invoked and HTTP Basic Auth is used against Bintray API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">13:21:08.981 [nioEventLoopGroup-1-14] TRACE i.m.http.client.DefaultHttpClient - Authorization: Basic XXXXXXXXXXXXXX</code></pre>
</div>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/testingTheApp.html">&lt;&lt; <strong>8</strong><span>Testing the Application</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/next.html"><strong>10</strong><span>Where To Go From Here?</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
