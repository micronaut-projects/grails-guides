<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2 Writing the App null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Secure a Micronaut app with Cognito
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/learnmore.html"><strong>4</strong><span>Learn More</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>5</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span> >></a></div>
                


                <div class="project">
                    <h1>2 Writing the App</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#views"><strong>2.1</strong><span>Views</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#oauth2"><strong>2.2</strong><span>OAuth 2.0</span></a>
                    </div>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#home"><strong>2.3</strong><span>Home</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-cognito/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an app using the <a href="http://docs.micronaut.io/snapshot/guide/index.html#cli">Micronaut Command Line Interface</a>.</p>
</div>
<div class="paragraph">
<p><code>mn create-app example.micronaut.complete</code></p>
</div>
<div class="paragraph">
<p>The previous command creates a micronaut app with the default package <code>example.micronaut</code> in a folder named <code>complete</code>.</p>
</div>
<div class="paragraph">
<p>By default, <code>create-app</code> creates a Java Micronaut app that uses the <a href="http://gradle.org">Gradle</a> build system. However, you could use
other build tools such as <code>Maven</code> or other programming languages such as <code>Groovy</code> or <code>Kotlin</code>.</p>
</div>
<div class="paragraph">
<p>If you are using Java or Kotlin and IntelliJ IDEA make sure you have enabled annotation processing.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/annotationprocessorsintellij.png" alt="annotationprocessorsintellij">
</div>
</div>


<h2 id="views">2.1 Views</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-cognito/edit/master/src/main/docs/guide/writingTheApp/views.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Although Micronaut is primarily designed around message encoding / decoding, there are occasions where it is convenient to render a view on the server side.</p>
</div>
<div class="paragraph">
<p>To use the view rendering features, add the following dependency on your classpath. For example, in <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    implementation "io.micronaut:micronaut-views-thymeleaf"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use <a href="https://www.thymeleaf.org/">Thymeleaf</a> Java template engine, add the thymeleaf dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    runtime "org.thymeleaf:thymeleaf:3.0.11.RELEASE"
}</code></pre>
</div>
</div>


<h2 id="oauth2">2.2 OAuth 2.0</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-cognito/edit/master/src/main/docs/guide/writingTheApp/oauth2.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To provide authentication, sign in to your <a href="https://aws.amazon.com">AWS</a> account and go to <a href="https://aws.amazon.com/cognito">AWS Cognito</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>With the Amazon Cognito SDK, you just write a few lines of code to enable your users to sign-up and sign-in to your mobile and web apps.</p>
</div>
<div class="paragraph">
<p><strong>Standards-based authentication</strong></p>
</div>
<div class="paragraph">
<p>Amazon Cognito uses common identity management standards including OpenID Connect, OAuth 2.0, and SAML 2.0.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>First, create an Amazon Cognito User Pool:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Amazon Cognito User Pools - A directory for all your users</strong></p>
</div>
<div class="paragraph">
<p>You can quickly create your own directory to sign up and sign in users, and to store user profiles using Amazon Cognito User Pools. User Pools provide a user interface you can customize to match your app. User Pools also enable easy integration with social identity providers such as Facebook, Google, and Amazon, and enterprise identity providers such as Microsoft Active Directory through SAML.</p>
</div>
</blockquote>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/aws-cognito-1.png" alt="aws cognito 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/aws-cognito-2.png" alt="aws cognito 2">
</div>
</div>
<div class="paragraph">
<p>Amazon Cognito Pools are regional. Thus, annotate the region you are using.</p>
</div>
<div class="paragraph">
<p>While you setup the Amazon Cognito User Pool, you will need to save the pool id:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/aws-cognito-3.png" alt="aws cognito 3">
</div>
</div>
<div class="paragraph">
<p>Configure the appropriate callback, make sure you allow <code>Authorization code grant</code> OAuth Flow, and also the scopes <code>openid</code> and <code>email</code> are selected.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/aws-cognito-5.png" alt="aws cognito 5">
</div>
</div>
<div class="paragraph">
<p>Save the client id and client secret:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/aws-cognito-4.png" alt="aws cognito 4">
</div>
</div>
<div class="paragraph">
<p>To use OAuth 2.0 integration, add the next dependency:</p>
</div>
<div class="listingblock">
<div class="title">gradle.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronautVersion=2.0.0.BUILD-SNAPSHOT</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    implementation "io.micronaut.configuration:micronaut-security-oauth2:2.0.0.BUILD-SNAPSHOT"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add also JWT <a href="https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#jwt">Micronautâ€™s JWT support</a> dependencies:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">dependencies {
  ...
  ..
    annotationProcessor "io.micronaut:micronaut-security-annotations:2.0.0.BUILD-SNAPSHOT"
    implementation "io.micronaut:micronaut-security-jwt:2.0.0.BUILD-SNAPSHOT"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following Oauth2 Configuration:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">micronaut:
  security:
    authentication: idtoken <i class="conum" data-value="1"></i><b>(1)</b>
    oauth2:
      clients:
        cognito: <i class="conum" data-value="2"></i><b>(2)</b>
          client-id: '${OAUTH_CLIENT_ID}' <i class="conum" data-value="3"></i><b>(3)</b>
          client-secret: '${OAUTH_CLIENT_SECRET}' <i class="conum" data-value="4"></i><b>(4)</b>
          openid:
            issuer: 'https://cognito-idp.${COGNITO_REGION}.amazonaws.com/${COGNITO_POOL_ID}/' <i class="conum" data-value="5"></i><b>(5)</b>
    endpoints:
      logout:
        get-allowed: true <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="paragraph">
<p>&lt;1&gt;Set <code>micronaut.security.authentication</code> as idtoken. The idtoken provided by Cognito when the OAuth 2.0 Authorization code flow ends will be saved in a cookie. The id token is a signed JWT. For every request, Micronaut extracts the JWT from the Cookie and validates the JWT signature with the remote Json Web Key Set exposed by Cognito. JWKS is exposed by the <code>jws-uri</code> entry of Cognito <code>.well-known/openid-configuration</code>
&lt;2&gt; The provider identifier should match the last part of the url you entered as a redirect url <code>/oauth/callback/cognito</code>
&lt;3&gt; Client ID. See previous screenshot.
&lt;4&gt; Client Secret. See previous screenshot.
&lt;5&gt; <code>issuer</code> url. It allows micronaut to discover the configuration of the OpenID Connect server. Note: we will use the pool id and region mentioned previously.
&lt;6&gt; Accept GET request to the <code>/logout</code> endpoint.</p>
</div>
<div class="paragraph">
<p>The previous configuration uses several placeholders. You will need to setup <code>OAUTH_CLIENT_ID</code>, <code>OAUTH_CLIENT_SECRET</code>, <code>COGNITO_REGION</code> and <code>COGNITO_POOL_ID</code> environment variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export OAUTH_CLIENT_ID=XXXXXXXXXX
export OAUTH_CLIENT_SECRET=YYYYYYYYYY
export COGNITO_REGION=eu-west-1
export COGNITO_POOL_ID=eu-west-XXCCCAZZZ</pre>
</div>
</div>
<div class="paragraph">
<p>Although undocumented in the <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-userpools-server-contract-reference.html">Amazon Cognito User Pools Auth API Reference</a>, Cognito provides an <a href="https://openid.net/specs/openid-connect-discovery-1_0.html">openid-configuration endpoint</a> which is used by Micronaut to configure your app.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">https://cognito-idp.{region}.amazonaws.com/{userPoolId}/.well-known/openid-configuration</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to use an <strong>Authorization Code</strong> grant type flow which it is described in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/diagramm.png" alt="diagramm">
</div>
</div>


<h2 id="home">2.3 Home</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-oauth2-cognito/edit/master/src/main/docs/guide/writingTheApp/home.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a controller to handle the requests to <code>/</code>. You are going to display the email of the authenticated person if any. Annotate the controller endpoint with <code>@View</code> since we are going to use a Thymeleaf template.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/HomeController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java" data-lang="java">package example.micronaut;

import io.micronaut.http.annotation.Controller;
import io.micronaut.http.annotation.Get;
import io.micronaut.security.annotation.Secured;
import io.micronaut.security.rules.SecurityRule;
import io.micronaut.views.View;

import java.util.HashMap;
import java.util.Map;

@Controller <i class="conum" data-value="1"></i><b>(1)</b>
public class HomeController {

    @Secured(SecurityRule.IS_ANONYMOUS) <i class="conum" data-value="2"></i><b>(2)</b>
    @View("home") <i class="conum" data-value="3"></i><b>(3)</b>
    @Get <i class="conum" data-value="4"></i><b>(4)</b>
    public Map&lt;String, Object&gt; index() {
        return new HashMap&lt;&gt;();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="http://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>SecurityRule.IS_ANONYMOUS</code> expression will allow access without authentication.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <a href="https://docs.micronaut.io/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template would you like to render the response against.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="http://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation is used to map the <code>index</code> method to GET <code>/</code> requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a thymeleaf template:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/home.html</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-html" data-lang="html">&lt;!DOCTYPE html&gt;
&lt;html xmlns:th="http://www.thymeleaf.org"&gt;
&lt;head&gt;
    &lt;title&gt;Home&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Micronaut - Cognito example&lt;/h1&gt;

&lt;h2 th:if="${security}"&gt;username: &lt;span th:text="${security.attributes.get('email')}"&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;h2 th:unless="${security}"&gt;username: Anonymous&lt;/h2&gt;

&lt;nav&gt;
    &lt;ul&gt;
        &lt;li th:unless="${security}"&gt;&lt;a href="/oauth/login/cognito"&gt;Enter&lt;/a&gt;&lt;/li&gt;
        &lt;li th:if="${security}"&gt;&lt;a href="/oauth/logout"&gt;Logout&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/nav&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also, note that we return an empty model in the controller. However, we are accessing <code>security</code> in the thymeleaf template.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/views/model/security/SecurityViewModelProcessor.html">SecurityViewModelProcessor</a>
injects into the model a <code>security</code> map with the authenticated user.  See
<a href="https://micronaut-projects.github.io/micronaut-views/latest/guide/index.html#views-security">User in a view</a> documentation.</p>
</li>
</ul>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/runningTheApp.html"><strong>3</strong><span>Running the Application</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
