<!DOCTYPE html>
<html>
<head>
    <meta name='google-site-verification' content='REYQ1_I6HGowAE7LOLVqfQbnKaB4IfFpMlGzMbJj55Q' />
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <link rel='icon' href='../img/micronaut-favicon.ico' />
    <meta charset='UTF-8' />
    <title>Micronaut Functions deployed in AWS Lambda | Micronaut Guides | Micronaut Framework</title>
    <meta name='description' content='Micronaut Functions deployed in AWS Lambda. Learn how to write a function with Micronaut and deploy it to AWS Lambda.' />
    <link rel="stylesheet" href="../css/highlight/agate.css">
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel='stylesheet' href='../css/main.css' />
    <link rel='stylesheet' href='../css/screen.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js'></script>
</head>
<body class='guide'>
<div id="navigation">
    <div class="navTitle">
        <span id="logo"><a href="http://micronaut.io" title="Go to Micronaut Website"><img src="../img/micronaut-logo-white.svg" alt="Micronaut"/></a></span>
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <a href="http://guides.micronaut.io">Micronaut Guides</a>
                <span> &rarr; </span>
                <a href="http://guides.micronaut.io/micronaut-function-aws-lambda-groovy/guide/index.html">Micronaut Functions deployed in AWS Lambda</a>
            </li>
        </ul>

    </div>
</div>

<div class='fullwidth'><article class="guide">
    <aside>
        <a href="https://travis-ci.org/micronaut-guides/micronaut-function-aws-lambda-groovy"><img src="https://travis-ci.org/micronaut-guides/micronaut-function-aws-lambda-groovy.svg?branch=master"></a>

        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy&quot;"><img height="15" src="../img/github_white.svg" alt="Github"/><span>&nbsp;Get the Code</span></button>


        <ul class="githublinks">
            <li><button type="button" class="btn btn-default" href="#" onclick="document.getElementById('github-url').value='git@github.com:micronaut-guides/micronaut-function-aws-lambda-groovy.git'" class="codeButton">SSH</button></li>
            <li><button type="button" class="btn btn-default" onclick="document.getElementById('github-url').value='https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy.git'" class="codeButton">HTTPS</button></li>
        </ul>
        <div class="input-group">
            <!-- Target -->
            <input id="github-url" value="git@github.com:micronaut-guides/micronaut-function-aws-lambda-groovy.git" type="text" />
            <!-- Trigger -->
            <button type="button" class="clippy btn btn-default" type="button" data-clipboard-target="#github-url">
                <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
            </button>
        </div>
        <script>var clipboard = new Clipboard('.clippy');</script>
        <button type="button" class="btn btn-large" onclick="window.location.href=&quot;https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/archive/master.zip&quot;">Download ZIP</button>
        
        <div id="table-of-content">
            <h3>Table of Contents</h3>
            
            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>1</strong><span>Getting Started</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#requirements"><strong>1.1</strong><span>What you will need</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#solution"><strong>1.2</strong><span>Solution</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheLambda"><strong>2</strong><span>Writing the Function</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#functionpojos"><strong>2.1</strong><span>POJOs</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#soap"><strong>2.2</strong><span>SOAP VAT Validation</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#function"><strong>2.3</strong><span>Function</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#functiontests"><strong>2.4</strong><span>Function Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#sam"><strong>3</strong><span>Test with SAM CLI</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#awslambda"><strong>4</strong><span>Deploy to AWS Lambda</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#writingTheApp"><strong>5</strong><span>Writing the App</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#pojos"><strong>5.1</strong><span>POJOs</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#functionclient"><strong>5.2</strong><span>Call the Function</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#controller"><strong>5.3</strong><span>Controller</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#tests"><strong>5.4</strong><span>Tests</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#runningTheApp"><strong>6</strong><span>Running the app</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#awsApiGateway"><strong>7</strong><span>AWS API Gateway</span></a></div>
            
            <div class="toc-item" style="margin-left:10px"><a href="#awsApiGatewayUrlInMicronaut"><strong>7.1</strong><span>Consume API Gateway URL</span></a></div>
            
            <div class="toc-item" style="margin-left:0px"><a href="#nextSteps"><strong>8</strong><span>Next Steps</span></a></div>
            
            <div style="clear:both" ></div>
        </div>
        
    </aside>
    <header>
        <h1>Micronaut Functions deployed in AWS Lambda</h1>
        <p>Learn how to write a function with Micronaut and deploy it to AWS Lambda.</p>
        <p><strong>Authors:</strong> Sergio del Amo</p>
        <p><strong>Micronaut Version:</strong> 1.0.0.M4</p>
    </header>
    

<h1 id="gettingStarted">1 Getting Started</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/gettingStarted.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Lets describe the microservices you are going to build through the tutorial.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>vies-vat-validator</code> - A Function which you will build with Micronaut and deploy to <a href="https://aws.amazon.com/lambda/">AWS Lambda</a>.</p>
</li>
<li>
<p><code>invoice</code> - A microservice which  exposes an endpoint to check the Value Added Tax (VAT) which should apply to an invoice. It consumes the <code>vies-vat-validator</code> function to ensure the VAT number is valid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next diagram illustrates the flow:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/microservices-and-lambda.svg" alt="microservices and lambda">
</div>
</div>


<h2 id="requirements">1.1 What you will need</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/requirements.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will need also an <a href="https://aws.amazon.com/account/">AWS Account</a>.</p>
</div>


<h2 id="solution">1.2 Solution</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/solution.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We recommend you to follow the instructions in the next sections and create the app step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/archive/master.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clone the <a href="https://git-scm.com/">Git</a> repository: <code>git clone <a href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy.git" class="bare">https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy.git</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, <code>cd</code> into the <code>complete</code> folder which you will find in the root project of the downloaded/cloned project.</p>
</div>


<h1 id="writingTheLambda">2 Writing the Function</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheLambda.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create the function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mn create-function example.micronaut.vies-vat-validator --lang groovy</code></pre>
</div>
</div>


<h2 id="functionpojos">2.1 POJOs</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheLambda/functionpojos.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a POJO to encapsulate the validation request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "memberStateCode": "es",
  "vatNumber": "B86412491"
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/groovy/example/micronaut/VatValidationRequest.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic

@CompileStatic
class VatValidationRequest implements Serializable {
    String memberStateCode
    String vatNumber
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And another POJO to encapsulate the expected response. Note: we add a <code>Boolean valid</code> property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "memberStateCode": "es",
  "vatNumber": "B86412491"
  "valid": true
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/groovy/example/micronaut/VatValidation.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic

@CompileStatic
class VatValidation extends VatValidationRequest implements Serializable {
    Boolean valid
}</code></pre>
</div>
</div>


<h2 id="soap">2.2 SOAP VAT Validation</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheLambda/soap.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>VIES (<a href="http://ec.europa.eu/taxation_customs/vies/faq.html">VAT Information Exchange System</a>) is an electronic mean of validating VAT-identification numbers of economic operators registered in the European Union for cross border transactions on goods or services.</p>
</div>
<div class="paragraph">
<p>For example, if you create an e-commerce Web application in the European union you would need to check the validity of the purchaser&#8217;s
VAT Number in order to create a proper invoice.</p>
</div>
<div class="paragraph">
<p>To automate the validation checks, the EU does not offer a REST endpoint but a SOAP service. Its WSDL file can be obtained <a href="http://ec.europa.eu/taxation_customs/vies/checkVatService.wsdl">here</a>.</p>
</div>
<div class="paragraph">
<p><strong>SOAP</strong> (originally Simple Object Access Protocol) is a protocol specification for exchanging structured information in the implementation of web services in computer networks. Its purpose is to induce extensibility, neutrality and independence</p>
</div>
<div class="paragraph">
<p>Create <code>VatService</code> to do a SOAP request to validate the VAT Number.</p>
</div>
<div class="paragraph">
<p>To consume the SOAP service we could have use a SOAP library. However, the use case is so simple we are going to use the Micronaut HTTP Client and build
the SOAP envelope manually.</p>
</div>
<div class="paragraph">
<p>Add <code>http-client</code> dependency to <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">compile "io.micronaut:http-client"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>VatService</code> which consumes the SOAP Service:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/groovy/example/micronaut/VatService.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic
import io.micronaut.http.HttpRequest
import io.micronaut.http.client.Client
import io.micronaut.http.client.RxHttpClient
import io.reactivex.Flowable
import io.reactivex.Single

import javax.inject.Singleton

@CompileStatic
@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class VatService {
    private static final String SERVER = "http://ec.europa.eu"
    private static final String PATH = "/taxation_customs/vies/services/checkVatService"
    private static final String VALID_XML_OPEN_TAG = "&lt;valid&gt;"
    private static final String VALID_XML_CLOSE_TAG = "&lt;/valid&gt;"

    protected final RxHttpClient client

    VatService(@Client("http://ec.europa.eu") RxHttpClient client) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.client = client
    }

    Single&lt;Boolean&gt; validateVat(String memberStateCode, String vatNumber) {
        String soapEnvelope = soapEnvelope(memberStateCode, vatNumber)
        HttpRequest request = HttpRequest.POST("${SERVER}${PATH}".toString(), soapEnvelope)  <i class="conum" data-value="3"></i><b>(3)</b>
                .contentType("application/soap+xml")

        Flowable&lt;String&gt; response = client.retrieve(request, String.class)
        response.firstOrError().map(this.&amp;parseResponseToBoolean) as Single&lt;Boolean&gt;
    }

    private Boolean parseResponseToBoolean(String response) {
        if (!response.contains(VALID_XML_OPEN_TAG) || !response.contains(VALID_XML_CLOSE_TAG)) {
            return false
        }
        int beginIndex = response.indexOf(VALID_XML_OPEN_TAG) + VALID_XML_OPEN_TAG.length()
        String validResponse = response.substring(beginIndex, response.indexOf(VALID_XML_CLOSE_TAG))
        Boolean.valueOf(validResponse)
    }

    private String soapEnvelope(String memberStateCode, String vatNumber) {
        """\
&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;
&lt;soapenv:Envelope xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;
&lt;soapenv:Header/&gt;
&lt;soapenv:Body xmlns:soapenv=\"http://schemas.xmlsoap.org/soap/envelope/\"&gt;
&lt;urn:checkVat xmlns:urn=\"urn:ec.europa.eu:taxud:vies:services:checkVat:types\"&gt;
&lt;urn:countryCode&gt;${memberStateCode}&lt;/urn:countryCode&gt;
&lt;urn:vatNumber&gt;${vatNumber}&lt;/urn:vatNumber&gt;
&lt;/urn:checkVat&gt;
&lt;/soapenv:Body&gt;
&lt;/soapenv:Envelope&gt;"""
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>javax.inject.Singleton</code> to designate a class a a singleton</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Constructor Injection of Micronaut RxClient</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define a POST Request.</td>
</tr>
</table>
</div>


<h2 id="function">2.3 Function</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheLambda/function.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Edit <code>ViesVatValidatorFunction</code></p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/groovy/example/micronaut/ViesVatValidatorFunction.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.Field
import javax.inject.Inject

@Field @Inject VatService vatService <i class="conum" data-value="1"></i><b>(1)</b>

VatValidation viesVatValidator(VatValidationRequest request) {  <i class="conum" data-value="2"></i><b>(2)</b>
    final String memberStateCode = request.getMemberStateCode()
    final String vatNumber = request.getVatNumber()
    vatService.validateVat(memberStateCode, vatNumber)
            .map { Boolean valid -&gt; new VatValidation(memberStateCode: memberStateCode, vatNumber: vatNumber, valid: valid) }
            .blockingGet() <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In order to make use of dependency injection in your Groovy function, use the <code>groovy.transform.Field</code> annotation transform in addition to the <code>@Inject</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We define a method with a POJO as input or output. That it is the easiest way to have a parameter with an incoming JSON Payload
and JSON Payload response.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We cannot return a non-blocking type due to AWS Lambda <a href="https://docs.aws.amazon.com/lambda/latest/dg/java-programming-model-req-resp.html">Handler Input/Output supported Types</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Modify <code>logback.xml</code> to set <code>DEBUG</code> level for package <code>example.micronaut</code>.</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/main/resources/logback.xml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;configuration&gt;

    &lt;appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender"&gt;
        &lt;!-- encoders are assigned the type
             ch.qos.logback.classic.encoder.PatternLayoutEncoder by default --&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n&lt;/pattern&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level="info"&gt;
        &lt;appender-ref ref="STDOUT" /&gt;
    &lt;/root&gt;
    &lt;logger name="example.micronaut" level="DEBUG"/&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>


<h2 id="functiontests">2.4 Function Tests</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheLambda/functiontests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><code>build.gradle</code> already contains these dependencies:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">testRuntime "io.micronaut:http-server-netty"
testRuntime "io.micronaut:function-web"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because of that, testing your functions is really easy.</p>
</div>
<div class="paragraph">
<p>First modify <code>ViesVatValidatorClient</code> interface to match to the method signature forced by <code>Function&lt;VatValidationRequest, VatValidation&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/test/groovy/example/micronaut/ViesVatValidatorClient.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.function.client.FunctionClient
import io.micronaut.http.annotation.Body
import io.reactivex.Single

import javax.inject.Named

@FunctionClient <i class="conum" data-value="1"></i><b>(1)</b>
interface ViesVatValidatorClient {

    @Named("vies-vat-validator") <i class="conum" data-value="2"></i><b>(2)</b>
    Single&lt;VatValidation&gt; apply(@Body VatValidationRequest request) <i class="conum" data-value="3"></i><b>(3)</b>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>FunctionClient</code> annotation allows applying introduction advise to an interface such that methods defined by the interface become invokers of remote functions configured by the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For a method name <code>viesVatValidator</code> method the function URI is <code>vies-vat-validator</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Functions that only return a value are mapped to HTTP GET requests, whilst functions that accept an input require an HTTP POST. Thus, use <code>@Body</code> to supply the POJO.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you can start up the Micronaut application and access your function via the client interface in your test.</p>
</div>
<div class="paragraph">
<p>Modify <code>ViesVatValidatorFunctionSpec.groovy</code>:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/src/test/groovy/example/micronaut/ViesVatValidatorFunctionSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.runtime.server.EmbeddedServer
import spock.lang.Specification
import spock.lang.Unroll

class ViesVatValidatorFunctionSpec extends Specification {

    @Unroll("#code #vatNumber is #description")
    void testViesVatValidatorFunction(String code, String vatNumber, boolean expected, String description) throws Exception {
        given:
        EmbeddedServer server = ApplicationContext.run(EmbeddedServer.class)

        when:
        ViesVatValidatorClient client = server.getApplicationContext().getBean(ViesVatValidatorClient.class)

        then:
        noExceptionThrown()

        when:
        VatValidationRequest req = new VatValidationRequest(memberStateCode: code, vatNumber: vatNumber)

        then:
        expected == client.apply(req).blockingGet().valid

        cleanup:
        server.stop()
        server.close()

        where:
        code | vatNumber   | expected
        "es" | "B99286353" | true
        "es" | "B19280031" | true
        "es" | "XXXXXXXXX" | false

        description = expected ? 'is valid' : 'is invalid'

    }
}</code></pre>
</div>
</div>


<h1 id="sam">3 Test with SAM CLI</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/sam.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p><a href="https://github.com/awslabs/aws-sam-cli">AWS SAM CLI</a> is a CLI tool for local development and testing of Serverless applications.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can skip this section. If you want to complete this section you will need SAM and Docker installed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To test your Micronuat function with SAM you will first need to <a href="https://github.com/awslabs/aws-sam-cli/blob/develop/docs/installation.rst">install SAM</a>.</p>
</div>
<div class="paragraph">
<p>Then create a file <code>event.json</code>. We will use it as the stimulus for the SAM cli invocation.</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/event.json</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "memberStateCode": "es",
  "vatNumber": "B86412491"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next create a <a href="https://github.com/awslabs/serverless-application-model">AWS SAM template</a> file:</p>
</div>
<div class="listingblock">
<div class="title">vies-vat-validator/template.yaml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
    Function:
        Timeout: 25

Resources:

    ViesVatValidatorFunction:
        Type: AWS::Serverless::Function # More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
        Properties:
            CodeUri: build/libs/complete/vies-vat-validator-0.1-all.jar
            Handler: example.micronaut.ViesVatValidatorFunction::viesVatValidator
            Runtime: java8</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that in place, you can invoke your function locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">o$ sam local invoke "ViesVatValidatorFunction" -e event.json
2018-09-25 09:45:40 Invoking example.micronaut.ViesVatValidatorFunction::viesVatValidator (java8)
2018-09-25 09:45:40 Found credentials in shared credentials file: ~/.aws/credentials
2018-09-25 09:45:40 Decompressing /Users/sdelamo/Developer/micronaut-guides/micronaut-function-aws-lambda-groovy/complete/vies-vat-validator/build/libs/complete/vies-vat-validator-0.1-all.jar

Fetching lambci/lambda:java8 Docker container image........................
2018-09-25 09:45:47 Mounting /private/var/folders/pb/dx1ms2_92_g54v9jvzv7k4hc0000gn/T/tmp1JpBgZ as /var/task:ro inside runtime container
START RequestId: 02f9123b-d64e-4257-ab90-334cec2f9cb7 Version: $LATEST
END RequestId: 02f9123b-d64e-4257-ab90-334cec2f9cb7
REPORT RequestId: 02f9123b-d64e-4257-ab90-334cec2f9cb7	Duration: 1305.64 ms	Billed Duration: 1400 ms	Memory Size: 128 MB	Max Memory Used: 37 MB

{"memberStateCode":"es","vatNumber":"B86412491","valid":true}</code></pre>
</div>
</div>


<h1 id="awslambda">4 Deploy to AWS Lambda</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/awslambda.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Deploy your Micronaut function to <a href="https://aws.amazon.com/lambda/">AWS Lambda</a>.</p>
</div>
<div class="paragraph">
<p>First, create a Function. I select Paris as the region.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step1.png" alt="step1">
</div>
</div>
<div class="paragraph">
<p>Select Java 8 runtime. Name: <code>vies-vat-validator</code> and <code>create a new role form template(s)</code>. I give the role name
<code>lambda_basic_execution</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step2.png" alt="step2">
</div>
</div>
<div class="paragraph">
<p>Configure tests events:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step3.png" alt="step3">
</div>
</div>
<div class="paragraph">
<p>Create a payload with valid data:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step4.png" alt="step4">
</div>
</div>
<div class="paragraph">
<p>Generate a jar file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>`vies-vat-validator $ ./gradlew shadowJar`</pre>
</div>
</div>
<div class="paragraph">
<p>The file is just 12MB ;-)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ du -h build/libs/complete/vies-vat-validator-0.1-all.jar
 12M    build/libs/complete/vies-vat-validator-0.1-all.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Upload the JAR as illustrated here:</p>
</div>
<div class="paragraph">
<p>Enter as <code>Handler</code> value <code>example.micronaut.ViesVatValidatorFunction::viesVatValidator</code>.</p>
</div>
<div class="paragraph">
<p>I have allocated just 256Mb and a timeout of 25s.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/step5.png" alt="step5">
</div>
</div>


<h1 id="writingTheApp">5 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Now, it is time to consume the AWS Lambda function from another micronaut Microservice:</p>
</div>
<div class="paragraph">
<p>Create the microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mn create-app example.micronaut.invoice --lang groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous command creates an application with a default package of <code>example.micronaut</code> in a folder <code>invoice`</code></p>
</div>


<h2 id="pojos">5.1 POJOs</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheApp/pojos.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We expect to get an incoming JSON payload such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
"vatNumber": "B86412491",
"countryCode": "es",
"lines": [
    {
        "count": 2,
        "productId": "1491950358",
        "price": 19.99
    },
    {
        "count": 1,
        "productId": "1680502395",
        "price": 15
    },
]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We create two POJOs to map it.</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/Invoice.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic
import groovy.transform.EqualsAndHashCode

import javax.validation.constraints.NotBlank
import javax.validation.constraints.NotEmpty
import javax.validation.constraints.NotNull

@EqualsAndHashCode
@CompileStatic
class Invoice {

    @NotNull
    @NotBlank
    String vatNumber

    @NotNull
    @NotBlank
    String countryCode

    @NotEmpty
    List&lt;InvoiceLine&gt; lines
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/InvoiceLine.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.EqualsAndHashCode

import javax.validation.constraints.NotBlank
import javax.validation.constraints.NotNull
import javax.validation.constraints.Positive

@EqualsAndHashCode
class InvoiceLine {
    @NotNull
    @NotBlank
    String productId

    @Positive
    Integer count

    @NotNull
    @Positive
    BigDecimal price

    BigDecimal vatPrice(BigDecimal vatPercentage) {
        getPrice().multiply(BigDecimal.valueOf(getCount()).multiply(vatPercentage))
    }
}</code></pre>
</div>
</div>


<h2 id="functionclient">5.2 Call the Function</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheApp/functionclient.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create an interface to abstract the collaboration with the function:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/VatValidator.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.http.annotation.Body
import io.reactivex.Single

interface VatValidator {

    Single&lt;VatValidation&gt; validateVat(@Body VatValidationRequest req) <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Functions that only return a value are mapped to HTTP GET requests, whilst functions that accept an input require an HTTP POST. Thus, use <code>@Body</code> to supply the POJO.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create two POJOs which are used by the previous interface:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/VatValidationRequest.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic

@CompileStatic
class VatValidationRequest implements Serializable {
    String memberStateCode
    String vatNumber
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/VatValidation.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic

@CompileStatic
class VatValidation extends VatValidationRequest implements Serializable {
    Boolean valid
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>build.gradle</code> to add <code>function-client</code> and <code>com.amazonaws:aws-java-sdk-lambda</code> dependencies:</p>
</div>
<div class="listingblock">
<div class="title">invoice/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">compile "io.micronaut:function-client"
runtime 'com.amazonaws:aws-java-sdk-lambda:1.11.414'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also modify <code>src/main/resources/application.yml</code> and the define a function with the same name <code>vies-vat-validator</code> as the one we deployed to AWS Lambda:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">aws:
    lambda:
        functions:
            vat:
                functionName: vies-vat-validator
                qualifer: vat
        region: eu-west-3 # Paris Region</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the next configuration properties which we will use shortly:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">vat:
    percentage: 0.21
    scale: 2
    retry:
        attempts: 5
        delay: 5s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>VatClient</code> to invoke our function:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/VatClient.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.annotation.Requires
import io.micronaut.context.env.Environment
import io.micronaut.function.client.FunctionClient
import io.micronaut.http.annotation.Body
import io.micronaut.retry.annotation.Retryable
import io.reactivex.Single

import javax.inject.Named

@FunctionClient <i class="conum" data-value="1"></i><b>(1)</b>
@Requires(notEnv = Environment.TEST) <i class="conum" data-value="2"></i><b>(2)</b>
interface VatClient extends VatValidator {

    @Override
    @Named("vies-vat-validator") <i class="conum" data-value="3"></i><b>(3)</b>
    @Retryable(attempts = '${vat.retry.attempts:3}', delay = '${vat.retry.delay:1s}') <i class="conum" data-value="4"></i><b>(4)</b>
    Single&lt;VatValidation&gt; validateVat(@Body VatValidationRequest req) <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The FunctionClient annotation allows applying introduction advise to an interface such that methods defined by the interface become invokers of remote functions configured by the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can remove a bean from the test classpath easily.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the function name <code>vies-vat-validator</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>AWS Lambda functions may take time to warm up. Thus, failure is something you have to plan for and it is pretty common to want to attempt to retry an operation if it fails.
With <a href="https://docs.micronaut.io/snapshot/guide/index.html#retry">Micronaut Retry</a> you can try again easily.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Functions that only return a value are mapped to HTTP GET requests, whilst functions that accept an input require an HTTP POST. Thus, use <code>@Body</code> to supply the POJO.</td>
</tr>
</table>
</div>


<h2 id="controller">5.3 Controller</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheApp/controller.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Micronaut’s validation is built on with the standard framework – JSR 380, also known as Bean Validation 2.0.</p>
</div>
<div class="paragraph">
<p>Hibernate Validator is a reference implementation of the validation API.</p>
</div>
<div class="paragraph">
<p>Add the next snippet to <code>build.gradle</code></p>
</div>
<div class="listingblock">
<div class="title">invoice/build.gradle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">compile "io.micronaut.configuration:hibernate-validator"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/InvoiceController.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic
import io.micronaut.context.annotation.Value
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Post
import io.micronaut.validation.Validated
import io.reactivex.Single

import javax.validation.Valid

@CompileStatic
@Validated <i class="conum" data-value="1"></i><b>(1)</b>
@Controller("/invoice") <i class="conum" data-value="2"></i><b>(2)</b>
class InvoiceController {

    private final BigDecimal vatPercentage

    private final VatValidator vatValidator

    private final int scale

    InvoiceController(@Value('${vat.percentage}') BigDecimal vatPercentage, <i class="conum" data-value="3"></i><b>(3)</b>
                      @Value('${vat.scale}') int scale,
                      VatValidator vatValidator) { <i class="conum" data-value="4"></i><b>(4)</b>
        this.vatPercentage = vatPercentage
        this.scale = scale
        this.vatValidator = vatValidator
    }

    @Post("/vat") <i class="conum" data-value="5"></i><b>(5)</b>
    Single&lt;Taxes&gt; calculateVat(@Valid @Body Invoice invoice) {  <i class="conum" data-value="6"></i><b>(6)</b>
        vatValidator.validateVat(new VatValidationRequest(memberStateCode: invoice.countryCode, vatNumber: invoice.vatNumber)) <i class="conum" data-value="7"></i><b>(7)</b>
                .map { VatValidation vatValidation -&gt;
                    BigDecimal percentage = vatValidation.valid ? vatPercentage : new BigDecimal("0")
                    new Taxes(vat: invoice.lines.stream()
                            .map { InvoiceLine line -&gt; line.vatPrice(percentage) }
                            .reduce { BigDecimal a, BigDecimal b -&gt; a.add(b) }
                            .get()
                            .setScale(scale, BigDecimal.ROUND_HALF_EVEN))
                }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add <code>@Validated</code> annotation at the class level to any class that requires validation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <code>@Controller</code> annotation mapped to the path <code>/invoice</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Constructor injection of a configuration property.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Constructor injection of a bean.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>@Post</code> annotation is used to map the <code>calculateVat</code> method to all requests to <code>/invoice/vat</code> that use an HTTP POST.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Add <code>@Valid</code> to any method parameter which requires validation. Use a POGO supplied as a JSON payload in the request to populate the invoice.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>This invokes the function in AWS Lambda.</td>
</tr>
</table>
</div>


<h2 id="tests">5.4 Tests</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/writingTheApp/tests.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>We don&#8217;t want the real AWS Lambda function executed in our tests.</p>
</div>
<div class="paragraph">
<p>Thus, create a bean to provide an implementation of <code>VatValidator</code> in the test phase:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/test/groovy/example/micronaut/VatValidatorMock.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import groovy.transform.CompileStatic
import io.micronaut.context.annotation.Requires
import io.micronaut.context.env.Environment
import io.reactivex.Single
import javax.inject.Singleton

@CompileStatic
@Requires(env = Environment.TEST)
@Singleton
class VatValidatorMock implements VatValidator {

    @Override
    Single&lt;VatValidation&gt; validateVat(VatValidationRequest request) {
        List&lt;String&gt; validVatNumbers = Collections.singletonList("B84965375")
        Single.just(new VatValidation(memberStateCode: request.memberStateCode,
                vatNumber: request.vatNumber,
                valid: validVatNumbers.contains(request.vatNumber)))
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a JUnit test which verifies the logic:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/test/groovy/example/micronaut/InvoiceControllerSpec.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.ApplicationContext
import io.micronaut.http.HttpRequest
import io.micronaut.http.client.RxHttpClient
import io.micronaut.runtime.server.EmbeddedServer
import spock.lang.AutoCleanup
import spock.lang.Shared
import spock.lang.Specification

class InvoiceControllerSpec extends Specification {

    @Shared
    @AutoCleanup
    EmbeddedServer embeddedServer = ApplicationContext.run(EmbeddedServer) <i class="conum" data-value="1"></i><b>(1)</b>

    @Shared
    @AutoCleanup
    RxHttpClient rxHttpClient = embeddedServer.applicationContext.createBean(RxHttpClient, embeddedServer.getURL()) <i class="conum" data-value="2"></i><b>(2)</b>

    void "test BooksController"() {

        when:
        VatValidator bean = embeddedServer.getApplicationContext().getBean(VatValidator.class)

        then:
        noExceptionThrown()
        bean instanceof VatValidatorMock <i class="conum" data-value="3"></i><b>(3)</b>

        when:
        Invoice invoice = new Invoice(vatNumber: "B84965375", countryCode: "es", lines: [
                new InvoiceLine(productId: "1491950358", count: 2, price: new BigDecimal(19.99)),
                new InvoiceLine(productId: "1680502395", count: 1, price: new BigDecimal(15)),
        ])
        HttpRequest request = HttpRequest.POST("/invoice/vat", invoice)
        Taxes rsp = rxHttpClient.toBlocking().retrieve(request, Taxes.class)
        BigDecimal expected = new BigDecimal("11.55")

        then:
        expected == rsp.vat

        when:
        invoice.setVatNumber("B99999999")
        rsp = rxHttpClient.toBlocking().retrieve(request, Taxes.class)
        expected = new BigDecimal("0.00")

        then:
        expected == rsp.vat
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To run the application from a unit test you can use the <a href="http://docs.micronaut.io/snapshot/api/io/micronaut/runtime/server/EmbeddedServer.html">EmbeddedServer</a> interface.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register a <code>RxHttpClient</code> bean in the application context and point it to the embedded server URL. The <code>EmbeddedServer</code> interface provides the URL of the server under test which runs on a random port.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Verify the bean for interface <code>VatValidator</code> is <code>VatValidatorMock</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you are curious about how the 11.55 is calculated.
Given a 21% VAT.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Price</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line VAT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19,99</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8,3958</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3,15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total VAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11,55</p></td>
</tr>
</tbody>
</table>


<h1 id="runningTheApp">6 Running the app</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/runningTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The easiest way to configure credentials for invoking the function is to define a ~/.aws/credentials` file`.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">[default]
aws_access_key_id=XXXXXXXXXXX
aws_secret_access_key=XXXXX</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run the application use the <code>./gradlew run</code> command which will start the application on a random port.</p>
</div>
<div class="paragraph">
<p>execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">curl -X "POST" "http://localhost:8080/invoice/vat" \
     -H 'Content-Type: application/json' \
     -d $'{
  "countryCode": "es",
  "vatNumber": "B86412491",
  "lines": [
    {
      "count": 2,
      "price": 19.99,
      "productId": "1491950358"
    },
    {
      "count": 1,
      "price": 15,
      "productId": "1680502395"
    }
  ]
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you will get:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">{"vat":11.55}</code></pre>
</div>
</div>


<h1 id="awsApiGateway">7 AWS API Gateway</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/awsApiGateway.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><a href="https://aws.amazon.com/api-gateway/">Amazon API Gateway</a> is a fully managed service that makes it easy for developers to create, publish,
maintain, monitor, and secure APIs at any scale.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>A common use case of AWS API Gateway is to create HTTP endpoints which expose functions deploy to AWS Lambda.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create an endpoint which exposes the Micronaut function we deployed to AWS Lambda.</p>
</div>
<div class="paragraph">
<p>Create a new AWS Gateway API</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway1.png" alt="awsapigateway1">
</div>
</div>
<div class="paragraph">
<p>Create a POST method, with integration type <code>Lambda Function</code> and enter the Lambda function name you used.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway2.png" alt="awsapigateway2">
</div>
</div>
<div class="paragraph">
<p>Create a Model for the incoming request to the method.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway3.png" alt="awsapigateway3">
</div>
</div>
<div class="paragraph">
<p>Edit the POST Method request and configure the Model as the content type.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway4.png" alt="awsapigateway4">
</div>
</div>
<div class="paragraph">
<p>You will be able to test the API method and its integration with the AWS Lambda function.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway5.png" alt="awsapigateway5">
</div>
</div>
<div class="paragraph">
<p>Deploy the API to create an endpoint which we can invoke with an HTTP request:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway6.png" alt="awsapigateway6">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway7.png" alt="awsapigateway7">
</div>
</div>
<div class="paragraph">
<p>You will get an invoke URL to use:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/awsapigateway8.png" alt="awsapigateway8">
</div>
</div>


<h2 id="awsApiGatewayUrlInMicronaut">7.1 Consume API Gateway URL</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/awsApiGateway/awsApiGatewayUrlInMicronaut.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Although we are not using a discovery server like Consul or Eureka, you can <a href="https://docs.micronaut.io/latest/guide/index.html#_client_specific_configuration">manually configure service discovery</a> in application.yml:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/resources/application.yml</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">micronaut:
    http:
        services:
            viesvatvalidator: <i class="conum" data-value="1"></i><b>(1)</b>
                urls:
                    - "https://8ah5p89xof.execute-api.eu-west-3.amazonaws.com"
                stage: "beta"
    application:
        name: invoice
    server:
        port: 8080</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure service name, we will use name in <code>@Client</code> annotation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a <a href="https://docs.micronaut.io/snapshot/guide/index.html#clientAnnotation">Micronaut declarative HTTP Client</a> to consume that endpoint:</p>
</div>
<div class="listingblock">
<div class="title">invoice/src/main/groovy/example/micronaut/AwsApiGatewayVatClient.groovy</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-groovy" data-lang="groovy">package example.micronaut

import io.micronaut.context.annotation.Primary
import io.micronaut.context.annotation.Requires
import io.micronaut.context.env.Environment
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Post
import io.micronaut.http.client.Client
import io.micronaut.retry.annotation.Retryable
import io.reactivex.Single

@Primary <i class="conum" data-value="1"></i><b>(1)</b>
@Client("viesvatvalidator") <i class="conum" data-value="2"></i><b>(2)</b>
@Requires(notEnv = Environment.TEST) <i class="conum" data-value="3"></i><b>(3)</b>
interface AwsApiGatewayVatClient extends VatValidator {

    @Override
    @Retryable(attempts = '${vat.retry.attempts:3}', delay = '${vat.retry.delay:1s}')
    @Post('/${micronaut.http.services.viesvatvalidator.stage}') <i class="conum" data-value="4"></i><b>(4)</b>
    Single&lt;VatValidation&gt; validateVat(@Body VatValidationRequest req)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Given a common interface called <code>VatValidator</code>
that is implemented by multiple classes (<code>AwsApiGatewayVatClient</code>, <code>VatClient</code>) you can boost which bean is injection with <a href="https://docs.micronaut.io/snapshot/guide/index.html#_primary_and_secondary_beans">@Primary</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the service id you defined in <code>micronaut.http.services</code> configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can remove a bean from the test classpath easily.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define this as a POST request and interpolate a configuration property to define the path.</td>
</tr>
</table>
</div>


<h1 id="nextSteps">8 Next Steps</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/micronaut-function-aws-lambda-groovy/edit/master/src/main/docs/guide/nextSteps.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Read more about <a href="https://docs.micronaut.io/snapshot/guide/index.html#serverlessFunctions">Serverless Functions</a> inside Micronaut.</p>
</div>

</article>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-115754405-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-115754405-1');
</script>
</body>
</html>
