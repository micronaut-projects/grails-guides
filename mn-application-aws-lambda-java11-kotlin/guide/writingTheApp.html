<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>2 Writing the App null</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Deploy a Micronaut application to AWS Lambda Java 11 Runtime
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/gettingStarted.html"><strong>1</strong><span>Getting Started</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/writingTheApp.html"><strong>2</strong><span>Writing the App</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/lambda.html"><strong>3</strong><span>Lambda</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/nextSteps.html"><strong>4</strong><span>Next Steps</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../guide/help.html"><strong>5</strong><span>Help with Micronaut</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
            <li class="separator selected">
                <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                

                <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                
                    <div class="toc-item next-right"><a href="../guide/lambda.html"><strong>3</strong><span>Lambda</span> >></a></div>
                


                <div class="project">
                    <h1>2 Writing the App</h1>

                    <p><strong>Version:</strong> null</p>
                </div>

                
                <div id="table-of-content">
                    <h2>Table of Contents</h2>
                    
                    <div class="toc-item" style="margin-left:0px"><a href="#code"><strong>2.1</strong><span>Code</span></a>
                    </div>
                    
                </div>
                

                

<h1 id="writingTheApp">2 Writing the App</h1>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-application-aws-lambda-java11-kotlin/edit/master/src/main/docs/guide/writingTheApp.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Create a micronaut application with the <code>aws-lambda</code> feature using the CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">% mn create-app example.micronaut.complete --lang kotlin --features aws-lambda</code></pre>
</div>
</div>
<div class="paragraph">
<p>or use <a href="https://launch.micronaut.io">Micronaut Launch</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="../img/launch.png" alt="launch">
</div>
</div>


<h2 id="code">2.1 Code</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/micronaut-guides/mn-application-aws-lambda-java11-kotlin/edit/master/src/main/docs/guide/code.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>The generated application contains a <code>BookController</code>. It responds to POST request to <code>/</code>.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/BookController.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Post
import java.util.UUID
import javax.validation.Valid

@Controller <i class="conum" data-value="1"></i><b>(1)</b>
open class BookController {
    @Post <i class="conum" data-value="2"></i><b>(2)</b>
    open fun save(@Valid @Body book: Book): BookSaved {  <i class="conum" data-value="3"></i><b>(3)</b>
        val bookSaved = BookSaved()
        bookSaved.name = book.name
        bookSaved.isbn = UUID.randomUUID().toString()
        return bookSaved
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <code>@Controller</code> annotation mapped to the path /</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@Post</code> annotation is used to map HTTP request to <code>/</code> to the the <code>save</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the <code>@Valid</code> annotation to any method parameter&#8217;s object which requires validation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The controller&#8217;s method parameter is a <code>Book</code> object:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/Book.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut
import io.micronaut.core.annotation.Introspected

@Introspected <i class="conum" data-value="1"></i><b>(1)</b>
class Book {
    var name: String? = null
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@Introspected</code> to generate the Bean Metainformation at compile time.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It returns a <code>BookSaved</code> object:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/BookSaved.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut
import io.micronaut.core.annotation.Introspected
@Introspected <i class="conum" data-value="1"></i><b>(1)</b>
class BookSaved {
    var name: String? = null
    var isbn: String? = null
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@Introspected</code> to generate the Bean Metainformation at compile time.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The generated tests illustrates how the code works when the lambda gets invoked:</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/BookControllerTest.kt</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin" data-lang="kotlin">package example.micronaut;
import com.amazonaws.serverless.proxy.internal.testutils.AwsProxyRequestBuilder
import com.amazonaws.serverless.proxy.internal.testutils.MockLambdaContext
import com.amazonaws.services.lambda.runtime.Context
import com.fasterxml.jackson.databind.ObjectMapper
import io.micronaut.http.HttpHeaders
import io.micronaut.http.HttpMethod
import io.micronaut.http.HttpStatus
import io.micronaut.http.MediaType
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Test
import io.micronaut.function.aws.proxy.MicronautLambdaHandler

class BookRequestHandlerTest {

    @Test
    fun testBookController() {
        val handler = MicronautLambdaHandler() <i class="conum" data-value="1"></i><b>(1)</b>
        val book = Book()
        book.name = "Building Microservices"
        val objectMapper = handler.applicationContext.getBean(ObjectMapper::class.java)
        val json = objectMapper.writeValueAsString(book)
        val request = AwsProxyRequestBuilder("/", HttpMethod.POST.toString())
                .header(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON)
                .body(json)
                .build()
        val lambdaContext: Context = MockLambdaContext()
        val response = handler.handleRequest(request, lambdaContext) <i class="conum" data-value="3"></i><b>(3)</b>
        Assertions.assertEquals(response.statusCode, HttpStatus.OK.code)
        val bookSaved: BookSaved = objectMapper.readValue(response.body, BookSaved::class.java)
        Assertions.assertNotNull(bookSaved)
        Assertions.assertEquals(bookSaved.name, book.name)
        Assertions.assertNotNull(bookSaved.isbn)
        handler.applicationContext.close() <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When you instantiate the Handler, the application context starts.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remember to close your application context when you end your test. You can use your handler to obtain it.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You don&#8217;t invoke the controller directly. Instead, your handler receives a AWS Proxy Request event which it is routed transparently to your controller.</td>
</tr>
</table>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../guide/gettingStarted.html">&lt;&lt; <strong>1</strong><span>Getting Started</span></a></div>
                
                    <div class="toc-item next-right"><a href="../guide/lambda.html"><strong>3</strong><span>Lambda</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
